"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[3039],{93174:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});var i=t(85893),s=t(11151);const o={id:"quickstart",sidebar_label:"Quickstart tutorial",title:"Quickstart tutorial \u23f1\ufe0f"},a=void 0,r={id:"getting-started/quickstart",title:"Quickstart tutorial \u23f1\ufe0f",description:"In this tutorial, we will build a very simple browser application with Centrifugo. Users will connect to Centrifugo over WebSocket, subscribe to a channel, and start receiving all channel publications (messages published to that channel). In our case, we will send a counter value to all channel subscribers to update the counter widget in all open browser tabs in real-time.",source:"@site/docs/getting-started/quickstart.md",sourceDirName:"getting-started",slug:"/getting-started/quickstart",permalink:"/docs/getting-started/quickstart",draft:!1,unlisted:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/getting-started/quickstart.md",tags:[],version:"current",frontMatter:{id:"quickstart",sidebar_label:"Quickstart tutorial",title:"Quickstart tutorial \u23f1\ufe0f"},sidebar:"Introduction",previous:{title:"Install Centrifugo",permalink:"/docs/getting-started/installation"},next:{title:"Main highlights",permalink:"/docs/getting-started/highlights"}},c={},l=[];function d(e){const n={a:"a",admonition:"admonition",code:"code",img:"img",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"In this tutorial, we will build a very simple browser application with Centrifugo. Users will connect to Centrifugo over WebSocket, subscribe to a channel, and start receiving all channel publications (messages published to that channel). In our case, we will send a counter value to all channel subscribers to update the counter widget in all open browser tabs in real-time."}),"\n",(0,i.jsxs)(n.p,{children:["First, you need to ",(0,i.jsx)(n.a,{href:"/docs/getting-started/installation",children:"install Centrifugo"}),". In this example, we are using a binary file release which is fine for development. Once you have the Centrifugo binary available on your machine, you can generate the minimal required configuration file with the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"./centrifugo genconfig\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This helper command will generate ",(0,i.jsx)(n.code,{children:"config.json"})," file in the working directory with a content like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "token_hmac_secret_key": "bbe7d157-a253-4094-9759-06a8236543f9",\n  "admin_password": "d0683813-0916-4c49-979f-0e08a686b727",\n  "admin_secret": "4e9eafcf-0120-4ddd-b668-8dc40072c78e",\n  "api_key": "d7627bb6-2292-4911-82e1-615c0ed3eebb",\n  "allowed_origins": []\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Now we can start a server. Let's start Centrifugo with a built-in admin web interface:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"./centrifugo --config=config.json --admin\n"})}),"\n",(0,i.jsxs)(n.p,{children:["We could also enable the admin web interface by not using ",(0,i.jsx)(n.code,{children:"--admin"})," flag but by adding ",(0,i.jsx)(n.code,{children:'"admin": true'})," option to the JSON configuration file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "token_hmac_secret_key": "bbe7d157-a253-4094-9759-06a8236543f9",\n  "admin": true,\n  "admin_password": "d0683813-0916-4c49-979f-0e08a686b727",\n  "admin_secret": "4e9eafcf-0120-4ddd-b668-8dc40072c78e",\n  "api_key": "d7627bb6-2292-4911-82e1-615c0ed3eebb",\n  "allowed_origins": []\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"And then running Centrifugo only with a path to a configuration file:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"./centrifugo --config=config.json\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now open ",(0,i.jsx)(n.a,{href:"http://localhost:8000",children:"http://localhost:8000"}),". You should see Centrifugo admin web panel. Enter ",(0,i.jsx)(n.code,{children:"admin_password"})," value from the configuration file to log in (in our case it's ",(0,i.jsx)(n.code,{children:"d0683813-0916-4c49-979f-0e08a686b727"}),", but you will have a different value)."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Admin web panel",src:t(45593).Z+"",width:"2378",height:"1304"})}),"\n",(0,i.jsx)(n.p,{children:"Inside the admin panel, you should see that one Centrifugo node is running, and it does not have connected clients:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Admin web panel",src:t(35724).Z+"",width:"2346",height:"896"})}),"\n",(0,i.jsxs)(n.p,{children:["Now let's create ",(0,i.jsx)(n.code,{children:"index.html"})," file with our simple app:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",metastring:'title="index.html"',children:"<html>\n\n<head>\n  <title>Centrifugo quick start</title>\n</head>\n\n<body>\n  <div id=\"counter\">-</div>\n  <script src=\"https://unpkg.com/centrifuge@5.0.1/dist/centrifuge.js\"><\/script>\n  <script type=\"text/javascript\">\n    const container = document.getElementById('counter');\n\n    const centrifuge = new Centrifuge(\"ws://localhost:8000/connection/websocket\", {\n      token: \"<TOKEN>\"\n    });\n\n    centrifuge.on('connecting', function (ctx) {\n      console.log(`connecting: ${ctx.code}, ${ctx.reason}`);\n    }).on('connected', function (ctx) {\n      console.log(`connected over ${ctx.transport}`);\n    }).on('disconnected', function (ctx) {\n      console.log(`disconnected: ${ctx.code}, ${ctx.reason}`);\n    }).connect();\n\n    const sub = centrifuge.newSubscription(\"channel\");\n\n    sub.on('publication', function (ctx) {\n      container.innerHTML = ctx.data.value;\n      document.title = ctx.data.value;\n    }).on('subscribing', function (ctx) {\n      console.log(`subscribing: ${ctx.code}, ${ctx.reason}`);\n    }).on('subscribed', function (ctx) {\n      console.log('subscribed', ctx);\n    }).on('unsubscribed', function (ctx) {\n      console.log(`unsubscribed: ${ctx.code}, ${ctx.reason}`);\n    }).subscribe();\n  <\/script>\n</body>\n\n</html>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Note that we are using ",(0,i.jsx)(n.code,{children:"centrifuge-js"})," 5.0.1 in this example, getting it from a CDN. You should use its latest version at the moment of reading this tutorial. In a real Javascript app, you would most likely load ",(0,i.jsx)(n.code,{children:"centrifuge"})," from NPM."]}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"index.html"})," above, we created an instance of a Centrifuge client by passing the Centrifugo server's default WebSocket endpoint address to it. Then we subscribed to a channel called ",(0,i.jsx)(n.code,{children:"channel"})," and provided a callback function to process incoming real-time messages (publications). Upon receiving a new publication, we update the page's HTML by setting the counter value to the page title. We call ",(0,i.jsx)(n.code,{children:".subscribe()"})," to initiate the subscription and the ",(0,i.jsx)(n.code,{children:".connect()"})," method of the Client to start a WebSocket connection. We also handle Client state transitions (disconnected, connecting, connected) and Subscription state transitions (unsubscribed, subscribing, subscribed) \u2013 see a detailed description in ",(0,i.jsx)(n.a,{href:"/docs/transports/client_api",children:"client SDK spec"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Now you need to serve this file with an HTTP server. In a real-world Javascript application, you would serve your HTML files with a web server of your choice \u2013 but for this simple example, we can use a simple built-in Centrifugo static file server:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"./centrifugo serve --port 3000\n"})}),"\n",(0,i.jsx)(n.p,{children:"Alternatively, if you have Python 3 installed:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"python3 -m http.server 3000\n"})}),"\n",(0,i.jsxs)(n.p,{children:["These commands start a simple static file web server that serves the current directory on port 3000. Make sure you still have Centrifugo server running. Open ",(0,i.jsx)(n.a,{href:"http://localhost:3000/",children:"http://localhost:3000/"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Now if you look at browser developer tools or in Centrifugo logs you will notice that a connection can not be successfully established:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"2021-09-01 10:17:33 [INF] request Origin is not authorized due to empty allowed_origins origin=http://localhost:3000\n"})}),"\n",(0,i.jsxs)(n.p,{children:["That's because we have not set ",(0,i.jsx)(n.code,{children:"allowed_origins"})," in the configuration. Modify ",(0,i.jsx)(n.code,{children:"allowed_origins"})," like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  ...\n  "allowed_origins": ["http://localhost:3000"]\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Allowed origins is a security option for request originating from web browsers \u2013 see ",(0,i.jsx)(n.a,{href:"/docs/server/configuration#allowed_origins",children:"more details"})," in server configuration docs. ",(0,i.jsx)(n.strong,{children:"Restart Centrifugo"})," after modifying ",(0,i.jsx)(n.code,{children:"allowed_origins"})," in a configuration file."]}),"\n",(0,i.jsx)(n.p,{children:"Now if you reload a browser window with an application you should see new information logs in server output:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'2022-06-10 09:44:21 [INF] invalid connection token error="invalid token: token format is not valid" client=a65a8463-6a36-421d-814a-0083c8836529\n2022-06-10 09:44:21 [INF] disconnect after handling command client=a65a8463-6a36-421d-814a-0083c8836529 command="id:1  connect:{token:\\"<TOKEN>\\"  name:\\"js\\"}" reason="invalid token" user=\n'})}),"\n",(0,i.jsxs)(n.p,{children:["We still cannot connect. That's because the client must provide a valid JWT (JSON Web Token) to authenticate itself. This token ",(0,i.jsx)(n.strong,{children:"must be generated on your backend"})," and passed to the client-side (over template variables or using a separate AJAX call \u2013 whichever way you prefer). Since in our simple example we don't have an application backend, we can quickly generate an example token for a user using the ",(0,i.jsx)(n.code,{children:"centrifugo"})," sub-command ",(0,i.jsx)(n.code,{children:"gentoken"}),", like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"./centrifugo gentoken -u 123722\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u2013 where ",(0,i.jsx)(n.code,{children:"-u"})," flag sets user ID. The output should be like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'HMAC SHA-256 JWT for user "123722" with expiration TTL 168h0m0s:\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM3MjIiLCJleHAiOjE2NTU0NDgyOTl9.mUU9s5kj3yqp-SAEqloGy8QBgsLg0llA7lKUNwtHRnw\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u2013 you will have a different token value since this one is based on the randomly generated ",(0,i.jsx)(n.code,{children:"token_hmac_secret_key"})," from the configuration file we created at the beginning of this tutorial. See the ",(0,i.jsx)(n.a,{href:"/docs/server/authentication",children:"token authentication docs"})," for information about proper token generation in a real application."]}),"\n",(0,i.jsxs)(n.p,{children:["Now we can copy generated HMAC SHA-256 JWT and paste it into Centrifugo constructor instead of ",(0,i.jsx)(n.code,{children:"<TOKEN>"})," placeholder in ",(0,i.jsx)(n.code,{children:"index.html"})," file. I.e.:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'const centrifuge = new Centrifuge("ws://localhost:8000/connection/websocket", {\n    token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM3MjIiLCJleHAiOjE2NTU0NDgyOTl9.mUU9s5kj3yqp-SAEqloGy8QBgsLg0llA7lKUNwtHRnw"\n});\n'})}),"\n",(0,i.jsx)(n.p,{children:"If you reload your browser tab \u2013 the connection will be successfully established, but the client still cannot subscribe to a channel:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'2022-06-10 09:45:49 [INF] client command error error="permission denied" client=88116489-350f-447f-9ff3-ab61c9341efe code=103 command="id:2  subscribe:{channel:\\"channel\\"}" reply="id:2  error:{code:103  message:\\"permission denied\\"}" user=123722\n'})}),"\n",(0,i.jsxs)(n.p,{children:["We need to give the client permission to subscribe to the channel ",(0,i.jsx)(n.code,{children:"channel"}),". There are several ways to do this. For example, the client can provide a ",(0,i.jsx)(n.a,{href:"/docs/server/channel_token_auth",children:"subscription JWT"})," for a channel. But here we will use an option to allow all authenticated clients to subscribe to any channel."]}),"\n",(0,i.jsxs)(n.p,{children:["To do this let's extend the server configuration with the ",(0,i.jsx)(n.code,{children:"allow_subscribe_for_client"})," option:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "token_hmac_secret_key": "bbe7d157-a253-4094-9759-06a8236543f9",\n  "admin": true,\n  "admin_password": "d0683813-0916-4c49-979f-0e08a686b727",\n  "admin_secret": "4e9eafcf-0120-4ddd-b668-8dc40072c78e",\n  "api_key": "d7627bb6-2292-4911-82e1-615c0ed3eebb",\n  "allowed_origins": ["http://localhost:3000"],\n  "allow_subscribe_for_client": true\n}\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["A good practice with Centrifugo is to configure ",(0,i.jsx)(n.a,{href:"/docs/server/channels#channel-namespaces",children:"channel namespaces"})," for the different types of real-time features you have in the application. By defining namespaces, you can achieve granular control over channel behavior and permissions."]})}),"\n",(0,i.jsx)(n.p,{children:"Restart Centrifugo \u2013 and after doing this, everything should start working. The client can now successfully connect and subscribe to a channel."}),"\n",(0,i.jsx)(n.p,{children:"Open the developer tools and look at the WebSocket frames panel; you should see something like this:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Connected",src:t(33193).Z+"",width:"3070",height:"1542"})}),"\n",(0,i.jsxs)(n.p,{children:["Note that in this example, we generated a connection JWT \u2013 but it has an expiration time, so after some time, Centrifugo will stop accepting those tokens. In real life, you need to add a token refresh function to the client to rotate tokens. See our ",(0,i.jsx)(n.a,{href:"/docs/transports/client_api",children:"client API SDK spec"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"OK, the last thing we need to do here is to publish a new counter value to a channel and make sure our app works properly."}),"\n",(0,i.jsxs)(n.p,{children:["We can do this over the Centrifugo API by sending an HTTP request to the default API endpoint ",(0,i.jsx)(n.code,{children:"http://localhost:8000/api"}),", but let's do this over the admin web panel first."]}),"\n",(0,i.jsxs)(n.p,{children:["Open the Centrifugo admin web panel in another browser tab (",(0,i.jsx)(n.a,{href:"http://localhost:8000/",children:"http://localhost:8000/"}),") and go to the ",(0,i.jsx)(n.code,{children:"Actions"})," section. Select the publish action, insert the channel name that you want to publish to \u2013 in our case, this is the string ",(0,i.jsx)(n.code,{children:"channel"})," \u2013 and insert into the ",(0,i.jsx)(n.code,{children:"data"})," area JSON like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n    "value": 1\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Admin publish",src:t(48410).Z+"",width:"2482",height:"1282"})}),"\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.code,{children:"PUBLISH"})," button and check out the application browser tab \u2013 counter value must be immediately received and displayed."]}),"\n",(0,i.jsx)(n.p,{children:"Open several browser tabs with our app and make sure all tabs receive a message as soon as you publish it."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Message received",src:t(90074).Z+"",width:"3068",height:"1310"})}),"\n",(0,i.jsxs)(n.p,{children:["BTW, let's also look at how you can publish data to a channel over Centrifugo server API from a terminal using ",(0,i.jsx)(n.code,{children:"curl"})," tool:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl --header "Content-Type: application/json" \\\n  --header "X-API-Key: d7627bb6-2292-4911-82e1-615c0ed3eebb" \\\n  --request POST \\\n  --data \'{"channel": "channel", "data": {"value": 2}}\' \\\n  http://localhost:8000/api/publish\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u2013 where for ",(0,i.jsx)(n.code,{children:"Authorization"})," header we set ",(0,i.jsx)(n.code,{children:"api_key"})," value from Centrifugo config file generated above."]}),"\n",(0,i.jsxs)(n.p,{children:["We did it! We built the simplest browser real-time app with Centrifugo and its JavaScript client. It doesn't have a backend; it's not very useful, to be honest, but it should give you an insight into how to start working with the Centrifugo server. Read more about the Centrifugo server in the next documentation chapters \u2013 it can do much more than we just showed here. The ",(0,i.jsx)(n.a,{href:"/docs/getting-started/integration",children:"Integration guide"})," describes the process of idiomatic Centrifugo integration with your application backend. And ",(0,i.jsx)(n.a,{href:"/docs/tutorial/intro",children:"chat/messenger app tutorial"})," provides a comprehensive guide how to build real-time app with Centrifugo from scratch."]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},45593:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/quick_start_admin_v5-52b31f2dfd00de4c5169e2b24c71bd1f.png"},35724:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/quick_start_logged_in_v4-e81864800a451fd7119a91f51c1b466a.png"},90074:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/quick_start_message_v4-81964ce5777a2c65910116a04fa6e371.png"},48410:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/quick_start_publish_v4-54ba7f45435ba110190f21e2c3e1dd24.png"},33193:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/quick_start_ws_frames_v4-9e299975b617ef20f961ed68692e67d9.png"},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>a});var i=t(67294);const s={},o=i.createContext(s);function a(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);