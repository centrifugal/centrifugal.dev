"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[5028],{7157:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>l});var n=o(7462),i=(o(7294),o(3905));const r={id:"websocket",title:"WebSocket"},s=void 0,a={unversionedId:"transports/websocket",id:"transports/websocket",title:"WebSocket",description:"Websocket is the main transport in Centrifugo. It's a very efficient low-overhead protocol on top of TCP.",source:"@site/docs/transports/websocket.md",sourceDirName:"transports",slug:"/transports/websocket",permalink:"/docs/transports/websocket",draft:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/transports/websocket.md",tags:[],version:"current",frontMatter:{id:"websocket",title:"WebSocket"},sidebar:"Transports",previous:{title:"Client real-time SDKs",permalink:"/docs/transports/client_sdk"},next:{title:"HTTP streaming",permalink:"/docs/transports/http_stream"}},c={},l=[{value:"Options",id:"options",level:2},{value:"websocket_message_size_limit",id:"websocket_message_size_limit",level:3},{value:"websocket_read_buffer_size",id:"websocket_read_buffer_size",level:3},{value:"websocket_write_buffer_size",id:"websocket_write_buffer_size",level:3},{value:"websocket_use_write_buffer_pool",id:"websocket_use_write_buffer_pool",level:3},{value:"websocket_compression",id:"websocket_compression",level:3},{value:"Protobuf binary protocol",id:"protobuf-binary-protocol",level:2},{value:"Debugging with Postman, wscat, etc",id:"debugging-with-postman-wscat-etc",level:2}],p={toc:l};function u(e){let{components:t,...o}=e;return(0,i.kt)("wrapper",(0,n.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/WebSocket"},"Websocket")," is the main transport in Centrifugo. It's a very efficient low-overhead protocol on top of TCP."),(0,i.kt)("p",null,"The biggest advantage is that Websocket works out of the box in all modern browsers and almost all programming languages have Websocket implementations. This makes Websocket a universal transport that can be used to connect to Centrifugo from almost everywhere."),(0,i.kt)("p",null,"Default WebSocket connection endpoint in Centrifugo is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"/connection/websocket\n")),(0,i.kt)("p",null,"So to connect:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="Connect to local Centrifugo with JavaScript SDK"',title:'"Connect',to:!0,local:!0,Centrifugo:!0,with:!0,JavaScript:!0,'SDK"':!0},"const client = new Centrifuge('ws://localhost:8000/connection/websocket', {\n    // token: ?,\n    // getToken: ?\n});\n\nclient.connect();\n")),(0,i.kt)("h2",{id:"options"},"Options"),(0,i.kt)("h3",{id:"websocket_message_size_limit"},"websocket_message_size_limit"),(0,i.kt)("p",null,"Default: 65536 (64KB)"),(0,i.kt)("p",null,"Maximum allowed size of a message received from WebSocket connection in bytes."),(0,i.kt)("h3",{id:"websocket_read_buffer_size"},"websocket_read_buffer_size"),(0,i.kt)("p",null,"In bytes, by default 0 which tells Centrifugo to reuse read buffer from HTTP server for WebSocket connection (usually 4096 bytes in size). If set to a lower value can reduce memory usage per WebSocket connection (but can increase number of system calls depending on average message size)."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="config.json"',title:'"config.json"'},'{\n    ...\n    "websocket_read_buffer_size": 512\n}\n')),(0,i.kt)("h3",{id:"websocket_write_buffer_size"},"websocket_write_buffer_size"),(0,i.kt)("p",null,"In bytes, by default 0 which tells Centrifugo to reuse write buffer from HTTP server for WebSocket connection (usually 4096 bytes in size). If set to a lower value can reduce memory usage per WebSocket connection (but HTTP buffer won't be reused):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="config.json"',title:'"config.json"'},'{\n    ...\n    "websocket_write_buffer_size": 512\n}\n')),(0,i.kt)("h3",{id:"websocket_use_write_buffer_pool"},"websocket_use_write_buffer_pool"),(0,i.kt)("p",null,"If you have a few writes then ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket_use_write_buffer_pool")," (boolean, default ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),") option can reduce memory usage of Centrifugo a bit as there won't be separate write buffer binded to each WebSocket connection."),(0,i.kt)("h3",{id:"websocket_compression"},"websocket_compression"),(0,i.kt)("p",null,"An experimental feature for raw WebSocket endpoint - ",(0,i.kt)("inlineCode",{parentName:"p"},"permessage-deflate")," compression for  websocket messages. Btw look at ",(0,i.kt)("a",{parentName:"p",href:"https://www.igvita.com/2013/11/27/configuring-and-optimizing-websocket-compression/"},"great article")," about websocket compression. WebSocket compression can reduce an amount of traffic travelling over the wire."),(0,i.kt)("p",null,"We consider this experimental because this websocket compression is experimental in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/gorilla/websocket"},"Gorilla Websocket")," library that Centrifugo uses internally."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"Enabling WebSocket compression will result in much slower Centrifugo performance and more memory usage \u2013 depending on your message rate this can be very noticeable.")),(0,i.kt)("p",null,"To enable WebSocket compression for raw WebSocket endpoint set ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket_compression")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," in a configuration file. After this clients that support ",(0,i.kt)("inlineCode",{parentName:"p"},"permessage-deflate")," will negotiate compression with server automatically. Note that enabling compression does not mean that every connection will use it - this depends on client support for this feature."),(0,i.kt)("p",null,"Another option is ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket_compression_min_size"),". Default 0. This is a minimal size of message in bytes for which we use ",(0,i.kt)("inlineCode",{parentName:"p"},"deflate")," compression when writing it to client's connection. Default value ",(0,i.kt)("inlineCode",{parentName:"p"},"0")," means that we will compress all messages when ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket_compression")," enabled and compression support negotiated with client."),(0,i.kt)("p",null,"It's also possible to control websocket compression level defined at ",(0,i.kt)("a",{parentName:"p",href:"https://golang.org/pkg/compress/flate/#NewWriter"},"compress/flate")," By default when compression with a client negotiated Centrifugo uses compression level 1 (BestSpeed). If you want to set custom compression level use ",(0,i.kt)("inlineCode",{parentName:"p"},"websocket_compression_level")," configuration option."),(0,i.kt)("h2",{id:"protobuf-binary-protocol"},"Protobuf binary protocol"),(0,i.kt)("p",null,"In most cases you will use Centrifugo with JSON protocol which is used by default. It consists of simple human-readable frames that can be easily inspected. Also it's a very simple task to publish JSON encoded data to HTTP API endpoint. You may want to use binary Protobuf client protocol if:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"you want less traffic on wire as Protobuf is very compact"),(0,i.kt)("li",{parentName:"ul"},"you want maximum performance on server-side as Protobuf encoding/decoding is very efficient"),(0,i.kt)("li",{parentName:"ul"},"you can sacrifice human-readable JSON for your application")),(0,i.kt)("p",null,"Binary protobuf protocol only works for raw Websocket connections (as SockJS can't deal with binary). With most clients to use binary you just need to provide query parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"format")," to Websocket URL, so final URL look like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"wss://centrifugo.example.com/connection/websocket?format=protobuf\n")),(0,i.kt)("p",null,"After doing this Centrifugo will use binary frames to pass data between client and server. Your application specific payload can be random bytes."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"You still can continue to encode your application specific data as JSON when using Protobuf protocol thus have a possibility to co-exist with clients that use JSON protocol on the same Centrifugo installation inside the same channels.")),(0,i.kt)("h2",{id:"debugging-with-postman-wscat-etc"},"Debugging with Postman, wscat, etc"),(0,i.kt)("p",null,"Centrifugo supports a special url parameter for bidirectional websocket which turns on using native WebSocket frame ping-pong mechanism instead of ",(0,i.kt)("a",{parentName:"p",href:"/docs/transports/overview#pingpong-behavior"},"server-to-client application level pings")," Centrifugo uses by default. This simplifies debugging Centrifugo protocol with tools like Postman, wscat, websocat, etc. "),(0,i.kt)("p",null,"By default, it may be inconvenient due to the fact Centrifugo sends periodic ping message to the client (",(0,i.kt)("inlineCode",{parentName:"p"},"{}")," in JSON protocol scenario) and expects pong response back within some time period. Otherwise Centrifugo closes connection. This results in problems with mentioned tools because you had to manually send ",(0,i.kt)("inlineCode",{parentName:"p"},"{}")," pong message upon ping message. So typical session in ",(0,i.kt)("inlineCode",{parentName:"p"},"wscat")," could look like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'\u276f wscat --connect ws://localhost:8000/connection/websocket\nConnected (press CTRL+C to quit)\n> {"id": 1, "connect": {}}\n< {"id":1,"connect":{"client":"9ac9de4e-5289-4ad6-9aa7-8447f007083e","version":"0.0.0","ping":25,"pong":true}}\n< {}\nDisconnected (code: 3012, reason: "no pong")\n')),(0,i.kt)("p",null,"The parameter is called ",(0,i.kt)("inlineCode",{parentName:"p"},"cf_ws_frame_ping_pong"),", to use it connect to Centrifugo bidirectional WebSocket endpoint like ",(0,i.kt)("inlineCode",{parentName:"p"},"ws://localhost:8000/websocket/connection?cf_ws_frame_ping_pong=true"),". Here is an example which demonstrates working with Postman WebSocket where we connect to local Centrifugo and subscribe to two channels ",(0,i.kt)("inlineCode",{parentName:"p"},"test1")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"test2"),":"),(0,i.kt)("video",{width:"100%",loop:!0,autoPlay:"autoplay",muted:!0,controls:"",src:"/img/postman.mp4"}),(0,i.kt)("p",null,"You can then proceed to Centrifugo ",(0,i.kt)("a",{parentName:"p",href:"/docs/server/admin_web"},"admin web UI"),", publish something to these channels and see publications in Postman."),(0,i.kt)("p",null,"Note, how we sent several JSON commands in one WebSocket frame to Centrifugo from Postman in the example above - this is possible since Centrifugo protocol supports batches of commands in line-delimited format."),(0,i.kt)("p",null,"We consider this feature to be used only for debugging, ",(0,i.kt)("strong",{parentName:"p"},"in production prefer using our SDKs without using ",(0,i.kt)("inlineCode",{parentName:"strong"},"cf_ws_frame_ping_pong")," parameter")," \u2013 because app-level ping-pong is more efficient and our SDKs detect broken connections due to it."))}u.isMDXComponent=!0},3905:(e,t,o)=>{o.d(t,{Zo:()=>p,kt:()=>f});var n=o(7294);function i(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function s(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){i(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function a(e,t){if(null==e)return{};var o,n,i=function(e,t){if(null==e)return{};var o,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||(i[o]=e[o]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(i[o]=e[o])}return i}var c=n.createContext({}),l=function(e){var t=n.useContext(c),o=t;return e&&(o="function"==typeof e?e(t):s(s({},t),e)),o},p=function(e){var t=l(e.components);return n.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var o=e.components,i=e.mdxType,r=e.originalType,c=e.parentName,p=a(e,["components","mdxType","originalType","parentName"]),m=l(o),f=i,d=m["".concat(c,".").concat(f)]||m[f]||u[f]||r;return o?n.createElement(d,s(s({ref:t},p),{},{components:o})):n.createElement(d,s({ref:t},p))}));function f(e,t){var o=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=o.length,s=new Array(r);s[0]=m;var a={};for(var c in t)hasOwnProperty.call(t,c)&&(a[c]=t[c]);a.originalType=e,a.mdxType="string"==typeof e?e:i,s[1]=a;for(var l=2;l<r;l++)s[l]=o[l];return n.createElement.apply(null,s)}return n.createElement.apply(null,o)}m.displayName="MDXCreateElement"}}]);