"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[5807],{28453:(e,i,n)=>{n.d(i,{R:()=>c,x:()=>o});var t=n(96540);const r={},s=t.createContext(r);function c(e){const i=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function o(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),t.createElement(s.Provider,{value:i},e.children)}},55766:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"server/tls","title":"Configure TLS","description":"TLS/SSL layer is very important not only for securing your connections but also to increase a","source":"@site/docs/server/tls.md","sourceDirName":"server","slug":"/server/tls","permalink":"/docs/server/tls","draft":false,"unlisted":false,"editUrl":"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/tls.md","tags":[],"version":"current","frontMatter":{"id":"tls","title":"Configure TLS"}}');var r=n(74848),s=n(28453);const c={id:"tls",title:"Configure TLS"},o=void 0,d={},l=[{value:"Using crt and key files",id:"using-crt-and-key-files",level:3},{value:"Automatic certificates",id:"automatic-certificates",level:3},{value:"TLS for GRPC API",id:"tls-for-grpc-api",level:3},{value:"TLS for GRPC unidirectional stream",id:"tls-for-grpc-unidirectional-stream",level:3},{value:"Unified TLS config object",id:"unified-tls-config-object",level:3},{value:"TLSConfig",id:"tlsconfig",level:4}];function a(e){const i={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.p,{children:"TLS/SSL layer is very important not only for securing your connections but also to increase a\nchance to establish Websocket connection."}),"\n",(0,r.jsx)(i.admonition,{type:"tip",children:(0,r.jsx)(i.p,{children:"In most situations you better put TLS termination task on your reverse proxy/load balancing software such as Nginx. This can be a good thing for performance."})}),"\n",(0,r.jsx)(i.p,{children:"There are situations though when you want to serve secure connections by Centrifugo itself."}),"\n",(0,r.jsxs)(i.p,{children:["There are two ways to do this: using TLS certificate ",(0,r.jsx)(i.code,{children:"cert"})," and ",(0,r.jsx)(i.code,{children:"key"})," files that you've got\nfrom your CA provider or using automatic certificate handling via ",(0,r.jsx)(i.a,{href:"https://datatracker.ietf.org/doc/html/rfc8555",children:"ACME"})," provider (only ",(0,r.jsx)(i.a,{href:"https://letsencrypt.org/",children:"Let's Encrypt"})," at this moment)."]}),"\n",(0,r.jsx)(i.h3,{id:"using-crt-and-key-files",children:"Using crt and key files"}),"\n",(0,r.jsxs)(i.p,{children:["In first way you already have ",(0,r.jsx)(i.code,{children:"cert"})," and ",(0,r.jsx)(i.code,{children:"key"})," files. For development you can create self-signed\ncertificate - see ",(0,r.jsx)(i.a,{href:"https://devcenter.heroku.com/articles/ssl-certificate-self",children:"this instruction"})," as\nexample."]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "tls": {\n    "enabled": true,\n    "key_pem_file": "server.key",\n    "cert_pem_file": "server.crt"\n  }\n}\n'})}),"\n",(0,r.jsx)(i.p,{children:"And run:"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{children:"./centrifugo --config=config.json\n"})}),"\n",(0,r.jsxs)(i.p,{children:["See ",(0,r.jsx)(i.a,{href:"#unified-tls-config-object",children:"other options"})," supported by TLS object."]}),"\n",(0,r.jsx)(i.h3,{id:"automatic-certificates",children:"Automatic certificates"}),"\n",(0,r.jsx)(i.p,{children:"For automatic certificates from Let's Encrypt add into configuration file:"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "tls_autocert": {\n    "enabled": true,\n    "host_whitelist": "www.example.com",\n    "cache_dir": "/tmp/certs",\n    "email": "user@example.com",\n    "http": true,\n    "http_addr": ":80"\n  }\n}\n'})}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"tls_autocert.enabled"})," (boolean) says Centrifugo that you want automatic certificate handling using ACME provider."]}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"tls_autocert.host_whitelist"})," (string) is a string with your app domain address. This can be comma-separated\nlist. It's optional but recommended for extra security."]}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"tls_autocert.cache_dir"})," (string) is a path to a folder to cache issued certificate files. This is optional\nbut will increase performance."]}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"tls_autocert.email"})," (string) is optional - it's an email address ACME provider will send notifications\nabout problems with your certificates."]}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"tls_autocert.http"})," (boolean) is an option to handle http_01 ACME challenge on non-TLS port."]}),"\n",(0,r.jsxs)(i.p,{children:[(0,r.jsx)(i.code,{children:"tls_autocert.http_addr"})," (string) can be used to set address for handling http_01 ACME challenge (default is ",(0,r.jsx)(i.code,{children:":80"}),")"]}),"\n",(0,r.jsxs)(i.p,{children:["When configured correctly and your domain is valid (",(0,r.jsx)(i.code,{children:"localhost"})," will not work) - certificates\nwill be retrieved on first request to Centrifugo."]}),"\n",(0,r.jsx)(i.p,{children:"Also Let's Encrypt certificates will be automatically renewed."}),"\n",(0,r.jsx)(i.h3,{id:"tls-for-grpc-api",children:"TLS for GRPC API"}),"\n",(0,r.jsxs)(i.p,{children:["You can configure TLS for GRPC API server. Set ",(0,r.jsx)(i.code,{children:"grpc_api.tls"})," objects which is a ",(0,r.jsx)(i.a,{href:"#unified-tls-config-object",children:"TLSConfig"}),"."]}),"\n",(0,r.jsx)(i.h3,{id:"tls-for-grpc-unidirectional-stream",children:"TLS for GRPC unidirectional stream"}),"\n",(0,r.jsxs)(i.p,{children:["You can configure TLS for GRPC unidirectional stream endpoint. Set ",(0,r.jsx)(i.code,{children:"uni_grpc.tls"})," objects which is a ",(0,r.jsx)(i.a,{href:"#unified-tls-config-object",children:"TLSConfig"}),"."]}),"\n",(0,r.jsx)(i.h3,{id:"unified-tls-config-object",children:"Unified TLS config object"}),"\n",(0,r.jsxs)(i.p,{children:["Centrifugo v5 started a migration to a new unified way to configure TLS for all parts of Centrifugo. Some reasoning may be found in ",(0,r.jsx)(i.a,{href:"https://github.com/centrifugal/centrifugo/issues/831",children:"this issue on GitHub"}),"."]}),"\n",(0,r.jsx)(i.admonition,{type:"caution",children:(0,r.jsx)(i.p,{children:"At this point we use a unified TLS configuration object only for some parts of Centrifugo, but planning to extend this to all TLS configurations in Centrifugo v6. We explicitly point to this config in feature descriptions at this stage."})}),"\n",(0,r.jsx)(i.p,{children:"New TLS config is an object that has the following structure."}),"\n",(0,r.jsx)(i.h4,{id:"tlsconfig",children:"TLSConfig"}),"\n",(0,r.jsxs)(i.table,{children:[(0,r.jsx)(i.thead,{children:(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.th,{children:"Option Name"}),(0,r.jsx)(i.th,{children:"Type"}),(0,r.jsx)(i.th,{children:"Description"})]})}),(0,r.jsxs)(i.tbody,{children:[(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"enabled"})}),(0,r.jsx)(i.td,{children:"bool"}),(0,r.jsx)(i.td,{children:"Turns on using TLS."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"cert_pem"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Certificate in PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"cert_pem_b64"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Certificate in base64 encoded PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"cert_pem_file"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Path to a file with certificate in PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"key_pem"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Key in PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"key_pem_b64"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Key in base64 encoded PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"key_pem_file"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Path to a file with key in PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"server_ca_pem"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Server root CA certificate in PEM format used by client to verify server's certificate during handshake."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"server_ca_pem_b64"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Server root CA certificate in base64 encoded PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"server_ca_pem_file"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Path to a file with server root CA certificate in PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"client_ca_pem"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Client CA certificate in PEM format used by server to verify client's certificate during handshake."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"client_ca_pem_b64"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Client CA certificate in base64 encoded PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"client_ca_pem_file"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Path to a file with client CA certificate in PEM format."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"insecure_skip_verify"})}),(0,r.jsx)(i.td,{children:"bool"}),(0,r.jsx)(i.td,{children:"Turns off server certificate verification."})]}),(0,r.jsxs)(i.tr,{children:[(0,r.jsx)(i.td,{children:(0,r.jsx)(i.code,{children:"server_name"})}),(0,r.jsx)(i.td,{children:"string"}),(0,r.jsx)(i.td,{children:"Used to verify the hostname on the returned certificates."})]})]})]}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Source Priority:"})," The configuration allows specifying TLS settings from multiple sources: file, base64 encoded PEM, and raw PEM. The sources are prioritized in the following order:","\n",(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsx)(i.li,{children:"File to PEM"}),"\n",(0,r.jsx)(i.li,{children:"Base64 encoded PEM"}),"\n",(0,r.jsx)(i.li,{children:"Raw PEM"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Single Source Usage:"})," Users should ensure that only one source of configured values is used. For example, if both ",(0,r.jsx)(i.code,{children:"cert_pem_file"})," and ",(0,r.jsx)(i.code,{children:"cert_pem"})," are set, the file source (",(0,r.jsx)(i.code,{children:"cert_pem_file"}),") will be used, and the raw PEM (",(0,r.jsx)(i.code,{children:"cert_pem"}),") will be ignored."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Server and Client CA:"})," ",(0,r.jsx)(i.code,{children:"server_ca_pem"})," and ",(0,r.jsx)(i.code,{children:"client_ca_pem"})," are used for verifying the server and client certificates respectively during the TLS handshake."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Insecure Option:"})," The ",(0,r.jsx)(i.code,{children:"insecure_skip_verify"})," option can be used to turn off server certificate verification, which is not recommended for production environments."]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Hostname Verification:"})," The ",(0,r.jsx)(i.code,{children:"server_name"})," is utilized to verify the hostname on the returned certificates, providing an additional layer of security."]}),"\n"]}),"\n",(0,r.jsx)(i.p,{children:"So in the configuration the usage of new TLS config may be like this:"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "unified_proxy": {\n    "grpc": {\n      "tls": {\n        "enabled": true,\n        "cert_pem_file": "/path/to/cert.pem",\n        "key_pem_file": "/path/to/key.pem"\n      }\n    }\n  }\n}\n'})})]})}function h(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,r.jsx)(i,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}}}]);