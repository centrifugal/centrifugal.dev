"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[7717],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),p=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=p(a),m=r,d=h["".concat(l,".").concat(m)]||h[m]||u[m]||o;return a?n.createElement(d,i(i({ref:t},c),{},{components:a})):n.createElement(d,i({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},8814:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var n=a(7462),r=(a(7294),a(3905));const o={title:"Building a multi-room chat application with Laravel and Centrifugo",tags:["centrifugo","tutorial","laravel","php"],description:"In this tutorial, we are integrating Laravel framework with Centrifugo real-time messaging server to make a multi-room chat application.",author:"Anton Silischev",authorTitle:"Centrifugo contributor",authorImageURL:"https://github.com/silischev.png",image:"/img/laravel_centrifugo.jpg",hide_table_of_contents:!1},i=void 0,s={permalink:"/blog/2021/12/14/laravel-multi-room-chat-tutorial",editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/blog/2021-12-14-laravel-multi-room-chat-tutorial.md",source:"@site/blog/2021-12-14-laravel-multi-room-chat-tutorial.md",title:"Building a multi-room chat application with Laravel and Centrifugo",description:"In this tutorial, we are integrating Laravel framework with Centrifugo real-time messaging server to make a multi-room chat application.",date:"2021-12-14T00:00:00.000Z",formattedDate:"December 14, 2021",tags:[{label:"centrifugo",permalink:"/blog/tags/centrifugo"},{label:"tutorial",permalink:"/blog/tags/tutorial"},{label:"laravel",permalink:"/blog/tags/laravel"},{label:"php",permalink:"/blog/tags/php"}],readingTime:10.75,hasTruncateMarker:!0,authors:[{name:"Anton Silischev",title:"Centrifugo contributor",imageURL:"https://github.com/silischev.png"}],frontMatter:{title:"Building a multi-room chat application with Laravel and Centrifugo",tags:["centrifugo","tutorial","laravel","php"],description:"In this tutorial, we are integrating Laravel framework with Centrifugo real-time messaging server to make a multi-room chat application.",author:"Anton Silischev",authorTitle:"Centrifugo contributor",authorImageURL:"https://github.com/silischev.png",image:"/img/laravel_centrifugo.jpg",hide_table_of_contents:!1},prevItem:{title:"Centrifugo v4 released \u2013 a little revolution",permalink:"/blog/2022/07/19/centrifugo-v4-released"},nextItem:{title:"Centrifugo integration with Django \u2013 building a basic chat application",permalink:"/blog/2021/11/04/integrating-with-django-building-chat-application"}},l={authorsImageUrls:[void 0]},p=[{value:"Application overview",id:"application-overview",level:2},{value:"Why integrate Laravel with Centrifugo?",id:"why-integrate-laravel-with-centrifugo",level:2},{value:"Setup and start a project",id:"setup-and-start-a-project",level:2},{value:"Application structure",id:"application-structure",level:2},{value:"Environment settings",id:"environment-settings",level:3},{value:"Database migrations and models",id:"database-migrations-and-models",level:3},{value:"Broadcasting",id:"broadcasting",level:3},{value:"Interaction with Centrifugo",id:"interaction-with-centrifugo",level:3},{value:"Connect proxy controller",id:"connect-proxy-controller",level:3},{value:"Room controller",id:"room-controller",level:3},{value:"Client side",id:"client-side",level:3},{value:"Possible improvements",id:"possible-improvements",level:2},{value:"Conclusion",id:"conclusion",level:2}],c={toc:p};function u(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Image",src:a(2717).Z,width:"1500",height:"500"})),(0,r.kt)("p",null,"In this tutorial, we will create a multi-room chat server using ",(0,r.kt)("a",{parentName:"p",href:"https://laravel.com/"},"Laravel framework")," and ",(0,r.kt)("a",{parentName:"p",href:"https://centrifugal.dev/"},"Centrifugo")," real-time messaging server."),(0,r.kt)("p",null,"Authenticated users of our chat app will be able to create new chat rooms, join existing rooms and instantly communicate inside rooms with the help of Centrifugo WebSocket real-time transport."),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"This tutorial was written for Centrifugo v3. We recently released ",(0,r.kt)("a",{parentName:"p",href:"/blog/2022/07/19/centrifugo-v4-released"},"Centrifugo v4")," which makes some parts of this tutorial obsolete. The core concepts are similar though \u2013 so this can still be used as a Centrifugo learning step.")),(0,r.kt)("h2",{id:"application-overview"},"Application overview"),(0,r.kt)("p",null,"The result will look like this:"),(0,r.kt)("video",{width:"100%",controls:!0},(0,r.kt)("source",{src:"/img/laravel_chat_demo.mp4",type:"video/mp4"}),"Sorry, your browser doesn't support embedded video."),(0,r.kt)("p",null,"For the backend, we are using Laravel (version 8.65) as one of the most popular PHP frameworks. Centrifugo v3 will accept WebSocket client connections. And we will implement an integration layer between Laravel and Centrifugo."),(0,r.kt)("p",null,"For CSS styles we are using recently released Bootstrap 5. Also, some vanilla JS instead of frameworks like React/Vue/whatever to make frontend Javascript code simple \u2013 so most developers out there could understand the mechanics. "),(0,r.kt)("p",null,"We are also using a bit old-fashioned server rendering here where server renders templates for different room routes (URLs) \u2013 i.e. our app is not a SPA app \u2013 mostly for the same reasons: to keep example short and let reader focus on Centrifugo and Laravel integration parts."),(0,r.kt)("p",null,"To generate fake user avatars we are requesting images from ",(0,r.kt)("a",{parentName:"p",href:"https://robohash.org/"},"https://robohash.org/")," which can generate unique robot puctures based on some input string (username in our case). Robots like to chat with each other!"),(0,r.kt)("img",{src:"https://robohash.org/1.png",width:"30%"}),(0,r.kt)("img",{src:"https://robohash.org/2.png",width:"30%"}),(0,r.kt)("img",{src:"https://robohash.org/4.png",width:"30%"}),(0,r.kt)("br",null),(0,r.kt)("br",null),(0,r.kt)("br",null),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"We also have some ideas on further possible app improvements at the end of this post.")),(0,r.kt)("h2",{id:"why-integrate-laravel-with-centrifugo"},"Why integrate Laravel with Centrifugo?"),(0,r.kt)("p",null,"Why would Laravel developers want to integrate a project with Centrifugo for real-time messaging functionality? That's a good question. There are several points which could be a good motivation:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Centrifugo is ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/centrifugal/centrifugo"},"open-source")," and ",(0,r.kt)("strong",{parentName:"li"},"self-hosted"),". So you can run it on your own infrastructure. Popular Laravel real-time broadcasting intergrations (Pusher and Ably) are paid cloud solutions. At scale Centrifugo will cost you less than cloud solutions. Of course cloud solutions do not require additional server setup \u2013 but everything is a trade-off right? So you should decide for youself."),(0,r.kt)("li",{parentName:"ul"},"Centrifugo is fast and scales well. It has an optimized Redis Engine with client-side sharding and Redis Cluster support. Centrifugo can also scale with KeyDB, Nats, or Tarantool. So it's possible to handle millions of connections distributed over different Centrifugo nodes."),(0,r.kt)("li",{parentName:"ul"},"Centrifugo provides a variety of features out-of-the-box \u2013 some of them are unique, especially for self-hosted real-time servers that scale to many nodes (like fast message history cache, or maintaining single user connection, both client-side and server-side subscriptions, etc)."),(0,r.kt)("li",{parentName:"ul"},"Centrifugo is lightweight, single binary server which works as a separate service \u2013 it can be a universal tool in the developer's pocket, can migrate with you from one project to another, no matter what programming language or framework is used for business logic.")),(0,r.kt)("p",null,"Hope this makes sense as a good motivation to give Centrifugo a try in your Laravel project. Let's get started!"),(0,r.kt)("h2",{id:"setup-and-start-a-project"},"Setup and start a project"),(0,r.kt)("p",null,"For the convenience of working with the example, we ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/docker-compose.yml"},"wrapped the end result into docker compose"),"."),(0,r.kt)("p",null,"To start the app clone ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples"},"examples repo"),", cd into ",(0,r.kt)("inlineCode",{parentName:"p"},"v3/php_laravel_chat_tutorial")," directory and run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker compose up\n")),(0,r.kt)("p",null,"At the first launch, the necessary images will be downloaded (will take some time and network bytes). When the main service is started, you should see something like this in container logs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"...\napp           | Database seeding completed successfully.\napp           | [10-Dec-2021 12:25:05] NOTICE: fpm is running, pid 112\napp           | [10-Dec-2021 12:25:05] NOTICE: ready to handle connections\n")),(0,r.kt)("p",null,"Then go to ",(0,r.kt)("a",{parentName:"p",href:"http://localhost/"},"http://localhost/")," \u2013 you should see:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Image",src:a(7199).Z,width:"884",height:"453"})),(0,r.kt)("p",null,"Register (using some fake credentials) or sign up \u2013 and proceed to the chat rooms."),(0,r.kt)("p",null,"Pay attention to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/tree/master/v3/php_laravel_chat_tutorial/docker/conf"},"configuration")," of Centrifugo and Nginx. Also, on ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/docker/entrypoints/app.sh"},"entrypoint")," which does some things:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"dependencies are installed via composer"),(0,r.kt)("li",{parentName:"ul"},"copying settings from .env.example"),(0,r.kt)("li",{parentName:"ul"},"db migrations are performed and the necessary npm packages are installed"),(0,r.kt)("li",{parentName:"ul"},"php-fpm starts")),(0,r.kt)("h2",{id:"application-structure"},"Application structure"),(0,r.kt)("p",null,"We assume you already familar with Laravel concepts, so we will just point you to some core aspects of the Laravel application structure and will pay more attention to Centrifugo integration parts."),(0,r.kt)("h3",{id:"environment-settings"},"Environment settings"),(0,r.kt)("p",null,"After the first launch of the application, all settings will be copied from the file ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/.env.example"},(0,r.kt)("inlineCode",{parentName:"a"},".env.example"))," to ",(0,r.kt)("inlineCode",{parentName:"p"},".env"),". Next, we will take a closer look at some settings."),(0,r.kt)("h3",{id:"database-migrations-and-models"},"Database migrations and models"),(0,r.kt)("p",null,"You can view the database structure ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/tree/master/v3/php_laravel_chat_tutorial/app/database/migrations"},"here"),"."),(0,r.kt)("p",null,"We will use the following tables which will be then translated to the application models:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Laravel standard user authentication tables. See ",(0,r.kt)("a",{parentName:"li",href:"https://laravel.com/docs/8.x/authentication"},"https://laravel.com/docs/8.x/authentication"),". In the service we are using Laravel Breeze. For more information ",(0,r.kt)("a",{parentName:"li",href:"https://laravel.com/docs/8.x/starter-kits#laravel-breeze"},"see official docs"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/database/migrations/2021_11_21_000001_create_rooms_table.php"},"rooms")," table. Basically - describes different rooms in the app every user can create."),(0,r.kt)("li",{parentName:"ul"},"rooms ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/database/migrations/2021_11_21_000002_create_users_rooms_table.php"},"many-to-many relation")," to users. Allows to add users into rooms when ",(0,r.kt)("inlineCode",{parentName:"li"},"join")," button clicked or automatically upon room creation."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/database/migrations/2021_11_21_000003_create_messages_table.php"},"messages"),". Keeps message history in rooms.")),(0,r.kt)("h3",{id:"broadcasting"},"Broadcasting"),(0,r.kt)("p",null,"For broadcasting we are using ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/denis660/laravel-centrifugo"},"laravel-centrifugo")," library. It helps to simplify interaction between Laravel and Centrifugo by providing some convenient wrappers."),(0,r.kt)("p",null,"Step-by-step configuration can be viewed in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/denis660/laravel-centrifugo"},"readme")," file of this library."),(0,r.kt)("p",null,"Pay attention to the ",(0,r.kt)("inlineCode",{parentName:"p"},"CENTRIFUGO_API_KEY")," setting. It is used to send API requests from Laravel to Centrifugo and must match in ",(0,r.kt)("inlineCode",{parentName:"p"},".env")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"centrifugo.json")," files. And we also telling ",(0,r.kt)("inlineCode",{parentName:"p"},"laravel-centrifugo")," the URL of Centrifugo. That's all we need to configure for this example app."),(0,r.kt)("p",null,"See more information about Laravel broadcasting ",(0,r.kt)("a",{parentName:"p",href:"https://laravel.com/docs/8.x/broadcasting"},"here"),"."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"As an alternative to ",(0,r.kt)("inlineCode",{parentName:"p"},"laravel-centrifugo"),", you can use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/phpcent"},"phpcent")," \u2013 it's an official generic API client which allows publishing to Centrifugo HTTP API. But it does know nothing about Laravel broadcasting specifics.")),(0,r.kt)("h3",{id:"interaction-with-centrifugo"},"Interaction with Centrifugo"),(0,r.kt)("p",null,"When user opens a chat app it connects to Centrifugo over WebSocket transport."),(0,r.kt)("p",null,"Let's take a closer look at Centrifugo server configuration file we use for this example app:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "port": 8000,\n  "engine": "memory",\n  "api_key": "some-long-api-key-which-you-should-keep-secret",\n  "allowed_origins": [\n    "http://localhost",\n  ],\n  "proxy_connect_endpoint": "http://nginx/centrifugo/connect/",\n  "proxy_http_headers": [\n    "Cookie"\n  ],\n  "namespaces": [\n    {\n      "name": "personal"\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"This configuration defines a connect proxy endpoint which is targeting Nginx and then proxied to Laravel. Centrifugo will proxy ",(0,r.kt)("inlineCode",{parentName:"p"},"Cookie")," header of WebSocket HTTP Upgrade requests to Laravel \u2013 this allows using native Laravel authentication."),(0,r.kt)("p",null,"We also defined a ",(0,r.kt)("inlineCode",{parentName:"p"},'"personal"')," namespace \u2013 we will subscribe each user to a personal channel in this namespace inside connect proxy handler. Using namespaces for different real-time features is one of Centrifugo best-practices."),(0,r.kt)("p",null,"Allowed origins must be properly set to prevent ",(0,r.kt)("a",{parentName:"p",href:"https://christian-schneider.net/CrossSiteWebSocketHijacking.html"},"cross-site WebSocket connection hijacking"),"."),(0,r.kt)("h3",{id:"connect-proxy-controller"},"Connect proxy controller"),(0,r.kt)("p",null,"To use native Laravel user authentication middlewares, we will use ",(0,r.kt)("a",{parentName:"p",href:"https://centrifugal.dev/docs/server/proxy"},"Centrifugo proxy feature"),"."),(0,r.kt)("p",null,"When user connects to Centrifugo it's connection attempt will be transformed into HTTP request from Centrifugo to Laravel and will hit the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/app/Http/Controllers/CentrifugoProxyController.php"},"connect proxy controller"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},"class CentrifugoProxyController extends Controller\n{\n    public function connect()\n    {\n        return new JsonResponse([\n            'result' => [\n                'user' => (string) Auth::user()->id,\n                'channels' => [\"personal:#\".Auth::user()->id],\n            ]\n        ]);\n    }\n}\n")),(0,r.kt)("p",null,"This controller ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/routes/api.php"},"protected by auth middleware"),"."),(0,r.kt)("p",null,"Since Centrifugo proxies ",(0,r.kt)("inlineCode",{parentName:"p"},"Cookie")," header of initial WebSocket HTTP Upgrade request Laravel auth layer will work just fine. So in a controller you already has access to the current authenticated user."),(0,r.kt)("p",null,"In the response from controller we tell Centrifugo the ID of connecting user and subscribe user to its personal channel (using ",(0,r.kt)("a",{parentName:"p",href:"https://centrifugal.dev/docs/server/channels#user-channel-boundary-"},"user-limited channel")," feature of Centrifugo). Returning a channel in such way will subscribe user to it using ",(0,r.kt)("a",{parentName:"p",href:"https://centrifugal.dev/docs/server/server_subs"},"server-side subscriptions")," mechanism."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Note, that in our chat app we are using a single personal channel for each user to receive real-time updates from all rooms. We are not creating separate subscriptions for each room user joined too. This will allow us to scale more easily in the future, and basically the only viable solution in case of room list pagination in chat application like this. It does not mean you can not combine personal user channels and separate room channels for different tasks though."),(0,r.kt)("p",{parentName:"admonition"},"Some additional tips can be found in ",(0,r.kt)("a",{parentName:"p",href:"https://centrifugal.dev/docs/faq/index#what-about-best-practices-with-the-number-of-channels"},"Centrifugo FAQ"),".")),(0,r.kt)("h3",{id:"room-controller"},"Room controller"),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/app/Http/Controllers/RoomController.php"},"RoomController")," we perform various actions with rooms:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"displaying rooms"),(0,r.kt)("li",{parentName:"ul"},"create rooms"),(0,r.kt)("li",{parentName:"ul"},"join users to rooms"),(0,r.kt)("li",{parentName:"ul"},"publish messages")),(0,r.kt)("p",null,"When we publish a message in a room, we send a message to the personal channel of all users joined to the room using the ",(0,r.kt)("a",{parentName:"p",href:"https://centrifugal.dev/docs/server/server_api#broadcast"},(0,r.kt)("inlineCode",{parentName:"a"},"broadcast")," method of Centrifugo API"),". It allows publishing the same message into many channels. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php"},'$message = Message::create([\n    \'sender_id\' => Auth::user()->id,\n    \'message\' => $requestData["message"],\n    \'room_id\' => $id,\n]);\n\n$room = Room::with(\'users\')->find($id);\n\n$channels = [];\nforeach ($room->users as $user) {\n    $channels[] = "personal:#" . $user->id;\n}\n\n$this->centrifugo->broadcast($channels, [\n    "text" => $message->message,\n    "createdAt" => $message->created_at->toDateTimeString(),\n    "roomId" => $id,\n    "senderId" => Auth::user()->id,\n    "senderName" => Auth::user()->name,\n]);\n')),(0,r.kt)("p",null,"We also add some fields to the published message which will be used when dynamically displaying a message coming from a WebSocket connection (see ",(0,r.kt)("a",{parentName:"p",href:"#client-side"},"Client side")," below)."),(0,r.kt)("h3",{id:"client-side"},"Client side"),(0,r.kt)("p",null,"Our chat is basically a one page with some variations dependng on the current route. So we use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/examples/blob/master/v3/php_laravel_chat_tutorial/app/resources/views/rooms/index.blade.php"},"a single view")," for the entire chat app."),(0,r.kt)("p",null,"On the page we have a form for creating rooms. The user who created the room automatically joins it upon creation. Other users need to join manually (using ",(0,r.kt)("inlineCode",{parentName:"p"},"join")," button in the room)."),(0,r.kt)("p",null,"When sending a message (using the chat room message input), we make an AJAX request that hits ",(0,r.kt)("inlineCode",{parentName:"p"},"RoomController")," shown above. A message saved into the database and then broadcasted to all users who joined this room. Here is a code that processes sending on ENTER:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'messageInput.onkeyup = function(e) {\n    if (e.keyCode === 13) {\n        e.preventDefault();\n        const message = messageInput.value;\n        if (!message) {\n            return;\n        }\n        const xhttp = new XMLHttpRequest();\n        xhttp.open("POST", "/rooms/" + roomId + "/publish");\n        xhttp.setRequestHeader("X-CSRF-TOKEN", csrfToken);\n        xhttp.send(JSON.stringify({\n            message: message\n        }));\n        messageInput.value = \'\';\n    }\n};\n')),(0,r.kt)("p",null,"After the message is processed on the server and broadcasted to Centrifugo it instantly comes to client-side. To receive the message we are connecting to Centrifugo WebSocket endpoint and wait for a message in the ",(0,r.kt)("inlineCode",{parentName:"p"},"publish")," event handler:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const url = "ws://" + window.location.host + "/connection/websocket";\nconst centrifuge = new Centrifuge(url);\n\ncentrifuge.on(\'connect\', function(ctx) {\n    console.log("connected to Centrifugo", ctx);\n});\n\ncentrifuge.on(\'disconnect\', function(ctx) {\n    console.log("disconnected from Centrifugo", ctx);\n});\n\ncentrifuge.on(\'publish\', function(ctx) {\n    if (ctx.data.roomId.toString() === currentRoomId) {\n        addMessage(ctx.data);\n        scrollToLastMessage();\n    }\n    addRoomLastMessage(ctx.data);\n});\n\ncentrifuge.connect();\n')),(0,r.kt)("p",null,"We are using ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/centrifugal/centrifuge-js"},"centrifuge-js")," client connector library to communicate with Centrifugo. This client abstracts away bidirectional asynchronous protocol complexity for us providing a simple way to listen connect, disconnect events and communicate with a server in various ways."),(0,r.kt)("p",null,"In publish event handler we check whether the message belongs to the room the user is currently in. If yes, then we add it to the message history of the room. We also add this message to the room in the list on the left as the last chat message in room. If necessary, we crop the text for normal display."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"In our example we only subscribe each user to a single channel, but user can be subscribed to several server-side channels. To distinguish between them use ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx.channel")," inside publish event handler.")),(0,r.kt)("p",null,"And that's it! We went through all the main parts of the integration."),(0,r.kt)("h2",{id:"possible-improvements"},"Possible improvements"),(0,r.kt)("p",null,"As promised, here is a list with several possible app improvements:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Transform to a single page app, use productive Javascript frameworks like React or VueJS instead of vanilla JS."),(0,r.kt)("li",{parentName:"ul"},"Add message read statuses - as soon as one of the chat participants read the message mark it read in the database."),(0,r.kt)("li",{parentName:"ul"},"Introduce user-to-user chats."),(0,r.kt)("li",{parentName:"ul"},"Support pagination for the message history, maybe for chat room list also."),(0,r.kt)("li",{parentName:"ul"},"Don't show all rooms in the system \u2013 add functionality to search room by name."),(0,r.kt)("li",{parentName:"ul"},"Horizontal scaling (using multiple nodes of Centrifugo, for example with ",(0,r.kt)("a",{parentName:"li",href:"https://centrifugal.dev/docs/server/engines#redis-engine"},"Redis Engine"),") \u2013 mostly one line in Centrifugo config if you have Redis running."),(0,r.kt)("li",{parentName:"ul"},"Gracefully handle temporary disconnects by loading missed messages from the database or Centrifugo channel history cache."),(0,r.kt)("li",{parentName:"ul"},"Optionally replace connect proxy with ",(0,r.kt)("a",{parentName:"li",href:"https://centrifugal.dev/docs/server/authentication"},"JWT authentication")," to reduce HTTP calls from Centrifugo to Laravel. This may drastically reduce resources for Laravel backend at scale."),(0,r.kt)("li",{parentName:"ul"},"Try using ",(0,r.kt)("a",{parentName:"li",href:"https://centrifugal.dev/docs/server/proxy#rpc-proxy"},"Centrifugo RPC proxy")," feature to use WebSocket connection for message publish instead of issuing AJAX request.")),(0,r.kt)("h2",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"We built a chat app with Laravel and Centrifugo. While there is still an area for improvements, this example is not really the basic. It's already valuable in the current form and may be transformed into part of your production system with minimal tweaks."),(0,r.kt)("p",null,"Hope you enjoyed this tutorial. If you have any questions after reading \u2013 join our ",(0,r.kt)("a",{parentName:"p",href:"/docs/getting-started/introduction#join-community"},"community channels"),". We touched only part of Centrifugo concepts here \u2013 take a look at detailed Centrifugo docs nearby. And let the Centrifugal force be with you!"))}u.isMDXComponent=!0},2717:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/laravel_centrifugo-0ccb001662ef66c6d19abca6208e8966.jpg"},7199:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/laravel_main_page-c3e70ae9857eefd3ca4fcd9999a7962c.jpg"}}]);