"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[3117],{53906:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>h});var c=n(85893),i=n(11151);const a={id:"channel_cache_empty",sidebar_label:"Cache empty events",title:"Channel cache empty events"},s=void 0,r={id:"pro/channel_cache_empty",title:"Channel cache empty events",description:'Centrifugo PRO can notify the backend when a client subscribes to the channel using cache recovery mode, but there is no latest publication found in the history stream to load the initial state \u2013 i.e. in the case of "cache miss" event. The backend may react to the event and populate the cache by publishing the current state to the channel.',source:"@site/docs/pro/channel_cache_empty.md",sourceDirName:"pro",slug:"/pro/channel_cache_empty",permalink:"/docs/pro/channel_cache_empty",draft:!1,unlisted:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/pro/channel_cache_empty.md",tags:[],version:"current",frontMatter:{id:"channel_cache_empty",sidebar_label:"Cache empty events",title:"Channel cache empty events"},sidebar:"Pro",previous:{title:"Channel state events",permalink:"/docs/pro/channel_state_events"},next:{title:"Channel capabilities",permalink:"/docs/pro/capabilities"}},o={},h=[{value:"Cache empty proxy",id:"cache-empty-proxy",level:3},{value:"Cache empty request fields",id:"cache-empty-request-fields",level:4},{value:"Cache empty result fields",id:"cache-empty-result-fields",level:4},{value:"Options",id:"options",level:4}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.a)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(t.p,{children:["Centrifugo PRO can notify the backend when a client subscribes to the channel using ",(0,c.jsx)(t.a,{href:"/docs/server/cache_recovery",children:"cache recovery mode"}),', but there is no latest publication found in the history stream to load the initial state \u2013 i.e. in the case of "cache miss" event. The backend may react to the event and populate the cache by publishing the current state to the channel.']}),"\n",(0,c.jsxs)(t.p,{children:['This is done by configuring "cache empty" proxy. It\'s similar to proxies described in ',(0,c.jsx)(t.a,{href:"/docs/server/proxy",children:"Proxy events to the backend"})," chapter, but acts without client connection context \u2013 because it's related to a channel in general, and a particular client who triggered the cache miss is not important."]}),"\n",(0,c.jsx)(t.h3,{id:"cache-empty-proxy",children:"Cache empty proxy"}),"\n",(0,c.jsx)(t.p,{children:"Add the following options to the configuration file:"}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n  ...\n  "proxy_cache_empty_endpoint": "http://localhost:3000/centrifugo/cache_empty",\n  "proxy_cache_empty_timeout":  "1s"\n}\n'})}),"\n",(0,c.jsx)(t.p,{children:"\u2013 to configure proxy endpoint and timeout."}),"\n",(0,c.jsxs)(t.p,{children:["To actually enable proxy for desired channels you must use ",(0,c.jsx)(t.code,{children:"proxy_cache_empty"})," channel namespace option."]}),"\n",(0,c.jsxs)(t.p,{children:["For example, to enable cache empty proxy for channels without namespace define ",(0,c.jsx)(t.code,{children:"proxy_cache_empty"})," boolean flag on a top configuration level:"]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n  ...\n  "proxy_cache_empty_endpoint": "http://localhost:3000/centrifugo/subscribe",\n  "proxy_cache_empty_timeout":  "1s",\n  "proxy_cache_empty": true\n}\n'})}),"\n",(0,c.jsxs)(t.p,{children:["Or if you want to use it in the namespace ",(0,c.jsx)(t.code,{children:"example"}),":"]}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n  ...\n  "proxy_cache_empty_endpoint": "http://localhost:3000/centrifugo/subscribe",\n  "proxy_cache_empty_timeout":  "1s",\n  "namespaces": [{\n    "name": "example",\n    "proxy_cache_empty": true\n  }]\n}\n'})}),"\n",(0,c.jsx)(t.p,{children:"Payload example sent to app backend in cache empty notification request:"}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n  "channel": "example:index"\n}\n'})}),"\n",(0,c.jsx)(t.p,{children:"Expected response example:"}),"\n",(0,c.jsx)(t.pre,{children:(0,c.jsx)(t.code,{className:"language-json",children:'{\n    "result": {}\n}\n'})}),"\n",(0,c.jsx)(t.p,{children:"If cache empty proxy is defined, but Centrifugo can't reach it \u2013 then subscription request which triggered the event will be rejected with the internal error."}),"\n",(0,c.jsx)(t.h4,{id:"cache-empty-request-fields",children:"Cache empty request fields"}),"\n",(0,c.jsxs)(t.table,{children:[(0,c.jsx)(t.thead,{children:(0,c.jsxs)(t.tr,{children:[(0,c.jsx)(t.th,{children:"Field"}),(0,c.jsx)(t.th,{children:"Type"}),(0,c.jsx)(t.th,{children:"Required"}),(0,c.jsx)(t.th,{children:"Description"})]})}),(0,c.jsx)(t.tbody,{children:(0,c.jsxs)(t.tr,{children:[(0,c.jsx)(t.td,{children:"channel"}),(0,c.jsx)(t.td,{children:"string"}),(0,c.jsx)(t.td,{children:"yes"}),(0,c.jsx)(t.td,{children:"A channel in which cache miss occurred"})]})})]}),"\n",(0,c.jsx)(t.h4,{id:"cache-empty-result-fields",children:"Cache empty result fields"}),"\n",(0,c.jsxs)(t.table,{children:[(0,c.jsx)(t.thead,{children:(0,c.jsxs)(t.tr,{children:[(0,c.jsx)(t.th,{children:"Field"}),(0,c.jsx)(t.th,{children:"Type"}),(0,c.jsx)(t.th,{children:"Required"}),(0,c.jsx)(t.th,{children:"Description"})]})}),(0,c.jsx)(t.tbody,{children:(0,c.jsxs)(t.tr,{children:[(0,c.jsx)(t.td,{children:"populated"}),(0,c.jsx)(t.td,{children:"boolean"}),(0,c.jsx)(t.td,{children:"no"}),(0,c.jsx)(t.td,{children:"Notify Centrifugo that channel cache was populated by the app backend \u2013 in this case Centrifugo will try to recover state one more time"})]})})]}),"\n",(0,c.jsx)(t.h4,{id:"options",children:"Options"}),"\n",(0,c.jsxs)(t.p,{children:[(0,c.jsx)(t.code,{children:"proxy_cache_empty_timeout"})," (duration) config option controls timeout of HTTP POST request sent to app backend. By default ",(0,c.jsx)(t.code,{children:"1s"}),"."]}),"\n",(0,c.jsx)(t.admonition,{type:"tip",children:(0,c.jsxs)(t.p,{children:["It's also possible to use cache empty proxy with in ",(0,c.jsx)(t.a,{href:"/docs/server/proxy#granular-proxy-mode",children:"granular proxy mode"}),". In this case use ",(0,c.jsx)(t.code,{children:"cache_empty_proxy_name"})," namespace option instead of ",(0,c.jsx)(t.code,{children:"proxy_cache_empty"})," to point Centrifugo to the name of proxy to use for the channel namespace."]})})]})}function d(e={}){const{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,c.jsx)(t,{...e,children:(0,c.jsx)(l,{...e})}):l(e)}},11151:(e,t,n)=>{n.d(t,{Z:()=>r,a:()=>s});var c=n(67294);const i={},a=c.createContext(i);function s(e){const t=c.useContext(a);return c.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),c.createElement(a.Provider,{value:t},e.children)}}}]);