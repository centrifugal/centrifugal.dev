"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[1616],{89051:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var o=t(85893),r=t(11151);const i={id:"load_balancing",title:"Load balancing"},a=void 0,s={id:"server/load_balancing",title:"Load balancing",description:"This chapter shows how to deal with persistent connection load balancing.",source:"@site/docs/server/load_balancing.md",sourceDirName:"server",slug:"/server/load_balancing",permalink:"/docs/server/load_balancing",draft:!1,unlisted:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/load_balancing.md",tags:[],version:"current",frontMatter:{id:"load_balancing",title:"Load balancing"},sidebar:"Guides",previous:{title:"Infrastructure tuning",permalink:"/docs/server/infra_tuning"},next:{title:"Client protocol codes",permalink:"/docs/server/codes"}},c={},d=[{value:"Nginx configuration",id:"nginx-configuration",level:2},{value:"Separate domain for Centrifugo",id:"separate-domain-for-centrifugo",level:3},{value:"Embed to a location of web site",id:"embed-to-a-location-of-web-site",level:3},{value:"worker_connections",id:"worker_connections",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"This chapter shows how to deal with persistent connection load balancing."}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsxs)(n.p,{children:["Regardless which reverse proxy / load balancer you are using make sure that you tuned open file limit for its process too since it will also need to handle many persistent connections. See ",(0,o.jsx)(n.a,{href:"/docs/server/infra_tuning",children:"Infrastructure tuning"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"nginx-configuration",children:"Nginx configuration"}),"\n",(0,o.jsx)(n.p,{children:"Although it's possible to use Centrifugo without any reverse proxy before it,\nit's still a good idea to keep Centrifugo behind mature reverse proxy to deal with\nedge cases when handling HTTP/Websocket connections from the wild. Also you probably\nwant some sort of load balancing eventually between Centrifugo nodes so that proxy\ncan be such a balancer too."}),"\n",(0,o.jsxs)(n.p,{children:["In this section we will look at ",(0,o.jsx)(n.a,{href:"http://nginx.org/",children:"Nginx"})," configuration to deploy Centrifugo."]}),"\n",(0,o.jsxs)(n.p,{children:["Minimal Nginx version \u2013 ",(0,o.jsx)(n.strong,{children:"1.3.13"})," because it was the first version that can proxy\nWebsocket connections."]}),"\n",(0,o.jsxs)(n.p,{children:["There are 2 ways: running Centrifugo server as separate service on its own\ndomain or embed it to a location of your website (for example to ",(0,o.jsx)(n.code,{children:"/centrifugo"}),")."]}),"\n",(0,o.jsx)(n.h3,{id:"separate-domain-for-centrifugo",children:"Separate domain for Centrifugo"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"upstream centrifugo {\n    server 127.0.0.1:8000;\n}\n\nmap $http_upgrade $connection_upgrade {\n    default upgrade;\n    ''      close;\n}\n\n#server {\n#\tlisten 80;\n#\tserver_name centrifugo.example.com;\n#\trewrite ^(.*) https://$server_name$1 permanent;\n#}\n\nserver {\n    server_name centrifugo.example.com;\n\n    listen 80;\n\n    #listen 443 ssl;\n    #ssl_protocols TLSv1.2;\n    #ssl_certificate /etc/nginx/ssl/server.crt;\n    #ssl_certificate_key /etc/nginx/ssl/server.key;\n\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    # Only retry if there was a communication error, not a timeout\n    # on the Centrifugo server (to avoid propagating \"queries of death\"\n    # to all frontends)\n    proxy_next_upstream error;\n\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Scheme $scheme;\n    proxy_set_header Host $http_host;\n\n    location /connection {\n        proxy_pass http://centrifugo;\n        proxy_buffering off;\n        keepalive_timeout 65;\n        proxy_read_timeout 60s;\n        proxy_http_version 1.1;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Scheme $scheme;\n        proxy_set_header Host $http_host;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection $connection_upgrade;\n    }\n    \n    location / {\n        proxy_pass http://centrifugo;\n    }\n\n    error_page   500 502 503 504  /50x.html;\n\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"embed-to-a-location-of-web-site",children:"Embed to a location of web site"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"upstream centrifugo {\n    server 127.0.0.1:8000;\n}\n\nmap $http_upgrade $connection_upgrade {\n    default upgrade;\n    ''      close;\n}\n\nserver {\n\n    # ... your web site Nginx config\n\n    location /centrifugo/ {\n        rewrite ^/centrifugo/(.*)        /$1 break;\n        proxy_pass http://centrifugo;\n        proxy_pass_header Server;\n        proxy_set_header Host $http_host;\n        proxy_redirect off;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Scheme $scheme;\n    }\n\n    location /centrifugo/connection {\n        rewrite ^/centrifugo(.*)        $1 break;\n        proxy_pass http://centrifugo;\n        proxy_buffering off;\n        keepalive_timeout 65;\n        proxy_read_timeout 60s;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Scheme $scheme;\n        proxy_set_header Host $http_host;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection $connection_upgrade;\n    }\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"worker_connections",children:"worker_connections"}),"\n",(0,o.jsxs)(n.p,{children:["You may also need to update ",(0,o.jsx)(n.code,{children:"worker_connections"})," option of Nginx:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"events {\n    worker_connections 65535;\n}\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>a});var o=t(67294);const r={},i=o.createContext(r);function a(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);