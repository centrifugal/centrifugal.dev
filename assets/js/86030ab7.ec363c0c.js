"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[6104],{64674:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var t=i(85893),o=i(11151);const s={id:"engine_optimizations",title:"Engine load optimizations"},r=void 0,a={id:"pro/engine_optimizations",title:"Engine load optimizations",description:"Centrifugo PRO comes with several options to reduce load on Engine \u2013 specifically on its history and presence API. This may have a positive effect on CPU resource usage on engine side and a positive effect on operation latencies.",source:"@site/docs/pro/engine_optimizations.md",sourceDirName:"pro",slug:"/pro/engine_optimizations",permalink:"/docs/pro/engine_optimizations",draft:!1,unlisted:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/pro/engine_optimizations.md",tags:[],version:"current",frontMatter:{id:"engine_optimizations",title:"Engine load optimizations"},sidebar:"Pro",previous:{title:"Faster performance",permalink:"/docs/pro/performance"},next:{title:"Message batching control",permalink:"/docs/pro/client_message_batching"}},c={},l=[{value:"Singleflight",id:"singleflight",level:2},{value:"Shared position sync",id:"shared-position-sync",level:2}];function d(e){const n={admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Centrifugo PRO comes with several options to reduce load on Engine \u2013 specifically on its history and presence API. This may have a positive effect on CPU resource usage on engine side and a positive effect on operation latencies."}),"\n",(0,t.jsx)(n.h2,{id:"singleflight",children:"Singleflight"}),"\n",(0,t.jsxs)(n.p,{children:["Centrifugo PRO provides an additional boolean option ",(0,t.jsx)(n.code,{children:"use_singleflight"})," (default ",(0,t.jsx)(n.code,{children:"false"}),"). When this option enabled Centrifugo will automatically try to merge identical requests to history, online presence or presence stats issued at the same time into one real network request. It will do this by using in-memory component called ",(0,t.jsx)(n.code,{children:"singleflight"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Singleflight",src:i(11117).Z+"",width:"4259",height:"858"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:"While it can seem similar, singleflight is not a cache. It only combines identical parallel requests into one. If requests come one after another \u2013 they will be sent separately to the broker or presence storage."})}),"\n",(0,t.jsx)(n.p,{children:"This option can radically reduce a load on a broker in the following situations:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Many clients subscribed to the same channel and in case of massive reconnect scenario try to access history simultaneously to restore a state (whether manually using history API or over automatic recovery feature)"}),"\n",(0,t.jsx)(n.li,{children:"Many clients subscribed to the same channel and positioning feature is on so Centrifugo tracks client position"}),"\n",(0,t.jsx)(n.li,{children:"Many clients subscribed to the same channel and in case of massive reconnect scenario try to call presence or presence stats simultaneously"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Using this option only makes sense with remote engine (Redis, KeyDB, Tarantool), it won't provide a benefit in case of using a Memory engine."}),"\n",(0,t.jsx)(n.p,{children:"To enable:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n    ...\n    "use_singleflight": true\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Or via ",(0,t.jsx)(n.code,{children:"CENTRIFUGO_USE_SINGLEFLIGHT"})," environment variable."]}),"\n",(0,t.jsx)(n.h2,{id:"shared-position-sync",children:"Shared position sync"}),"\n",(0,t.jsx)(n.p,{children:"Shared position synchronization feature allows reducing the load on the broker from position synchronization requests in channels with many subscribers and positioning/recovery enabled."}),"\n",(0,t.jsx)(n.p,{children:"Centrifugo uses periodic position synchronization requests to make sure there was no message loss between Engine PUB/SUB and Centrifugo. These requests create additional load on broker."}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"shared_position_sync"})," is enabled subscribers use an intermediary cache to only send position requests to the broker if another channel subscriber have not done it recently. So the benefit here is proportional to the number of channel subscribers on Centrifugo node."]}),"\n",(0,t.jsxs)(n.p,{children:["To enable in the specific channel namespace use boolean channel option ",(0,t.jsx)(n.code,{children:"shared_position_sync"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n    "namespaces": [\n        {\n            "name": "example",\n            "force_recovery": true,\n            "shared_position_sync": true\n        }\n    ]\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},11117:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/singleflight-35650f07c8cda65fec55fd490157a6a0.png"},11151:(e,n,i)=>{i.d(n,{Z:()=>a,a:()=>r});var t=i(67294);const o={},s=t.createContext(o);function r(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);