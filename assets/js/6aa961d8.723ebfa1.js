"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[3321],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>d});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),p=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=p(r),d=a,g=m["".concat(s,".").concat(d)]||m[d]||c[d]||o;return r?n.createElement(g,i(i({ref:t},u),{},{components:r})):n.createElement(g,i({ref:t},u))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<o;p++)i[p]=r[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},4280:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=r(7462),a=(r(7294),r(3905));const o={id:"observability",title:"Server observability"},i=void 0,l={unversionedId:"server/observability",id:"server/observability",title:"Server observability",description:"To provide a better server observability Centrifugo supports reporting metrics in Prometheus format and can automatically export metrics to Graphite.",source:"@site/docs/server/observability.md",sourceDirName:"server",slug:"/server/observability",permalink:"/docs/server/observability",draft:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/observability.md",tags:[],version:"current",frontMatter:{id:"observability",title:"Server observability"},sidebar:"Guides",previous:{title:"Admin web UI",permalink:"/docs/server/admin_web"},next:{title:"Infrastructure tuning",permalink:"/docs/server/infra_tuning"}},s={},p=[{value:"Metrics",id:"metrics",level:2},{value:"Prometheus metrics",id:"prometheus-metrics",level:3},{value:"Graphite metrics",id:"graphite-metrics",level:3},{value:"Grafana dashboard",id:"grafana-dashboard",level:3},{value:"Traces",id:"traces",level:2},{value:"OpenTelemetry",id:"opentelemetry",level:3},{value:"Logs",id:"logs",level:2}],u={toc:p};function c(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"To provide a better server observability Centrifugo supports reporting metrics in Prometheus format and can automatically export metrics to Graphite."),(0,a.kt)("h2",{id:"metrics"},"Metrics"),(0,a.kt)("h3",{id:"prometheus-metrics"},"Prometheus metrics"),(0,a.kt)("p",null,"To enable Prometheus endpoint start Centrifugo with ",(0,a.kt)("inlineCode",{parentName:"p"},"prometheus")," option on:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="config.json"',title:'"config.json"'},'{\n    ...\n    "prometheus": true\n}\n')),(0,a.kt)("p",null,"This will enable ",(0,a.kt)("inlineCode",{parentName:"p"},"/metrics")," endpoint so the Centrifugo instance can be monitored by your Prometheus server."),(0,a.kt)("h3",{id:"graphite-metrics"},"Graphite metrics"),(0,a.kt)("p",null,"To enable automatic export to Graphite (via TCP):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="config.json"',title:'"config.json"'},'{\n    ...\n    "graphite": true,\n    "graphite_host": "localhost",\n    "graphite_port": 2003\n}\n')),(0,a.kt)("p",null,"By default, stats will be aggregated over 10 seconds intervals inside Centrifugo and then pushed to Graphite over TCP connection."),(0,a.kt)("p",null,"If you need to change this aggregation interval use the ",(0,a.kt)("inlineCode",{parentName:"p"},"graphite_interval")," option (in seconds, default ",(0,a.kt)("inlineCode",{parentName:"p"},"10"),")."),(0,a.kt)("h3",{id:"grafana-dashboard"},"Grafana dashboard"),(0,a.kt)("p",null,"Check out Centrifugo ",(0,a.kt)("a",{parentName:"p",href:"https://grafana.com/grafana/dashboards/13039"},"official Grafana dashboard")," for Prometheus storage. You can import that dashboard to your Grafana, point to Prometheus storage \u2013 and enjoy visualized metrics."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://grafana.com/api/dashboards/13039/images/8950/image",alt:null})),(0,a.kt)("h2",{id:"traces"},"Traces"),(0,a.kt)("h3",{id:"opentelemetry"},"OpenTelemetry"),(0,a.kt)("p",null,"At this point Centrifugo can export traces for HTTP and GRPC server API requests in OpenTelemetry format."),(0,a.kt)("p",null,"To enable:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "opentelemetry": true,\n  "opentelemetry_api": true\n}\n')),(0,a.kt)("p",null,"OpenTelemetry must be explicitly turned on to avoid tracing overhead when it's not needed."),(0,a.kt)("p",null,"To configure OpenTelemetry export behaviour we are relying on ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/docs/concepts/sdk-configuration/otlp-exporter-configuration/"},"OpenTelemetry environment vars")," supporting only HTTP export endpoints for now."),(0,a.kt)("p",null,"So a simple example to run Centrifugo with server API tracing would be running Jaeger with ",(0,a.kt)("inlineCode",{parentName:"p"},"COLLECTOR_OTLP_ENABLED"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"docker run --rm -it --name jaeger \\\n  -e COLLECTOR_OTLP_ENABLED=true \\\n  -p 16686:16686 \\\n  -p 4318:4318 \\\n  jaegertracing/all-in-one:latest\n")),(0,a.kt)("p",null,"Then start Centrifugo:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4318" CENTRIFUGO_OPENTELEMETRY=1 CENTRIFUGO_OPENTELEMETRY_API=1 ./centrifugo\n')),(0,a.kt)("p",null,"Send some API requests - and open ",(0,a.kt)("a",{parentName:"p",href:"http://localhost:16686"},"http://localhost:16686")," to see traces in Jaeger UI."),(0,a.kt)("h2",{id:"logs"},"Logs"),(0,a.kt)("p",null,"Logging may be configured using ",(0,a.kt)("inlineCode",{parentName:"p"},"log_level")," option. It may have the following values:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"none")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"trace")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"debug")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"info")," (default)"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"warn")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"error"))),(0,a.kt)("p",null,"We generally do not recommend anything below info to be used in production."),(0,a.kt)("p",null,"By default Centrifugo logs to STDOUT. Usually this is what you need when running servers on modern infrastructures. Logging into file may be configured using ",(0,a.kt)("inlineCode",{parentName:"p"},"log_file")," option."))}c.isMDXComponent=!0}}]);