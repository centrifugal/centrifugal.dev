"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[4658],{11222:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"getting-started/migration_v4","title":"Migrating to v4","description":"Centrifugo v4 development was concentrated around two main things:","source":"@site/docs/getting-started/migration-v4.md","sourceDirName":"getting-started","slug":"/getting-started/migration_v4","permalink":"/docs/getting-started/migration_v4","draft":false,"unlisted":false,"editUrl":"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/getting-started/migration-v4.md","tags":[],"version":"current","frontMatter":{"id":"migration_v4","title":"Migrating to v4"}}');var t=o(74848),r=o(28453),s=o(28921);const a={id:"migration_v4",title:"Migrating to v4"},c=void 0,l={},d=[{value:"Client SDK migration",id:"client-sdk-migration",level:2},{value:"Unidirectional transport migration",id:"unidirectional-transport-migration",level:2},{value:"SockJS migration",id:"sockjs-migration",level:2},{value:"Channel ASCII enforced",id:"channel-ascii-enforced",level:2},{value:"Subscription token migration",id:"subscription-token-migration",level:2},{value:"User-limited channel migration",id:"user-limited-channel-migration",level:2},{value:"Namespace configuration migration",id:"namespace-configuration-migration",level:2},{value:"Proxy disconnect code changes",id:"proxy-disconnect-code-changes",level:2},{value:"Other configuration option changes",id:"other-configuration-option-changes",level:2},{value:"Server API changes",id:"server-api-changes",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Centrifugo v4 development was concentrated around two main things:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"adopt a new generation of client protocol"}),"\n",(0,t.jsx)(n.li,{children:"make namespaces secure by default"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"These goals dictate most of backwards compatibility changes in v4."}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:"What we would like to emphasize is that even there are many backwards incompatible changes it should be possible to migrate to Centrifugo v4 server without changing your client-side code at all. And then gradually upgrade the client-side. Below we are giving all the tips to achieve this."})}),"\n",(0,t.jsx)(n.h2,{id:"client-sdk-migration",children:"Client SDK migration"}),"\n",(0,t.jsx)(n.p,{children:"New generation of client protocol requires using the latest versions of client SDKs. During the next several days we will release the following SDK versions which are compatible with Centrifugo v4:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"centrifuge-js >= v3.0.0"}),"\n",(0,t.jsx)(n.li,{children:"centrifuge-go >= v0.9.0"}),"\n",(0,t.jsx)(n.li,{children:"centrifuge-dart >= v0.9.0"}),"\n",(0,t.jsx)(n.li,{children:"centrifuge-swift >= v0.5.0"}),"\n",(0,t.jsx)(n.li,{children:"centrifuge-java >= v0.2.0"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["New client SDKs ",(0,t.jsx)(n.strong,{children:"support only new client protocol"})," \u2013 you can not connect to Centrifugo v3 with them."]}),"\n",(0,t.jsx)(n.p,{children:"If you have a production system where you want to upgrade Centrifugo from v3 to v4 then the plan is:"}),"\n",(0,t.jsx)(n.admonition,{type:"danger",children:(0,t.jsxs)(n.p,{children:["If you are using private channels (starting with ",(0,t.jsx)(n.code,{children:"$"}),") or user-limited channels (containing ",(0,t.jsx)(n.code,{children:"#"}),") then carefully read about subscription token migration and user-limited channels migration below."]})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Upgrade Centrifugo and its configuration to adopt changes in v4."}),"\n",(0,t.jsxs)(n.li,{children:["In Centrifugo v4 config turn on ",(0,t.jsx)(n.code,{children:"use_client_protocol_v1_by_default"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Run Centrifugo v4 \u2013 all current clients should continue working with it."}),"\n",(0,t.jsxs)(n.li,{children:["Then on the client-side uprade client SDK version to the one which works with Centrifugo v4, adopt changes in SDK API dictated by our new ",(0,t.jsx)(n.a,{href:"/docs/transports/client_api",children:"client SDK API spec"}),". ",(0,t.jsx)(n.strong,{children:"Important thing"})," \u2013 add ",(0,t.jsx)(n.code,{children:"?cf_protocol_version=v2"})," URL param to the connection endpoint to tell Centrifugo that modern generation of protocol is being used by the connection (otherwise, it assumes old protocol since we have ",(0,t.jsx)(n.code,{children:"use_client_protocol_v1_by_default"})," option enabled)."]}),"\n",(0,t.jsxs)(n.li,{children:["As soon as all your clients migrated to use new protocol generation you can remove ",(0,t.jsx)(n.code,{children:"use_client_protocol_v1_by_default"})," option from the server configuration."]}),"\n",(0,t.jsxs)(n.li,{children:["After that you can remove ",(0,t.jsx)(n.code,{children:"?cf_protocol_version=v2"})," from connection endpoint on the client-side."]}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:"If you are using mobile client SDKs then most probably some time must pass while clients update their apps to use an updated Centrifugo SDK version."})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["Starting from Centrifugo v4.1.1 it's possible to completely turn off client protocol v1 by setting ",(0,t.jsx)(n.code,{children:"disable_client_protocol_v1"})," boolean option to ",(0,t.jsx)(n.code,{children:"true"}),"."]})}),"\n",(0,t.jsx)(n.h2,{id:"unidirectional-transport-migration",children:"Unidirectional transport migration"}),"\n",(0,t.jsx)(n.p,{children:"Client protocol framing also changed in unidirectional transports. The good news is that Centrifugo v4 still supports previous format for unidirectional transports."}),"\n",(0,t.jsxs)(n.p,{children:["When you are enabling ",(0,t.jsx)(n.code,{children:"use_client_protocol_v1_by_default"})," option described above you also make unidirectional transports to work over old protocol format. So your existing clients will continue working just fine with Centrifugo v4. Then the same steps to migrate described above can be applied to unidirectional transport case. The only difference that in unidirectional approach you are not using Centrifugo SDKs."]}),"\n",(0,t.jsx)(n.h2,{id:"sockjs-migration",children:"SockJS migration"}),"\n",(0,t.jsx)(n.p,{children:"SockJS is now DEPRECATED in Centrifugo. Centrifugo v4 may be the last release which supports it. We now offer our own bidirectional emulation layer on top of HTTP-streaming and EventSource. See additional information in Centrifugo v4 introduction post."}),"\n",(0,t.jsx)(n.h2,{id:"channel-ascii-enforced",children:"Channel ASCII enforced"}),"\n",(0,t.jsxs)(n.p,{children:["Centrifugo v2 and v3 docs mentioned the fact that channels must contain only ASCII characters. But it was not actually enforced by a server. Now Centrifugo is more strict. If a channel has non-ASCII characters then the ",(0,t.jsx)(n.code,{children:"107: bad request"})," error will be returned to the client. Please reach us out if this behavior is not suitable for your use case \u2013 we can discuss the use case and think on a proper solution together."]}),"\n",(0,t.jsx)(n.h2,{id:"subscription-token-migration",children:"Subscription token migration"}),"\n",(0,t.jsxs)(n.p,{children:["Subscription token now requires ",(0,t.jsx)(n.code,{children:"sub"})," claim (current user ID) to be set."]}),"\n",(0,t.jsxs)(n.p,{children:["In most cases the only change which is required to smoothly migrate to v4 without breaking things is to add a boolean option ",(0,t.jsx)(n.code,{children:'"skip_user_check_in_subscription_token": true'})," to a Centrifugo v4 configuration. This skips the check of ",(0,t.jsx)(n.code,{children:"sub"})," claim to contain the current user ID set to a connection during authentication."]}),"\n",(0,t.jsxs)(n.p,{children:["After that start adding ",(0,t.jsx)(n.code,{children:"sub"})," claim (with current user ID) to subscription tokens. As soon as all subscription tokens in your system contain user ID in ",(0,t.jsx)(n.code,{children:"sub"})," claim you can remove the ",(0,t.jsx)(n.code,{children:"skip_user_check_in_subscription_token"})," from a server configuration."]}),"\n",(0,t.jsxs)(n.p,{children:["One more important note is that ",(0,t.jsx)(n.code,{children:"client"})," claim in subscription token in Centrifugo v4 only supported for backwards compatibility. It must not be included into new subscription tokens."]}),"\n",(0,t.jsxs)(n.p,{children:["It's worth mentioning that Centrifugo v4 does not allow subscribing on channels starting with ",(0,t.jsx)(n.code,{children:"$"})," without token even if namespace marked as available for subscribing using sth like ",(0,t.jsx)(n.code,{children:"allow_subscribe_for_client"})," option. This is done to prevent potential security risk during v3 -> v4 migration when client previously not available to subscribe to channels starting with ",(0,t.jsx)(n.code,{children:"$"})," in any case may get permissions to do so."]}),"\n",(0,t.jsx)(n.h2,{id:"user-limited-channel-migration",children:"User-limited channel migration"}),"\n",(0,t.jsxs)(n.p,{children:["User-limited channel support should now be allowed over a separate channel namespace option ",(0,t.jsx)(n.code,{children:"allow_user_limited_channels"}),". See below the namespace option converter which takes this change into account."]}),"\n",(0,t.jsx)(n.h2,{id:"namespace-configuration-migration",children:"Namespace configuration migration"}),"\n",(0,t.jsxs)(n.p,{children:["In Centrifugo v4 namespace configuration options have been changed. Centrifugo now has ",(0,t.jsx)(n.code,{children:"secure by default"})," namespaces. First thing to do is to read the new docs about ",(0,t.jsx)(n.a,{href:"/docs/server/channels",children:"channels and namespaces"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Then you can use the following converter which will transform your old namespace configuration to a new one. This converter tries to keep backwards compatibility \u2013 i.e. it should be possible to deploy Centrifugo with namespace configuration from converter output and have the same behaviour as before regarding channel permissions. We believe that new option names should provide a more readable configuration and may help to reveal some potential security improvements in your namespace configuration \u2013 i.e. making it more strict and protective."}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsx)(n.p,{children:"Do not blindly deploy things to production \u2013 test your system first, go through the possible usage scenarios and/or test cases."})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:"It's fully client-side: your data won't be sent anywhere."})}),"\n","\n",(0,t.jsx)(s.A,{}),"\n",(0,t.jsx)(n.h2,{id:"proxy-disconnect-code-changes",children:"Proxy disconnect code changes"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"reconnect"})," flag from custom disconnect code is removed. Reconnect advice is now determined by disconnect code value. This allowed us avoiding using JSON in WebSocket CLOSE frame reason. See ",(0,t.jsx)(n.a,{href:"/docs/server/proxy#return-custom-disconnect",children:"proxy docs"})," docs for more details."]}),"\n",(0,t.jsx)(n.h2,{id:"other-configuration-option-changes",children:"Other configuration option changes"}),"\n",(0,t.jsx)(n.p,{children:"Several other non-namespace related options have been renamed or removed:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"client_anonymous"})," option renamed to ",(0,t.jsx)(n.code,{children:"allow_anonymous_connect_without_token"})," \u2013 new name better describes the purpose of this option which was previously not clear. Converter above takes this into account."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"use_unlimited_history_by_default"})," option was removed. It was used to help migrating from Centrifugo v2 to v3."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"server-api-changes",children:"Server API changes"}),"\n",(0,t.jsxs)(n.p,{children:["The only breaking change is that ",(0,t.jsx)(n.code,{children:"user_connections"})," API method (which is available in Centrifugo PRO only) was renamed to ",(0,t.jsx)(n.code,{children:"connections"}),". The method is more generic now with a broader possibilities \u2013 so previous name does not match the current behavior."]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},28453:(e,n,o)=>{o.d(n,{R:()=>s,x:()=>a});var i=o(96540);const t={},r=i.createContext(t);function s(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),i.createElement(r.Provider,{value:n},e.children)}},28921:(e,n,o)=>{o.d(n,{A:()=>r});var i=o(96540),t=o(74848);class r extends i.Component{constructor(){super(),this.onChange=this.onChange.bind(this),this.onClick=this.onClick.bind(this),this.state={config:null,output:"Here will be configuration for v4",logs:"Here will be log of changes made in your config"}}onClick(e){if(!this.state.config)return void alert("Provide a configuration");let n;try{n=JSON.parse(this.state.config)}catch{return void alert("Invalid JSON")}let o=[],i=[],t=function(e){let n="config top-level";return void 0!==e&&(n="namespace {"+e.name+"}"),n},r=function(e,r,s){i.push("`"+e+"` renamed to `"+r+"`");let a=t(s);void 0===s&&(s=n),void 0===s[r]&&void 0!==s[e]&&(s[r]=s[e],delete s[e],o.push("renamed "+e+" to "+r+" in "+a))},s=function(e,r){i.push("`"+e+"` removed");let s=t(r);void 0===r&&(r=n),void 0!==r[e]&&(delete r[e],o.push("removed "+e+" from "+s))},a=function(e,r,s){i.push("`"+e+"` is now required");let a=t(s);void 0===s&&(s=n),void 0===s[e]&&(s[e]=r,o.push("added "+e+" to "+a))};s("use_unlimited_history_by_default"),r("client_anonymous","allow_anonymous_connect_without_token");let c=n;if(a("allow_user_limited_channels",!0),!0===c.protected?s("protected"):(a("allow_subscribe_for_client",!0),r("anonymous","allow_subscribe_for_anonymous")),!0===c.publish&&(r("publish","allow_publish_for_client"),a("allow_publish_for_anonymous",!0)),!0===c.presence&&(!0===c.presence_disabled_for_client?s("presence_disabled_for_client"):(a("allow_presence_for_subscriber",!0),a("allow_presence_for_anonymous",!0))),void 0!==c.history_ttl&&void 0!==c.history_size&&(!0===c.history_disabled_for_client?s("history_disabled_for_client"):(a("allow_history_for_subscriber",!0),a("allow_history_for_anonymous",!0))),!0===c.position?r("position","force_positioning"):s("position"),!0===c.recover?r("recover","force_recovery"):s("recover"),!0===c.join_leave&&a("force_push_join_leave",!0),void 0!==n.namespaces){let e=[];for(let o of n.namespaces)a("allow_user_limited_channels",!0,o),!0===o.protected?s("protected",o):(a("allow_subscribe_for_client",!0,o),r("anonymous","allow_subscribe_for_anonymous",o)),!0===o.publish&&(r("publish","allow_publish_for_client",o),a("allow_publish_for_anonymous",!0,o)),!0===o.presence&&(!0===o.presence_disabled_for_client?s("presence_disabled_for_client",o):(a("allow_presence_for_subscriber",!0,o),a("allow_presence_for_anonymous",!0,o))),void 0!==o.history_ttl&&void 0!==o.history_size&&(!0===o.history_disabled_for_client?s("history_disabled_for_client",o):(a("allow_history_for_subscriber",!0,o),a("allow_history_for_anonymous",!0,o))),!0===o.position?r("position","force_positioning",o):s("position",o),!0===o.recover?r("recover","force_recovery",o):s("recover",o),!0===o.join_leave&&a("force_push_join_leave",!0),e.push(o);n.namespaces=e}this.setState({output:JSON.stringify(n,null,"\t")}),this.setState({logs:JSON.stringify(o,null,"\t")}),console.log(i.join("\n\n"))}onChange(e){this.setState({config:e.target.value})}render(){return(0,t.jsxs)("div",{children:[(0,t.jsx)("textarea",{onChange:this.onChange,placeholder:"Paste your Centrifugo v3 JSON config here...",style:{width:"100%",height:"300px",border:"2px solid #ccc"}}),(0,t.jsx)("button",{onClick:this.onClick,children:"Convert"}),(0,t.jsx)("pre",{style:{marginTop:"10px"},children:this.state.output}),(0,t.jsx)("pre",{style:{marginTop:"10px"},children:this.state.logs})]})}}}}]);