"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[1635],{81318:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var t=o(85893),a=o(11151);const r={id:"monitoring",sidebar_label:"Appx #3: Prometheus and Grafana",title:"Appendix #3: Adding Prometheus and Grafana"},i=void 0,s={id:"tutorial/monitoring",title:"Appendix #3: Adding Prometheus and Grafana",description:"Let's move a bit further and show how to add Centrifugo monitoring to our messenger application. We will use Prometheus and Grafana for this.",source:"@site/docs/tutorial/monitoring.md",sourceDirName:"tutorial",slug:"/tutorial/monitoring",permalink:"/docs/tutorial/monitoring",draft:!1,unlisted:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/tutorial/monitoring.md",tags:[],version:"current",frontMatter:{id:"monitoring",sidebar_label:"Appx #3: Prometheus and Grafana",title:"Appendix #3: Adding Prometheus and Grafana"},sidebar:"Tutorial",previous:{title:"Appx #2: Tips and tricks",permalink:"/docs/tutorial/tips_and_tricks"},next:{title:"Appx #4: Adding push notifications",permalink:"/docs/tutorial/push_notifications"}},c={},d=[{value:"Prometheus",id:"prometheus",level:2},{value:"Grafana",id:"grafana",level:2},{value:"We did it again",id:"we-did-it-again",level:2}];function l(e){const n={a:"a",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",strong:"strong",...(0,a.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Let's move a bit further and show how to add Centrifugo monitoring to our messenger application. We will use Prometheus and Grafana for this."}),"\n",(0,t.jsx)(n.h2,{id:"prometheus",children:"Prometheus"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://prometheus.io/",children:"Prometheus"})," is a popular monitoring system and time series database. It collects metrics from monitored targets by scraping metrics HTTP endpoints. Centrifugo has built-in support for Prometheus metrics."]}),"\n",(0,t.jsxs)(n.p,{children:["The first step would be adding Prometheus service to our ",(0,t.jsx)(n.code,{children:"docker-compose.yml"})," file. We will use the official Prometheus Docker image. Here is how the service definition looks like:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="docker-compose.yml"',children:"  prometheus:\n    image: prom/prometheus:v3.0.1\n    volumes:\n      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n    ports:\n      - 9090:9090\n"})}),"\n",(0,t.jsxs)(n.p,{children:["We also need to create a ",(0,t.jsx)(n.code,{children:"prometheus.yml"})," file in the root of our project. Here is how it looks like:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="prometheus/prometheus.yml"',children:"global:\n  scrape_interval: 5s\n\nscrape_configs:\n  - job_name: 'centrifugo'\n    static_configs:\n      - targets: ['centrifugo:8000']\n"})}),"\n",(0,t.jsx)(n.p,{children:"This configuration tells Prometheus to scrape metrics from Centrifugo container every 5 seconds."}),"\n",(0,t.jsx)(n.p,{children:"In Centrifugo configuration we also need to enable Prometheus metrics endpoint. Here is how it looks like:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n    ...\n    "prometheus": {\n        "enabled": true\n    }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Now once you start the app with ",(0,t.jsx)(n.code,{children:"docker compose up"})," you can open Prometheus UI at ",(0,t.jsx)(n.a,{href:"http://localhost:9090",children:"http://localhost:9090"})," and see Centrifugo metrics."]}),"\n",(0,t.jsx)(n.h2,{id:"grafana",children:"Grafana"}),"\n",(0,t.jsxs)(n.p,{children:["Many users prefer to use ",(0,t.jsx)(n.a,{href:"https://grafana.com/",children:"Grafana"})," for visualizing metrics collected by Prometheus. Let's add Grafana service to our ",(0,t.jsx)(n.code,{children:"docker-compose.yml"})," file. We will use the official Grafana Docker image. Here is how the service definition looks like:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="docker-compose.yml"',children:'  grafana:\n    image: grafana/grafana-oss:11.4.0\n    depends_on:\n      - prometheus\n    # Expose Grafana on host port 3000\n    ports:\n      - "3000:3000"\n    environment:\n      - GF_SECURITY_ADMIN_USER=admin\n      - GF_SECURITY_ADMIN_PASSWORD=admin\n    volumes:\n      # Mount local provisioning directory to automatically configure Prometheus as a datasource\n      - ./grafana/provisioning:/etc/grafana/provisioning\n      - grafana-data:/var/lib/grafana\n'})}),"\n",(0,t.jsxs)(n.p,{children:["We also need to create a ",(0,t.jsx)(n.code,{children:"datasource.yml"})," file in the ",(0,t.jsx)(n.code,{children:"grafana/provisioning/datasources"})," directory. Here is how it looks like:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="grafana/provisioning/datasources/datasource.yml"',children:"apiVersion: 1\n\ndatasources:\n  - name: Prometheus\n    type: prometheus\n    url: http://prometheus:9090\n    access: proxy\n    isDefault: true\n"})}),"\n",(0,t.jsx)(n.p,{children:"This configuration tells Grafana to use Prometheus as a default datasource."}),"\n",(0,t.jsxs)(n.p,{children:["Now once you start the app with ",(0,t.jsx)(n.code,{children:"docker compose up"})," you can open Grafana UI at ",(0,t.jsx)(n.a,{href:"http://localhost:3000",children:"http://localhost:3000"})," and login with ",(0,t.jsx)(n.code,{children:"admin"}),"/",(0,t.jsx)(n.code,{children:"admin"})," credentials."]}),"\n",(0,t.jsxs)(n.p,{children:["Then you can simply import Centrifugo ",(0,t.jsx)(n.a,{href:"https://grafana.com/grafana/dashboards/13039",children:"official Grafana dashboard"}),". To import a dashboard in Grafana go to ",(0,t.jsx)(n.a,{href:"http://localhost:3000/dashboards",children:"http://localhost:3000/dashboards"}),", click on the ",(0,t.jsx)(n.code,{children:"New"})," button in the top-right corner and select ",(0,t.jsx)(n.code,{children:"Import"}),". Then you need to put the dashboard ID (",(0,t.jsx)(n.code,{children:"13039"}),") into the form and click ",(0,t.jsx)(n.code,{children:"Load"}),". After that ",(0,t.jsx)(n.strong,{children:"select Prometheus as a datasource"})," for the dashboard and click ",(0,t.jsx)(n.code,{children:"Import"}),". And enjoy visualized metrics:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:o(53578).Z+"",width:"2818",height:"1432"})}),"\n",(0,t.jsx)(n.p,{children:"That's it! Now you have Centrifugo metrics visualized in the application. You can even use Grafana alerting feature to notify you over tons of supported communication channels (Slack, email, and so on) in case of metric changes."}),"\n",(0,t.jsx)(n.h2,{id:"we-did-it-again",children:"We did it again"}),"\n",(0,t.jsx)(n.p,{children:"Here we showed how to add Prometheus and Grafana to our messenger application to monitor Centrifugo metrics."}),"\n",(0,t.jsx)(n.p,{children:"In real-world applications the way of Prometheus and Grafana setup can be different, but the core idea is the same. For example, in Kubernetes you can use Helm charts to deploy Prometheus and Grafana stack and use k8s service discovery to find Centrifugo instances."}),"\n",(0,t.jsxs)(n.p,{children:["For the convenience we've included Prometheus and Grafana support to ",(0,t.jsx)(n.a,{href:"https://github.com/centrifugal/grand-chat-tutorial",children:"the source code"})," of our tutorial, so it works out of the box, but you need to import Grafana dashboard manually in a way described above."]})]})}function h(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},53578:(e,n,o)=>{o.d(n,{Z:()=>t});const t=o.p+"assets/images/grafana-60e3752feb2b89948665543a4c2d9661.jpg"},11151:(e,n,o)=>{o.d(n,{Z:()=>s,a:()=>i});var t=o(67294);const a={},r=t.createContext(a);function i(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);