"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[1202],{78460:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var t=r(85893),s=r(11151);const i={id:"cache_recovery",sidebar_label:"Cache recovery mode",title:"Cache recovery mode"},o=void 0,c={id:"server/cache_recovery",title:"Cache recovery mode",description:"Cache recovery mode in channels is designed to quickly deliver the most recent (latest) publication as the first event to the subscriber right after subscription request. This functionality allows Centrifugo channels to behave as a real-time key-value store. The feature is available since Centrifugo v5.4.0.",source:"@site/docs/server/cache_recovery.md",sourceDirName:"server",slug:"/server/cache_recovery",permalink:"/docs/server/cache_recovery",draft:!1,unlisted:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/cache_recovery.md",tags:[],version:"current",frontMatter:{id:"cache_recovery",sidebar_label:"Cache recovery mode",title:"Cache recovery mode"},sidebar:"Guides",previous:{title:"History and recovery",permalink:"/docs/server/history_and_recovery"},next:{title:"Delta compression",permalink:"/docs/server/delta_compression"}},a={},l=[{value:"Using cache recovery mode",id:"using-cache-recovery-mode",level:3},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Cache recovery mode in channels is designed to quickly deliver the most recent (latest) publication as the first event to the subscriber right after subscription request. This functionality allows Centrifugo channels to behave as a real-time key-value store. The feature is available ",(0,t.jsx)(n.strong,{children:"since Centrifugo v5.4.0"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Cache recovery mode works best for channels where every Publication data represents the entire state required to display the real-time element."}),"\n",(0,t.jsx)(n.p,{children:'Cache recovery mode may eliminate the need for the "fetch initial state" stage in many use cases, reducing server load and application complexity. When a client subscribes to a channel with cache recovery mode, it receives the most recent cached value immediately. Also, on every resubscription (due to network issues for example) the latest publication will be also immediately delivered.'}),"\n",(0,t.jsxs)(n.p,{children:["As an example, one of Centrifugo users \u2013 ",(0,t.jsx)(n.a,{href:"https://www.azuracast.com/",children:"AzuraCast"})," web radio station server \u2013 uses such mode for its ",(0,t.jsx)(n.code,{children:"now playing"})," feature, significantly reducing the load on the backend. As another example, check out ",(0,t.jsx)(n.a,{href:"https://x.com/centrifugalabs/status/1790786663884411105",children:"this Twitter/X post"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"using-cache-recovery-mode",children:"Using cache recovery mode"}),"\n",(0,t.jsx)(n.p,{children:"To use cache recovery mode you need to properly configure channel namespace. The following conditions must be met:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Channels have history configured, in most cases ",(0,t.jsx)(n.code,{children:'"history_size": 1'})," makes the most sense"]}),"\n",(0,t.jsxs)(n.li,{children:["Recovery is used, see ",(0,t.jsx)(n.a,{href:"/docs/server/history_and_recovery",children:"history and recovery"})]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.a,{href:"/docs/server/channels#force_recovery_mode",children:"force_recovery_mode"})," string option is set to ",(0,t.jsx)(n.code,{children:"cache"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Configuration example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "channel": {\n    "namespaces": [\n      {\n        "name": "example",\n        "force_recovery": true,\n        "force_recovery_mode": "cache",\n        "history_size": 1,\n        "history_ttl": "1h"\n      }\n    ]\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["After that you need to subscribe to a channel and trigger recovery on first connect. With bidirectional SDKs this may be done by providing an empty ",(0,t.jsx)(n.code,{children:"since"})," object when creating a subscription (under the hood this leads to attaching ",(0,t.jsx)(n.code,{children:"recover: true"})," to the client protocol subscribe request):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"const sub = centrifuge.newSubscription('example:now-playing-12', {\n  since: {}\n});\n\nsub.on('publication', (ctx) => {\n    console.log(ctx);\n})\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Of course you also need to make sure you properly configured channel permissions. Then after successful subscription client will get latest publication in ",(0,t.jsx)(n.code,{children:"publication"})," event."]}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsx)(n.p,{children:"Using cache recovery mode may result into indermediary messages being lost and not delivered, only the latest publication in channel is interesting for it."})}),"\n",(0,t.jsxs)(n.p,{children:["The rest works very similar to stream recovery described in ",(0,t.jsx)(n.a,{href:"/docs/server/history_and_recovery",children:"history and recovery"})," chapter. If there is an error upon using cache and Centrifugo can't receover state providing latest publication \u2013 then ",(0,t.jsx)(n.code,{children:"ctx"})," will contain ",(0,t.jsx)(n.code,{children:"recovered: false"})," flag, and ",(0,t.jsx)(n.code,{children:"true"})," in case of success."]}),"\n",(0,t.jsxs)(n.p,{children:["Note, that history has retention TTL set over ",(0,t.jsx)(n.code,{children:"history_ttl"})," channel option. So in case of retention expired, or maybe in case of restart of Centrifugo node with Memory Engine \u2013 the history is cleaned up, so your application should tolerate the missing value in case of insuccessful recovery."]}),"\n",(0,t.jsxs)(n.p,{children:["Centrifugo PRO provide a feature to configure channel ",(0,t.jsx)(n.a,{href:"/docs/pro/channel_cache_empty",children:"cache empty event proxy"})," to notify your backend about missing publication scenario. So that you can re-populate the channel history with an actual value."]}),"\n",(0,t.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,t.jsx)(n.p,{children:"Cache recovery mode simplifies handling of dynamic data by reducing server requests, ensuring timely updates, and decreasing initial latency."})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},11151:(e,n,r)=>{r.d(n,{Z:()=>c,a:()=>o});var t=r(67294);const s={},i=t.createContext(s);function o(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);