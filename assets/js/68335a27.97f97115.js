"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[3488],{19761:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/server_api_jwks-14a830721773eccdd0222729d3903885.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var i=t(96540);const s={},a=i.createContext(s);function r(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:n},e.children)}},99139:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"pro/server_api_auth","title":"Server API JWKS auth","description":"Centrifugo PRO supports protecting HTTP API and GRPC API with JWKS (JSON Web Key Set) based authentication. This allows you to use JWT tokens issued by your identity provider (like Keycloak, Auth0, or any other OIDC-compliant provider) to authenticate server API requests.","source":"@site/docs/pro/server_api_auth.md","sourceDirName":"pro","slug":"/pro/server_api_auth","permalink":"/docs/pro/server_api_auth","draft":false,"unlisted":false,"editUrl":"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/pro/server_api_auth.md","tags":[],"version":"current","frontMatter":{"id":"server_api_auth","sidebar_label":"Server API JWKS auth","title":"Server API JWKS auth"},"sidebar":"Pro","previous":{"title":"Admin UI: SSO, Snapshots","permalink":"/docs/pro/admin_ui"},"next":{"title":"User status API","permalink":"/docs/pro/user_status"}}');var s=t(74848),a=t(28453);const r={id:"server_api_auth",sidebar_label:"Server API JWKS auth",title:"Server API JWKS auth"},o=void 0,c={},l=[{value:"Overview",id:"overview",level:2},{value:"Configuration",id:"configuration",level:2},{value:"HTTP API",id:"http-api",level:3},{value:"GRPC API",id:"grpc-api",level:3},{value:"Configuration options",id:"configuration-options",level:3},{value:"<code>http_api.jwks.enabled</code> / <code>grpc_api.jwks.enabled</code>",id:"http_apijwksenabled--grpc_apijwksenabled",level:4},{value:"<code>http_api.jwks.endpoint</code> / <code>grpc_api.jwks.endpoint</code>",id:"http_apijwksendpoint--grpc_apijwksendpoint",level:4},{value:"<code>http_api.jwks.audience</code> / <code>grpc_api.jwks.audience</code>",id:"http_apijwksaudience--grpc_apijwksaudience",level:4},{value:"<code>http_api.jwks.issuer</code> / <code>grpc_api.jwks.issuer</code>",id:"http_apijwksissuer--grpc_apijwksissuer",level:4},{value:"<code>http_api.jwks.scope</code> / <code>grpc_api.jwks.scope</code>",id:"http_apijwksscope--grpc_apijwksscope",level:4},{value:"<code>http_api.jwks.tls</code> / <code>grpc_api.jwks.tls</code>",id:"http_apijwkstls--grpc_apijwkstls",level:4},{value:"Usage",id:"usage",level:2},{value:"HTTP API",id:"http-api-1",level:3},{value:"GRPC API",id:"grpc-api-1",level:3},{value:"JWKS caching, refresh and rotation",id:"jwks-caching-refresh-and-rotation",level:2},{value:"Combining with API key authentication",id:"combining-with-api-key-authentication",level:2},{value:"Example: Keycloak integration",id:"example-keycloak-integration",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Centrifugo PRO supports protecting HTTP API and GRPC API with JWKS (JSON Web Key Set) based authentication. This allows you to use JWT tokens issued by your identity provider (like Keycloak, Auth0, or any other OIDC-compliant provider) to authenticate server API requests."}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["Instead of using the traditional API key authentication with ",(0,s.jsx)(n.code,{children:"X-API-Key"})," header (for HTTP API) or metadata (for GRPC API), you can configure Centrifugo to validate JWT tokens signed by keys from a JWKS endpoint. This provides a more flexible and standardized way to protect your server API, especially when integrating with existing identity and access management systems."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"server API JWKS",src:t(19761).A+"",width:"3025",height:"1180"})}),"\n",(0,s.jsx)(n.p,{children:"The feature available since Centrifugo PRO v6.3.2"}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"http-api",children:"HTTP API"}),"\n",(0,s.jsxs)(n.p,{children:["JWKS authentication is configured under the ",(0,s.jsx)(n.code,{children:"http_api.jwks"})," section:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "http_api": {\n    "jwks": {\n      "enabled": true,\n      "endpoint": "https://keycloak.test.env/auth/realms/myrealm/protocol/openid-connect/certs",\n      "audience": "https://centrifugo.test.env",\n      "issuer": "https://keycloak.test.env/auth/realms/myrealm",\n      "scope": "centrifugo:api"\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"grpc-api",children:"GRPC API"}),"\n",(0,s.jsxs)(n.p,{children:["JWKS authentication is configured under the ",(0,s.jsx)(n.code,{children:"grpc_api.jwks"})," section:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "grpc_api": {\n    "enabled": true,\n    "port": 10000,\n    "key": "optional-api-key",\n    "jwks": {\n      "enabled": true,\n      "endpoint": "https://keycloak.example.com/.well-known/jwks.json",\n      "audience": "my-audience",\n      "issuer": "https://keycloak.example.com",\n      "scope": "centrifugo:api",\n      "tls": {\n        "enabled": true\n      }\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"configuration-options",children:"Configuration options"}),"\n",(0,s.jsxs)(n.h4,{id:"http_apijwksenabled--grpc_apijwksenabled",children:[(0,s.jsx)(n.code,{children:"http_api.jwks.enabled"})," / ",(0,s.jsx)(n.code,{children:"grpc_api.jwks.enabled"})]}),"\n",(0,s.jsxs)(n.p,{children:["Boolean. Default: ",(0,s.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Turns on JWKS authentication for HTTP API or GRPC API. When enabled, Centrifugo will validate JWT tokens from the ",(0,s.jsx)(n.code,{children:"Authorization: Bearer <TOKEN>"})," header (for HTTP API) or from gRPC metadata (for GRPC API) against the JWKS endpoint."]}),"\n",(0,s.jsxs)(n.h4,{id:"http_apijwksendpoint--grpc_apijwksendpoint",children:[(0,s.jsx)(n.code,{children:"http_api.jwks.endpoint"})," / ",(0,s.jsx)(n.code,{children:"grpc_api.jwks.endpoint"})]}),"\n",(0,s.jsx)(n.p,{children:"String. Required when JWKS is enabled."}),"\n",(0,s.jsx)(n.p,{children:"URL to fetch JWKS from. This is typically the OIDC provider's JWKS endpoint."}),"\n",(0,s.jsx)(n.p,{children:"Examples:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Keycloak: ",(0,s.jsx)(n.code,{children:"https://keycloak.example.com/realms/myrealm/protocol/openid-connect/certs"})]}),"\n",(0,s.jsxs)(n.li,{children:["Auth0: ",(0,s.jsx)(n.code,{children:"https://YOUR_DOMAIN.auth0.com/.well-known/jwks.json"})]}),"\n",(0,s.jsxs)(n.li,{children:["Custom OIDC provider: ",(0,s.jsx)(n.code,{children:"https://identity.example.com/.well-known/jwks.json"})]}),"\n"]}),"\n",(0,s.jsxs)(n.h4,{id:"http_apijwksaudience--grpc_apijwksaudience",children:[(0,s.jsx)(n.code,{children:"http_api.jwks.audience"})," / ",(0,s.jsx)(n.code,{children:"grpc_api.jwks.audience"})]}),"\n",(0,s.jsx)(n.p,{children:"String. Optional, when not set audience check is skipped. It's recommended to set it."}),"\n",(0,s.jsxs)(n.p,{children:["The expected audience claim (",(0,s.jsx)(n.code,{children:"aud"}),") in the JWT token. This should match the audience configured in your identity provider for Centrifugo."]}),"\n",(0,s.jsxs)(n.p,{children:["Example: ",(0,s.jsx)(n.code,{children:"https://centrifugo.test.env"})]}),"\n",(0,s.jsxs)(n.h4,{id:"http_apijwksissuer--grpc_apijwksissuer",children:[(0,s.jsx)(n.code,{children:"http_api.jwks.issuer"})," / ",(0,s.jsx)(n.code,{children:"grpc_api.jwks.issuer"})]}),"\n",(0,s.jsx)(n.p,{children:"String. Optional, when not set issuer check is skipped. It's recommended to set it."}),"\n",(0,s.jsxs)(n.p,{children:["The expected issuer claim (",(0,s.jsx)(n.code,{children:"iss"}),") in the JWT token. This should match the issuer of tokens from your identity provider."]}),"\n",(0,s.jsxs)(n.p,{children:["Example: ",(0,s.jsx)(n.code,{children:"https://keycloak.test.env/auth/realms/myrealm"})]}),"\n",(0,s.jsxs)(n.h4,{id:"http_apijwksscope--grpc_apijwksscope",children:[(0,s.jsx)(n.code,{children:"http_api.jwks.scope"})," / ",(0,s.jsx)(n.code,{children:"grpc_api.jwks.scope"})]}),"\n",(0,s.jsx)(n.p,{children:"String. Optional."}),"\n",(0,s.jsx)(n.p,{children:"The required scope claim in the JWT token. If set, Centrifugo will verify that the token contains this scope. The scope claim can be either a string or an array of strings in the JWT."}),"\n",(0,s.jsxs)(n.p,{children:["Example: ",(0,s.jsx)(n.code,{children:"centrifugo:api"})]}),"\n",(0,s.jsxs)(n.h4,{id:"http_apijwkstls--grpc_apijwkstls",children:[(0,s.jsx)(n.code,{children:"http_api.jwks.tls"})," / ",(0,s.jsx)(n.code,{children:"grpc_api.jwks.tls"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"/docs/server/configuration#tls-config-object",children:"Unified TLS object"}),". Optional."]}),"\n",(0,s.jsx)(n.p,{children:"TLS configuration for HTTPS connection to JWKS endpoint. Use this if your JWKS endpoint requires custom TLS settings, such as custom CA certificates or client certificates."}),"\n",(0,s.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.h3,{id:"http-api-1",children:"HTTP API"}),"\n",(0,s.jsxs)(n.p,{children:["Once JWKS authentication is configured, API clients need to provide a valid JWT token in the ",(0,s.jsx)(n.code,{children:"Authorization"})," header when making HTTP API requests:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl --header "Authorization: Bearer <JWT_TOKEN>" \\\n  --request POST \\\n  --data \'{"channel": "chat", "data": {"text": "hello"}}\' \\\n  http://localhost:8000/api/publish\n'})}),"\n",(0,s.jsx)(n.p,{children:"Example with httpie:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'echo \'{"channel": "chat", "data": {"text": "hello"}}\' | \\\n  http POST "http://localhost:8000/api/publish" \\\n  "Authorization: Bearer <JWT_TOKEN>"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"grpc-api-1",children:"GRPC API"}),"\n",(0,s.jsxs)(n.p,{children:["For GRPC API, clients need to provide the JWT token in the gRPC metadata with the ",(0,s.jsx)(n.code,{children:"authorization"})," key:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"authorization: Bearer <JWT_TOKEN>\n"})}),"\n",(0,s.jsx)(n.p,{children:"The exact implementation depends on your gRPC client library. Here's an example using Go:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'import (\n    "context"\n    "google.golang.org/grpc"\n    "google.golang.org/grpc/metadata"\n)\n\n// Create context with authorization metadata\nmd := metadata.New(map[string]string{\n    "authorization": "Bearer " + token,\n})\nctx := metadata.NewOutgoingContext(context.Background(), md)\n\n// Make GRPC API call with authenticated context\nresponse, err := client.Publish(ctx, &api.PublishRequest{\n    Channel: "chat",\n    Data:    []byte(`{"text": "hello"}`),\n})\n'})}),"\n",(0,s.jsx)(n.h2,{id:"jwks-caching-refresh-and-rotation",children:"JWKS caching, refresh and rotation"}),"\n",(0,s.jsx)(n.p,{children:"Centrifugo automatically caches the JWKS keys fetched from the endpoint to avoid making a request on every API call. The cache is periodically refreshed to pick up key rotations performed by your identity provider."}),"\n",(0,s.jsx)(n.h2,{id:"combining-with-api-key-authentication",children:"Combining with API key authentication"}),"\n",(0,s.jsxs)(n.p,{children:["JWKS authentication can be used alongside API key authentication provided by Centrifugo OSS. If both ",(0,s.jsx)(n.code,{children:"http_api.key"})," and ",(0,s.jsx)(n.code,{children:"http_api.jwks"})," are configured (or ",(0,s.jsx)(n.code,{children:"grpc_api.key"})," and ",(0,s.jsx)(n.code,{children:"grpc_api.jwks"}),"), Centrifugo PRO will accept requests authenticated with either method:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "http_api": {\n    "key": "my-api-key",\n    "jwks": {\n      "enabled": true,\n      "endpoint": "https://keycloak.test.env/auth/realms/myrealm/protocol/openid-connect/certs",\n      "audience": "https://centrifugo.test.env",\n      "issuer": "https://keycloak.test.env/auth/realms/myrealm"\n    }\n  },\n  "grpc_api": {\n    "enabled": true,\n    "port": 10000,\n    "key": "my-api-key",\n    "jwks": {\n      "enabled": true,\n      "endpoint": "https://keycloak.test.env/auth/realms/myrealm/protocol/openid-connect/certs",\n      "audience": "https://centrifugo.test.env",\n      "issuer": "https://keycloak.test.env/auth/realms/myrealm"\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This can be useful during migration from API key to JWKS authentication, or when you need to support both authentication methods simultaneously."}),"\n",(0,s.jsx)(n.h2,{id:"example-keycloak-integration",children:"Example: Keycloak integration"}),"\n",(0,s.jsx)(n.p,{children:"Here's a complete example of integrating Centrifugo HTTP API and GRPC API with Keycloak:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Configure Keycloak client"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Create a client in Keycloak with client authentication enabled"}),"\n",(0,s.jsx)(n.li,{children:"Set valid redirect URIs"}),"\n",(0,s.jsxs)(n.li,{children:["Add a custom scope ",(0,s.jsx)(n.code,{children:"centrifugo:api"})]}),"\n",(0,s.jsx)(n.li,{children:"Note the JWKS endpoint URL from realm settings"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Configure Centrifugo"}),":"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "http_api": {\n    "jwks": {\n      "enabled": true,\n      "endpoint": "https://keycloak.example.com/auth/realms/myrealm/protocol/openid-connect/certs",\n      "issuer": "https://keycloak.example.com/auth/realms/myrealm",\n      "scope": "centrifugo:api"\n    }\n  },\n  "grpc_api": {\n    "enabled": true,\n    "port": 10000,\n    "jwks": {\n      "enabled": true,\n      "endpoint": "https://keycloak.example.com/auth/realms/myrealm/protocol/openid-connect/certs",\n      "issuer": "https://keycloak.example.com/auth/realms/myrealm",\n      "scope": "centrifugo:api"\n    }\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Obtain a token from Keycloak"})," (usually this is done by your backend service):"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'TOKEN=$(curl -X POST "https://keycloak.example.com/auth/realms/myrealm/protocol/openid-connect/token" \\\n  -H "Content-Type: application/x-www-form-urlencoded" \\\n  -d "client_id=myclient" \\\n  -d "client_secret=mysecret" \\\n  -d "grant_type=client_credentials" \\\n  -d "scope=centrifugo:api" \\\n  | jq -r \'.access_token\')\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use the token with Centrifugo HTTP API"})," (usually this is done by your backend service):"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl --header "Authorization: Bearer $TOKEN" \\\n  --request POST \\\n  --data \'{"channel": "chat", "data": {"text": "hello"}}\' \\\n  https://centrifugo.example.com/api/publish\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use the token with Centrifugo GRPC API"})," (usually this is done by your backend service):"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'md := metadata.New(map[string]string{\n    "authorization": "Bearer " + token,\n})\nctx := metadata.NewOutgoingContext(context.Background(), md)\n\nresponse, err := client.Publish(ctx, &api.PublishRequest{\n    Channel: "chat",\n    Data:    []byte(`{"text": "hello"}`),\n})\n'})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);