"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[3117],{53906:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>o});var c=t(85893),a=t(11151);const i={id:"channel_cache_empty",sidebar_label:"Cache empty events",title:"Channel cache empty events"},s=void 0,r={id:"pro/channel_cache_empty",title:"Channel cache empty events",description:'Centrifugo PRO can notify the backend when a client subscribes to the channel using cache recovery mode, but there is no latest publication found in the history stream to load the initial state \u2013 i.e. in the case of "cache miss" event. The backend may react to the event and populate the cache by publishing the current state to the channel.',source:"@site/docs/pro/channel_cache_empty.md",sourceDirName:"pro",slug:"/pro/channel_cache_empty",permalink:"/docs/pro/channel_cache_empty",draft:!1,unlisted:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/pro/channel_cache_empty.md",tags:[],version:"current",frontMatter:{id:"channel_cache_empty",sidebar_label:"Cache empty events",title:"Channel cache empty events"},sidebar:"Pro",previous:{title:"Channel state events",permalink:"/docs/pro/channel_state_events"},next:{title:"Channel capabilities",permalink:"/docs/pro/capabilities"}},h={},o=[{value:"Cache empty proxy",id:"cache-empty-proxy",level:3},{value:"CacheEmptyRequest",id:"cacheemptyrequest",level:4},{value:"CacheEmptyResult",id:"cacheemptyresult",level:4}];function l(e){const n={a:"a",code:"code",h3:"h3",h4:"h4",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,a.a)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)(n.p,{children:["Centrifugo PRO can notify the backend when a client subscribes to the channel using ",(0,c.jsx)(n.a,{href:"/docs/server/cache_recovery",children:"cache recovery mode"}),', but there is no latest publication found in the history stream to load the initial state \u2013 i.e. in the case of "cache miss" event. The backend may react to the event and populate the cache by publishing the current state to the channel.']}),"\n",(0,c.jsxs)(n.p,{children:['This is done by configuring "cache empty" proxy. It\'s similar to proxies described in ',(0,c.jsx)(n.a,{href:"/docs/server/proxy",children:"Proxy events to the backend"})," chapter, but acts without client connection context \u2013 because it's related to a channel in general, and a particular client who triggered the cache miss is not important."]}),"\n",(0,c.jsx)(n.h3,{id:"cache-empty-proxy",children:"Cache empty proxy"}),"\n",(0,c.jsx)(n.p,{children:"Add the following options to the configuration file:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "channel": {\n    "proxy": {\n      "cache_empty": {\n        "endpoint": "http://localhost:3000/centrifugo/cache_empty",\n        "timeout": "1s"\n      }\n    }\n  }\n}\n'})}),"\n",(0,c.jsx)(n.p,{children:"\u2013 to configure proxy endpoint and timeout of cache empty proxy event."}),"\n",(0,c.jsxs)(n.p,{children:["To actually enable proxy for desired channels you must use ",(0,c.jsx)(n.code,{children:"cache_empty_proxy_name"})," channel namespace option and point it to the name of proxy to use, for example ",(0,c.jsx)(n.code,{children:"unified"})," which we just configured. Let's enable for channels without namespace:"]}),"\n",(0,c.jsxs)(n.p,{children:["For example, to enable cache empty proxy for channels without namespace define ",(0,c.jsx)(n.code,{children:"proxy_cache_empty"})," boolean flag on a top configuration level:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "channel": {\n    "proxy": {\n      "cache_empty": {\n        "endpoint": "http://localhost:3000/centrifugo/cache_empty",\n        "timeout": "1s"\n      }\n    },\n    "without_namespace": {\n      "cache_empty_proxy_enabled": true\n    }\n  }\n}\n'})}),"\n",(0,c.jsxs)(n.p,{children:["Or if you want to use it in the namespace ",(0,c.jsx)(n.code,{children:"example"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "channel": {\n    "proxy": {\n      "cache_empty": {\n        "endpoint": "http://localhost:3000/centrifugo/cache_empty",\n        "timeout": "1s"\n      }\n    },\n    "namespaces": [{\n      "name": "example",\n      "cache_empty_proxy_enabled": "unified"\n    }]\n  }\n}\n'})}),"\n",(0,c.jsx)(n.p,{children:"Payload example sent to app backend in cache empty notification request:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",children:'{\n  "channel": "example:index"\n}\n'})}),"\n",(0,c.jsx)(n.p,{children:"Expected response example:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-json",children:'{\n    "result": {}\n}\n'})}),"\n",(0,c.jsx)(n.p,{children:"If cache empty proxy is defined, but Centrifugo can't reach it \u2013 then subscription request which triggered the event will be rejected with the internal error."}),"\n",(0,c.jsx)(n.h4,{id:"cacheemptyrequest",children:"CacheEmptyRequest"}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Field"}),(0,c.jsx)(n.th,{children:"Type"}),(0,c.jsx)(n.th,{children:"Required"}),(0,c.jsx)(n.th,{children:"Description"})]})}),(0,c.jsx)(n.tbody,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"channel"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"string"})}),(0,c.jsx)(n.td,{children:"yes"}),(0,c.jsx)(n.td,{children:"A channel in which cache miss occurred"})]})})]}),"\n",(0,c.jsx)(n.h4,{id:"cacheemptyresult",children:"CacheEmptyResult"}),"\n",(0,c.jsxs)(n.table,{children:[(0,c.jsx)(n.thead,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.th,{children:"Field"}),(0,c.jsx)(n.th,{children:"Type"}),(0,c.jsx)(n.th,{children:"Required"}),(0,c.jsx)(n.th,{children:"Description"})]})}),(0,c.jsx)(n.tbody,{children:(0,c.jsxs)(n.tr,{children:[(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"populated"})}),(0,c.jsx)(n.td,{children:(0,c.jsx)(n.code,{children:"boolean"})}),(0,c.jsx)(n.td,{children:"no"}),(0,c.jsx)(n.td,{children:"Notify Centrifugo that channel cache was populated by the app backend \u2013 in this case Centrifugo will try to recover state one more time"})]})})]})]})}function d(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>r,a:()=>s});var c=t(67294);const a={},i=c.createContext(a);function s(e){const n=c.useContext(i);return c.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),c.createElement(i.Provider,{value:n},e.children)}}}]);