"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[762],{17212:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"server/infra_tuning","title":"Infrastructure tuning","description":"Since Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it too.","source":"@site/docs/server/infra_tuning.md","sourceDirName":"server","slug":"/server/infra_tuning","permalink":"/docs/server/infra_tuning","draft":false,"unlisted":false,"editUrl":"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/infra_tuning.md","tags":[],"version":"current","frontMatter":{"id":"infra_tuning","title":"Infrastructure tuning"},"sidebar":"Guides","previous":{"title":"Server observability","permalink":"/docs/server/observability"},"next":{"title":"Load balancing","permalink":"/docs/server/load_balancing"}}');var r=i(74848),o=i(28453);const s={id:"infra_tuning",title:"Infrastructure tuning"},a=void 0,l={},c=[{value:"Open files limit",id:"open-files-limit",level:3},{value:"Ephemeral port exhaustion",id:"ephemeral-port-exhaustion",level:3},{value:"Sockets in TIME_WAIT state",id:"sockets-in-time_wait-state",level:3},{value:"Proxy max connections",id:"proxy-max-connections",level:3},{value:"Conntrack table",id:"conntrack-table",level:3},{value:"Additional server protection",id:"additional-server-protection",level:3}];function d(e){const n={a:"a",code:"code",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Since Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it too."}),"\n",(0,r.jsx)(n.h3,{id:"open-files-limit",children:"Open files limit"}),"\n",(0,r.jsx)(n.p,{children:"You should increase a max number of open files Centrifugo process can open if you want to handle more connections."}),"\n",(0,r.jsx)(n.p,{children:"To get the current open files limit run:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"ulimit -n\n"})}),"\n",(0,r.jsx)(n.p,{children:"On Linux you can check limits for a running process using:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"cat /proc/<PID>/limits\n"})}),"\n",(0,r.jsx)(n.p,{children:"The open file limit shows approximately how many clients your server can handle. Each connection consumes one file descriptor. On most operating systems this limit is 128-256 by default."}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"https://docs.riak.com/riak/kv/2.2.3/using/performance/open-files-limit.1.html",children:"this document"})," to get more info on how to increase this number."]}),"\n",(0,r.jsx)(n.p,{children:"If you install Centrifugo using RPM from repo then it automatically sets max open files limit to 65536."}),"\n",(0,r.jsx)(n.p,{children:"You may also need to increase max open files for Nginx (or any other proxy before Centrifugo)."}),"\n",(0,r.jsx)(n.h3,{id:"ephemeral-port-exhaustion",children:"Ephemeral port exhaustion"}),"\n",(0,r.jsx)(n.p,{children:"Ephemeral ports exhaustion problem can happen between your load balancer and Centrifugo server. If your clients connect directly to Centrifugo without any load balancer or reverse proxy software between then you are most likely won't have this problem. But load balancing is a very common thing."}),"\n",(0,r.jsx)(n.p,{children:"The problem arises due to the fact that each TCP connection uniquely identified in the OS by the 4-part-tuple:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"source ip | source port | destination ip | destination port\n"})}),"\n",(0,r.jsx)(n.p,{children:"On load balancer/server boundary you are limited in 65536 possible variants by default. Actually due to some OS limits not all 65536 ports are available for usage (usually about 15k ports available by default)."}),"\n",(0,r.jsx)(n.p,{children:"In order to eliminate a problem you can:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Increase the ephemeral port range by tuning ",(0,r.jsx)(n.code,{children:"ip_local_port_range"})," option"]}),"\n",(0,r.jsx)(n.li,{children:"Deploy more Centrifugo server instances to load balance across"}),"\n",(0,r.jsx)(n.li,{children:"Deploy more load balancer instances"}),"\n",(0,r.jsx)(n.li,{children:"Use virtual network interfaces"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"https://making.pusher.com/ephemeral-port-exhaustion-and-how-to-avoid-it/",children:"a post in Pusher blog"})," about this problem and more detailed solution steps."]}),"\n",(0,r.jsx)(n.h3,{id:"sockets-in-time_wait-state",children:"Sockets in TIME_WAIT state"}),"\n",(0,r.jsx)(n.p,{children:"On load balancer/server boundary one more problem can arise: sockets in TIME_WAIT state."}),"\n",(0,r.jsxs)(n.p,{children:["Under load when lots of connections and disconnections happen socket descriptors can stay in TIME_WAIT state. Those descriptors can not be reused for a while. So you can get various\nerrors when using Centrifugo. For example something like ",(0,r.jsx)(n.code,{children:"(99: Cannot assign requested address) while connecting to upstream"})," in Nginx error log and 502 on client side."]}),"\n",(0,r.jsx)(n.p,{children:"Look how many socket descriptors in TIME_WAIT state."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"netstat -an |grep TIME_WAIT | grep <CENTRIFUGO_PID> | wc -l\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Nice article about TIME_WAIT sockets: ",(0,r.jsx)(n.a,{href:"http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html",children:"http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html"})]}),"\n",(0,r.jsx)(n.p,{children:"The advices here are similar to ephemeral port exhaustion problem:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Increase the ephemeral port range by tuning ",(0,r.jsx)(n.code,{children:"ip_local_port_range"})," option"]}),"\n",(0,r.jsx)(n.li,{children:"Deploy more Centrifugo server instances to load balance across"}),"\n",(0,r.jsx)(n.li,{children:"Deploy more load balancer instances"}),"\n",(0,r.jsx)(n.li,{children:"Use virtual network interfaces"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"proxy-max-connections",children:"Proxy max connections"}),"\n",(0,r.jsx)(n.p,{children:"Proxies like Nginx and Envoy have default limits on maximum number of connections which can be established."}),"\n",(0,r.jsx)(n.p,{children:"Make sure you have a reasonable limit for max number of incoming and outgoing connections in your proxy configuration."}),"\n",(0,r.jsx)(n.h3,{id:"conntrack-table",children:"Conntrack table"}),"\n",(0,r.jsxs)(n.p,{children:["More rare (since default limit is usually sufficient) your possible number of connections can be limited by conntrack table. Netfilter framework which is part of iptables keeps information about all connections and has limited size for this information. See how to see its limits and instructions to increase ",(0,r.jsx)(n.a,{href:"https://morganwu277.github.io/2018/05/26/Solve-production-issue-of-nf-conntrack-table-full-dropping-packet/",children:"in this article"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"additional-server-protection",children:"Additional server protection"}),"\n",(0,r.jsxs)(n.p,{children:["You should also consider adding additional protection to your Centrifugo endpoints. Centrifugo itself provides several options (described in ",(0,r.jsx)(n.a,{href:"/docs/server/configuration",children:"configuration"})," section) regarding server protection from the malicious behavior. Though an additional layer of DDOS protection on network or infrastructure level is highly recommended. For example, you may want to limit the number of connections coming from particular IP address."]}),"\n",(0,r.jsx)(n.p,{children:"Here we list some possible ways you can use to protect your Centrifugo installation:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Adding Nginx ",(0,r.jsx)(n.a,{href:"https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone",children:"limit_conn_zone"})," configuration"]}),"\n",(0,r.jsxs)(n.li,{children:["Using ",(0,r.jsx)(n.a,{href:"https://www.haproxy.com/blog/introduction-to-haproxy-stick-tables/",children:"stick tables"})," of Haproxy"]}),"\n",(0,r.jsxs)(n.li,{children:["Configuring ",(0,r.jsx)(n.a,{href:"https://developers.cloudflare.com/waf/rate-limiting-rules/",children:"rate limiting rules"})," with Cloudflare"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The list is not exhaustive of course."})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>a});var t=i(96540);const r={},o=t.createContext(r);function s(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);