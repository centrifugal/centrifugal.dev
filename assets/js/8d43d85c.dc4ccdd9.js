"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[3948],{28453:(n,e,i)=>{i.d(e,{R:()=>r,x:()=>l});var a=i(96540);const s={},t=a.createContext(s);function r(n){const e=a.useContext(t);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),a.createElement(t.Provider,{value:e},n.children)}},50134:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>o,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"pro/client_publications","title":"Ephemeral client publications","description":"Centrifugo PRO ephemeral client publications enable schema-validated messaging with jq/JS transformations, bypassing backend proxy for lower latency.","source":"@site/docs/pro/draft_client_publications.md","sourceDirName":"pro","slug":"/pro/client_publications","permalink":"/docs/pro/client_publications","draft":false,"unlisted":false,"editUrl":"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/pro/draft_client_publications.md","tags":[],"version":"current","frontMatter":{"description":"Centrifugo PRO ephemeral client publications enable schema-validated messaging with jq/JS transformations, bypassing backend proxy for lower latency.","id":"client_publications","title":"Ephemeral client publications","sidebar_label":"Ephemeral publications"}}');var s=i(74848),t=i(28453);const r={description:"Centrifugo PRO ephemeral client publications enable schema-validated messaging with jq/JS transformations, bypassing backend proxy for lower latency.",id:"client_publications",title:"Ephemeral client publications",sidebar_label:"Ephemeral publications"},l=void 0,o={},c=[{value:"Overview",id:"overview",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Defining schemas",id:"defining-schemas",level:3},{value:"JSON Schema (default)",id:"json-schema-default",level:4},{value:"Empty Binary Schema",id:"empty-binary-schema",level:4},{value:"Schema from file",id:"schema-from-file",level:4},{value:"Applying schemas to channels",id:"applying-schemas-to-channels",level:3},{value:"Multiple schemas",id:"multiple-schemas",level:3},{value:"Publication transformations",id:"publication-transformations",level:2},{value:"Transformation engines",id:"transformation-engines",level:3},{value:"Configuration",id:"configuration-1",level:3},{value:"Input context",id:"input-context",level:3},{value:"Output format",id:"output-format",level:3},{value:"Using jq",id:"using-jq",level:3},{value:"Using JavaScript",id:"using-javascript",level:3},{value:"Loading programs from files",id:"loading-programs-from-files",level:3},{value:"Integration with schemas",id:"integration-with-schemas",level:3},{value:"Performance considerations",id:"performance-considerations",level:3},{value:"Complete transformation examples",id:"complete-transformation-examples",level:3},{value:"Excluding client info",id:"excluding-client-info",level:2},{value:"Complete example",id:"complete-example",level:2},{value:"Example with Empty Binary Schema",id:"example-with-empty-binary-schema",level:3},{value:"Behavior",id:"behavior",level:2},{value:"Schema validation",id:"schema-validation",level:3},{value:"Transformation execution",id:"transformation-execution",level:3},{value:"Configuration validation",id:"configuration-validation",level:3},{value:"Bottom line",id:"bottom-line",level:3},{value:"See also",id:"see-also",level:2}];function d(n){const e={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.p,{children:"Centrifugo PRO provides schema validation for client publications, enabling ephemeral messaging: client publications can pass through Centrifugo directly without involving backend proxy logic, reducing backend load and delivery latency. Normally the backend is required because it may validate and store messages in the main database, but for certain types of messages\u2014such as typing notifications in a chat room\u2014backend involvement adds unnecessary overhead. Centrifugo PRO offers an efficient way to address that."}),"\n",(0,s.jsx)(e.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(e.p,{children:"The feature consists of three parts which together provide a ground for ephemeral client publications:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Validation layer"})," - validate client publications based on JSON schema"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Transformation layer"})," - transform publication data and generate tags using jq or JavaScript engines"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Bandwidth optimization"})," - optionally exclude client info from publications to reduce message size"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(e.h3,{id:"defining-schemas",children:"Defining schemas"}),"\n",(0,s.jsx)(e.p,{children:"Schemas are defined at the top level of Centrifugo configuration. Centrifugo supports two types of schemas:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"JSON Schema"})," (",(0,s.jsx)(e.code,{children:"jsonschema_draft_2020_12"}),") - Validates publication data against JSON Schema Draft 2020-12"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Empty Binary"})," (",(0,s.jsx)(e.code,{children:"empty_binary"}),") - Only allows empty binary data (useful for presence-like signals)"]}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{title:"Security Default",type:"info",children:(0,s.jsxs)(e.p,{children:["For JSON schemas, Centrifugo automatically sets ",(0,s.jsx)(e.code,{children:'"additionalProperties": false'})," on object-type schemas unless explicitly specified otherwise. This prevents clients from injecting unexpected fields into validated data."]})}),"\n",(0,s.jsx)(e.h4,{id:"json-schema-default",children:"JSON Schema (default)"}),"\n",(0,s.jsxs)(e.p,{children:["The ",(0,s.jsx)(e.code,{children:"type"})," field is optional and defaults to ",(0,s.jsx)(e.code,{children:"jsonschema_draft_2020_12"}),". You can define schemas directly in your configuration file:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "schemas": [\n    {\n      "name": "chat_message",\n      "type": "jsonschema_draft_2020_12",\n      "definition": "{\\"type\\":\\"object\\",\\"properties\\":{\\"text\\":{\\"type\\":\\"string\\",\\"maxLength\\":500}},\\"required\\":[\\"text\\"]}"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:"For better readability in YAML, use multiline strings:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",metastring:'title="config.yaml"',children:'schemas:\n  - name: chat_message\n    type: jsonschema_draft_2020_12  # Optional, this is the default\n    definition: |\n      {\n        "type": "object",\n        "properties": {\n          "text": {"type": "string", "maxLength": 500},\n          "mentions": {"type": "array", "items": {"type": "string"}}\n        },\n        "required": ["text"]\n      }\n'})}),"\n",(0,s.jsx)(e.h4,{id:"empty-binary-schema",children:"Empty Binary Schema"}),"\n",(0,s.jsxs)(e.p,{children:["The ",(0,s.jsx)(e.code,{children:"empty_binary"}),' schema type validates that publication data is empty. This is useful for presence-like signals where the fact of publication itself carries meaning (e.g., "user is typing"):']}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "schemas": [\n    {\n      "name": "typing_indicator",\n      "type": "empty_binary"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",metastring:'title="config.yaml"',children:"schemas:\n  - name: typing_indicator\n    type: empty_binary\n"})}),"\n",(0,s.jsx)(e.admonition,{type:"note",children:(0,s.jsxs)(e.p,{children:["Empty binary schemas don't require a ",(0,s.jsx)(e.code,{children:"definition"})," field since they only validate that data is empty (0 bytes)."]})}),"\n",(0,s.jsx)(e.h4,{id:"schema-from-file",children:"Schema from file"}),"\n",(0,s.jsx)(e.p,{children:"For complex schemas, you can reference external JSON schema files. This provides better readability, IDE support, and easier maintenance:"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Create a schema file:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="schemas/chat_message.json"',children:'{\n  "type": "object",\n  "properties": {\n    "text": {\n      "type": "string",\n      "maxLength": 500,\n      "minLength": 1\n    },\n    "mentions": {\n      "type": "array",\n      "items": {"type": "string"}\n    },\n    "metadata": {\n      "type": "object",\n      "properties": {\n        "timestamp": {"type": "integer"}\n      }\n    }\n  },\n  "required": ["text"]\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Reference it in your config:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "schemas": [\n    {\n      "name": "chat_message",\n      "definition": "./schemas/chat_message.json"\n    },\n    {\n      "name": "reaction",\n      "definition": "./schemas/reaction.json"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:"Or in YAML:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",metastring:'title="config.yaml"',children:"schemas:\n  - name: chat_message\n    definition: ./schemas/chat_message.json\n  - name: reaction\n    definition: ./schemas/reaction.json\n  - name: typing\n    definition: ./schemas/typing.json\n"})}),"\n",(0,s.jsx)(e.admonition,{title:"Benefits of schema files",type:"tip",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Better IDE support"})," - Syntax highlighting, validation, and autocomplete"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Easier testing"})," - Validate schema files independently"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Cleaner diffs"})," - Track schema changes separately in version control"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Reusability"})," - Share schemas across environments or services"]}),"\n"]})}),"\n",(0,s.jsx)(e.admonition,{type:"info",children:(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:'"additionalProperties": false'})," is automatically added to object schemas for security. You can explicitly set ",(0,s.jsx)(e.code,{children:'"additionalProperties": true'})," in your schema file if you need to allow extra fields."]})}),"\n",(0,s.jsx)(e.h3,{id:"applying-schemas-to-channels",children:"Applying schemas to channels"}),"\n",(0,s.jsxs)(e.p,{children:["Use ",(0,s.jsx)(e.code,{children:"client_publication.schemas"})," in channel or namespace configuration to apply validation:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "schemas": [\n    {\n      "name": "typing",\n      "definition": "{\\"type\\":\\"object\\",\\"properties\\":{},\\"additionalProperties\\": false]}"\n    }\n  ],\n  "channel": {\n    "namespaces": [\n      {\n        "name": "typings",\n        "publication_data_format": "json",\n        "client_publication": {\n          "schemas": ["typing"]\n        },\n        "allow_publish_for_subscriber": true\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsxs)(e.admonition,{title:"Schema Type Compatibility",type:"important",children:[(0,s.jsxs)(e.p,{children:["Schemas must be compatible with the channel's ",(0,s.jsx)(e.code,{children:"publication_data_format"})," setting:"]}),(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"JSON schemas"})," (",(0,s.jsx)(e.code,{children:"jsonschema_draft_2020_12"}),") require ",(0,s.jsx)(e.code,{children:'publication_data_format: "json"'})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Empty binary schemas"})," (",(0,s.jsx)(e.code,{children:"empty_binary"}),") require ",(0,s.jsx)(e.code,{children:'publication_data_format: "binary"'})," to be set"]}),"\n"]}),(0,s.jsx)(e.p,{children:"Centrifugo validates this configuration at startup and will reject incompatible combinations."})]}),"\n",(0,s.jsx)(e.h3,{id:"multiple-schemas",children:"Multiple schemas"}),"\n",(0,s.jsxs)(e.p,{children:["When multiple schemas are configured, the publication data must match ",(0,s.jsx)(e.strong,{children:"at least one"})," of them. This allows supporting different message types in the same channel:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "schemas": [\n    {\n      "name": "typing",\n      "definition": "{\\"type\\":\\"object\\",\\"properties\\":{\\"is_typing\\":{\\"type\\":\\"boolean\\"}},\\"required\\":[\\"is_typing\\"]}"\n    },\n    {\n      "name": "reaction",\n      "definition": "{\\"type\\":\\"object\\",\\"properties\\":{\\"emoji\\":{\\"type\\":\\"string\\",\\"enum\\":[\\"\ud83d\udc4d\\",\\"\ud83d\udc4e\\",\\"\u2764\ufe0f\\",\\"\ud83d\ude02\\",\\"\ud83d\ude2e\\",\\"\ud83d\ude22\\",\\"\ud83d\ude21\\"]}},\\"required\\":[\\"emoji\\"],\\"additionalProperties\\":false}"\n    }\n  ],\n  "channel": {\n    "namespaces": [\n      {\n        "name": "ephemeral",\n        "publication_data_format": "json",\n        "client_publication": {\n          "schemas": ["typing", "reaction"]\n        },\n        "allow_publish_for_subscriber": true\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsx)(e.admonition,{type:"note",children:(0,s.jsxs)(e.p,{children:["All schemas referenced in ",(0,s.jsx)(e.code,{children:"client_publication.schemas"})," must have the same type (either all ",(0,s.jsx)(e.code,{children:"jsonschema_draft_2020_12"})," or all ",(0,s.jsx)(e.code,{children:"empty_binary"}),") since they share the same ",(0,s.jsx)(e.code,{children:"publication_data_format"})," setting."]})}),"\n",(0,s.jsx)(e.h2,{id:"publication-transformations",children:"Publication transformations"}),"\n",(0,s.jsx)(e.p,{children:"Publication transformations allow you to modify publication data, extract tags, and generate idempotency keys using either jq or JavaScript programs. Transformations are executed server-side and compiled at startup for optimal performance."}),"\n",(0,s.jsx)(e.h3,{id:"transformation-engines",children:"Transformation engines"}),"\n",(0,s.jsx)(e.p,{children:"Centrifugo PRO supports two transformation engines:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"jq"})," - JSON query language, ideal for data manipulation and filtering"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"js"})," - JavaScript (via goja runtime), provides familiar syntax and flexibility"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"Both engines receive the same input context and must return a consistent output format."}),"\n",(0,s.jsx)(e.h3,{id:"configuration-1",children:"Configuration"}),"\n",(0,s.jsxs)(e.p,{children:["Transformations are configured in the ",(0,s.jsx)(e.code,{children:"client_publication.transform"})," section:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "channel": {\n    "namespaces": [\n      {\n        "name": "chat",\n        "client_publication": {\n          "transform": {\n            "enabled": true,\n            "engine": "jq",\n            "jq": {\n              "program": "{data: .data, tags: {user: .user}}"\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:"Or in YAML for better readability:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",metastring:'title="config.yaml"',children:'channel:\n  namespaces:\n    - name: chat\n      client_publication:\n        transform:\n          enabled: true\n          engine: jq  # or "js"\n          jq:\n            program: |\n              {\n                data: .data,\n                tags: {user: .user, priority: "high"}\n              }\n'})}),"\n",(0,s.jsx)(e.h3,{id:"input-context",children:"Input context"}),"\n",(0,s.jsx)(e.p,{children:"Transform programs receive an input object with the following variables:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"data"})," (object) - The publication data sent by the client (always available)"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"timestamp_ms"})," (int) - Current server timestamp in milliseconds"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"user"})," (string) - User ID from connection credentials"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"client"})," (string) - Client ID (unique connection identifier)"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"meta"})," (object) - Connection metadata"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"vars"})," (object) - Channel pattern variables (requires ",(0,s.jsx)(e.a,{href:"/docs/pro/channel_patterns",children:"channel patterns"}),")"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"schema_name"})," (string) - Name of the matched schema (empty if no schemas configured)"]}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{type:"note",children:(0,s.jsxs)(e.p,{children:["Only ",(0,s.jsx)(e.code,{children:"data"})," is guaranteed to be present. Other variables depend on the context where the transformation is used."]})}),"\n",(0,s.jsx)(e.h3,{id:"output-format",children:"Output format"}),"\n",(0,s.jsx)(e.p,{children:"Transform programs must return an object with optional fields:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"data"})," (object) - Transformed publication data (optional)"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"tags"})," (object) - Key-value pairs for publication tags (optional)"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"idempotency_key"})," (string) - Deduplication key (optional)"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"All fields are optional - you can return only the ones you need."}),"\n",(0,s.jsx)(e.h3,{id:"using-jq",children:"Using jq"}),"\n",(0,s.jsx)(e.p,{children:"jq provides powerful JSON manipulation capabilities with a concise syntax."}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Basic transformation:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'transform:\n  enabled: true\n  engine: jq\n  jq:\n    program: |\n      {\n        data: {\n          message: .data.text,\n          user: .user,\n          timestamp: .timestamp_ms\n        },\n        tags: {\n          room: .vars.room_id,\n          priority: (if .data.urgent == true then "high" else "normal" end)\n        },\n        idempotency_key: (.user + ":" + (.timestamp_ms | tostring))\n      }\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Data restructuring:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'transform:\n  enabled: true\n  engine: jq\n  jq:\n    program: |\n      {\n        data: (\n          .data\n          | .author = {id: .user_id, name: .user_name}\n          | del(.user_id, .user_name)\n        ),\n        tags: {source: "client"}\n      }\n'})}),"\n",(0,s.jsx)(e.h3,{id:"using-javascript",children:"Using JavaScript"}),"\n",(0,s.jsx)(e.p,{children:"JavaScript provides familiar syntax and can handle complex logic."}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Basic transformation:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'transform:\n  enabled: true\n  engine: js\n  js:\n    program: |\n      (function(input) {\n        return {\n          data: {\n            message: input.data.text,\n            user: input.user,\n            timestamp: input.timestamp_ms\n          },\n          tags: {\n            room: input.vars.room_id,\n            priority: input.data.urgent === true ? "high" : "normal"\n          },\n          idempotency_key: input.user + ":" + input.timestamp_ms\n        };\n      })\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Data restructuring:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'transform:\n  enabled: true\n  engine: js\n  js:\n    program: |\n      (function(input) {\n        var data = input.data;\n        return {\n          data: {\n            author: {\n              id: data.user_id,\n              name: data.user_name\n            },\n            content: data.content,\n            metadata: data.metadata\n          },\n          tags: {\n            source: "client"\n          }\n        };\n      })\n'})}),"\n",(0,s.jsx)(e.h3,{id:"loading-programs-from-files",children:"Loading programs from files"}),"\n",(0,s.jsx)(e.p,{children:"For complex transformations, you can load programs from external files:"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Create program files:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-jq",metastring:'title="transforms/chat.jq"',children:'{\n  data: {\n    message: .data.text,\n    author: .user,\n    timestamp: .timestamp_ms\n  },\n  tags: {\n    room: .vars.room_id,\n    priority: (if .data.urgent == true then "high" else "normal" end)\n  },\n  idempotency_key: (.user + ":" + (.timestamp_ms | tostring))\n}\n'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-javascript",metastring:'title="transforms/chat.js"',children:'(function(input) {\n  return {\n    data: {\n      message: input.data.text,\n      author: input.user,\n      timestamp: input.timestamp_ms\n    },\n    tags: {\n      room: input.vars.room_id,\n      priority: input.data.urgent === true ? "high" : "normal"\n    },\n    idempotency_key: input.user + ":" + input.timestamp_ms\n  };\n})\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Reference in configuration:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "channel": {\n    "namespaces": [\n      {\n        "name": "chat",\n        "client_publication": {\n          "transform": {\n            "enabled": true,\n            "engine": "jq",\n            "jq": {\n              "program": "./transforms/chat.jq"\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",metastring:'title="config.yaml"',children:"channel:\n  namespaces:\n    - name: chat\n      client_publication:\n        transform:\n          enabled: true\n          engine: jq\n          jq:\n            program: ./transforms/chat.jq\n"})}),"\n",(0,s.jsx)(e.admonition,{title:"Benefits of program files",type:"tip",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Better IDE support"})," - Syntax highlighting and validation"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Easier testing"})," - Test programs independently"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Cleaner config"})," - Keep configuration files focused"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Reusability"})," - Share programs across namespaces"]}),"\n"]})}),"\n",(0,s.jsx)(e.h3,{id:"integration-with-schemas",children:"Integration with schemas"}),"\n",(0,s.jsx)(e.p,{children:"Transformations work seamlessly with schema validation. The matched schema name is available in the transformation context."}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"With schema validation:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'channel:\n  namespaces:\n    - name: chat\n      client_publication:\n        schemas: ["chat_message"]  # Validate before transformation\n        transform:\n          enabled: true\n          engine: jq\n          jq:\n            program: |\n              {\n                data: .data,\n                tags: {\n                  validated_schema: .schema_name,\n                  user: .user\n                }\n              }\n'})}),"\n",(0,s.jsx)(e.h3,{id:"performance-considerations",children:"Performance considerations"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Compilation"})," - Programs are compiled once at startup and validated for correctness"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Runtime"})," - Only program execution happens per publication"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Engine choice"})," - Both jq and JavaScript have similar performance characteristics:","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"jq: ~10,000 ns/op for typical transformations"}),"\n",(0,s.jsx)(e.li,{children:"JavaScript: ~8,000 ns/op for typical transformations"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Minimal overhead"})," - Simple transformations add negligible latency"]}),"\n"]}),"\n",(0,s.jsxs)(e.admonition,{title:"Benchmark results",type:"info",children:[(0,s.jsx)(e.p,{children:"Internal benchmarks show:"}),(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Full transformation (data + tags + idempotency key): ~8-10\u03bcs per publication"}),"\n",(0,s.jsx)(e.li,{children:"Minimal transformation (data only): ~1-2\u03bcs per publication"}),"\n"]}),(0,s.jsx)(e.p,{children:"These are measured on modern hardware and represent worst-case scenarios. Actual performance may be better."})]}),"\n",(0,s.jsx)(e.h3,{id:"complete-transformation-examples",children:"Complete transformation examples"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Multi-tenant chat with data enrichment:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'channel:\n  patterns: true\n  namespaces:\n    - name: tenant_chat\n      pattern: /tenants/:tenant_id/rooms/:room_id/messages\n      client_publication:\n        schemas: ["chat_message"]\n        transform:\n          enabled: true\n          engine: jq\n          jq:\n            program: |\n              {\n                data: {\n                  message: .data.text,\n                  author: {\n                    id: .user,\n                    role: .meta.role\n                  },\n                  room: .vars.room_id,\n                  timestamp: .timestamp_ms\n                },\n                tags: {\n                  tenant: .vars.tenant_id,\n                  room: .vars.room_id,\n                  priority: (if .meta.premium == true then "high" else "normal" end)\n                },\n                idempotency_key: (.vars.tenant_id + ":" + .user + ":" + (.timestamp_ms | tostring))\n              }\n        allow_publish_for_subscriber: true\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Reaction system with deduplication:"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",children:'channel:\n  namespaces:\n    - name: reactions\n      client_publication:\n        schemas: ["reaction"]\n        transform:\n          enabled: true\n          engine: js\n          js:\n            program: |\n              (function(input) {\n                var data = input.data;\n                return {\n                  data: {\n                    emoji: data.emoji,\n                    message_id: data.message_id,\n                    user_id: input.user\n                  },\n                  tags: {\n                    emoji_type: data.emoji,\n                    user: input.user\n                  },\n                  idempotency_key: input.user + ":" + data.message_id + ":" + data.emoji\n                };\n              })\n        allow_publish_for_subscriber: true\n'})}),"\n",(0,s.jsx)(e.h2,{id:"excluding-client-info",children:"Excluding client info"}),"\n",(0,s.jsx)(e.p,{children:"By default, Centrifugo includes client information in publications. For bandwidth optimization or privacy reasons, you can exclude this information:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "channel": {\n    "without_namespace": {\n      "client_publication": {\n        "exclude_client_info": true\n      },\n      "allow_publish_for_subscriber": true\n    }\n  }\n}\n'})}),"\n",(0,s.jsxs)(e.p,{children:["This prevents the ",(0,s.jsx)(e.code,{children:"info"})," field from being included in publications."]}),"\n",(0,s.jsxs)(e.admonition,{type:"tip",children:[(0,s.jsx)(e.p,{children:"Use this option when:"}),(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"You want to reduce bandwidth usage"}),"\n",(0,s.jsx)(e.li,{children:"Client identity is not needed by subscribers"}),"\n",(0,s.jsx)(e.li,{children:"You're using transformations to provide necessary metadata in publication data or tags"}),"\n"]})]}),"\n",(0,s.jsx)(e.h2,{id:"complete-example",children:"Complete example"}),"\n",(0,s.jsx)(e.p,{children:"Here's a comprehensive example combining all features with transformations:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "schemas": [\n    {\n      "name": "reaction",\n      "type": "jsonschema_draft_2020_12",\n      "definition": "{\\"type\\":\\"object\\",\\"properties\\":{\\"emoji\\":{\\"type\\":\\"string\\"},\\"message_id\\":{\\"type\\":\\"string\\"}},\\"required\\":[\\"emoji\\",\\"message_id\\"],\\"additionalProperties\\":false}"\n    }\n  ],\n  "channel": {\n    "patterns": true,\n    "namespaces": [\n      {\n        "name": "room_chat_reactions",\n        "pattern": "/rooms/:room_id/reactions",\n        "publication_data_format": "json",\n        "client_publication": {\n          "schemas": ["reaction"],\n          "transform": {\n            "enabled": true,\n            "engine": "jq",\n            "jq": {\n              "program": "{data: {emoji: .data.emoji, message_id: .data.message_id, user_id: .user}, tags: {room: .vars.room_id, user: .user}, idempotency_key: (.user + \\":\\" + .data.message_id + \\":\\" + .data.emoji)}"\n            }\n          },\n          "exclude_client_info": true\n        },\n        "allow_publish_for_subscriber": true\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:"Or in YAML for better readability:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-yaml",metastring:'title="config.yaml"',children:'schemas:\n  - name: reaction\n    definition: |\n      {\n        "type": "object",\n        "properties": {\n          "emoji": {"type": "string"},\n          "message_id": {"type": "string"}\n        },\n        "required": ["emoji", "message_id"]\n      }\n\nchannel:\n  patterns: true\n  namespaces:\n    - name: room_chat_reactions\n      pattern: /rooms/:room_id/reactions\n      publication_data_format: json\n      client_publication:\n        schemas: [reaction]\n        transform:\n          enabled: true\n          engine: jq\n          jq:\n            program: |\n              {\n                data: {\n                  emoji: .data.emoji,\n                  message_id: .data.message_id,\n                  user_id: .user\n                },\n                tags: {\n                  room: .vars.room_id,\n                  user: .user\n                },\n                idempotency_key: (.user + ":" + .data.message_id + ":" + .data.emoji)\n              }\n        exclude_client_info: true\n      allow_publish_for_subscriber: true\n'})}),"\n",(0,s.jsx)(e.h3,{id:"example-with-empty-binary-schema",children:"Example with Empty Binary Schema"}),"\n",(0,s.jsxs)(e.p,{children:["Here's an example using ",(0,s.jsx)(e.code,{children:"empty_binary"})," schema for a typing indicator:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "schemas": [\n    {\n      "name": "typing",\n      "type": "empty_binary"\n    }\n  ],\n  "channel": {\n    "patterns": true,\n    "namespaces": [\n      {\n        "name": "room_typing",\n        "pattern": "/rooms/:room_id/typing",\n        "publication_data_format": "binary",\n        "client_publication": {\n          "schemas": ["typing"],\n          "exclude_client_info": true\n        },\n        "allow_publish_for_subscriber": true\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"behavior",children:"Behavior"}),"\n",(0,s.jsx)(e.h3,{id:"schema-validation",children:"Schema validation"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Publications are validated ",(0,s.jsx)(e.strong,{children:"before"})," transformation and broadcast"]}),"\n",(0,s.jsx)(e.li,{children:"If validation fails, the client receives an error and the publication is rejected"}),"\n",(0,s.jsx)(e.li,{children:"Multiple schemas act as an OR condition - data must match at least one schema"}),"\n",(0,s.jsxs)(e.li,{children:["Schema names must reference schemas defined in the top-level ",(0,s.jsx)(e.code,{children:"schemas"})," array"]}),"\n",(0,s.jsxs)(e.li,{children:["The matched schema name is available to transformations via ",(0,s.jsx)(e.code,{children:"schema_name"})," variable"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"transformation-execution",children:"Transformation execution"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Transformations are executed ",(0,s.jsx)(e.strong,{children:"after"})," schema validation (if configured)"]}),"\n",(0,s.jsx)(e.li,{children:"Transform programs are compiled and validated at Centrifugo startup"}),"\n",(0,s.jsx)(e.li,{children:"If transformation fails, the client receives an error and the publication is rejected"}),"\n",(0,s.jsx)(e.li,{children:"Transformation output replaces the original publication data"}),"\n",(0,s.jsx)(e.li,{children:"Tags generated in transformations are attached to publications"}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"configuration-validation",children:"Configuration validation"}),"\n",(0,s.jsx)(e.p,{children:"Centrifugo validates configurations at startup:"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Schema validation:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Schema ",(0,s.jsx)(e.code,{children:"type"})," defaults to ",(0,s.jsx)(e.code,{children:"jsonschema_draft_2020_12"})," if not specified"]}),"\n",(0,s.jsxs)(e.li,{children:["JSON schemas (",(0,s.jsx)(e.code,{children:"jsonschema_draft_2020_12"}),") must have a ",(0,s.jsx)(e.code,{children:"definition"})," field"]}),"\n",(0,s.jsxs)(e.li,{children:["Empty binary schemas (",(0,s.jsx)(e.code,{children:"empty_binary"}),") must not have a ",(0,s.jsx)(e.code,{children:"definition"})," field"]}),"\n",(0,s.jsxs)(e.li,{children:["Schema type must be compatible with channel's ",(0,s.jsx)(e.code,{children:"publication_data_format"}),":","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"jsonschema_draft_2020_12"})," requires ",(0,s.jsx)(e.code,{children:'publication_data_format: "json"'})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"empty_binary"})," requires ",(0,s.jsx)(e.code,{children:'publication_data_format: "binary"'})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["All schemas referenced in ",(0,s.jsx)(e.code,{children:"client_publication.schemas"})," must exist"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Transformation validation:"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Transform programs are compiled at startup to validate syntax"}),"\n",(0,s.jsxs)(e.li,{children:["Program ",(0,s.jsx)(e.code,{children:"engine"})," must be either ",(0,s.jsx)(e.code,{children:"jq"})," or ",(0,s.jsx)(e.code,{children:"js"})]}),"\n",(0,s.jsxs)(e.li,{children:["Program ",(0,s.jsx)(e.code,{children:"program"})," field can be inline code or a file path"]}),"\n",(0,s.jsx)(e.li,{children:"If file path is used, file must exist and be readable"}),"\n",(0,s.jsx)(e.li,{children:"Invalid programs cause startup failure with descriptive error messages"}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"bottom-line",children:"Bottom line"}),"\n",(0,s.jsx)(e.p,{children:"Generally speaking all the existing namespace options like recovery/positioning, delta compression, channel batching controls will apply to namespaces with ephemeral client publications also. Then it depends on the specific use case whether you would like to apply those or not."}),"\n",(0,s.jsx)(e.h2,{id:"see-also",children:"See also"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/docs/pro/channel_patterns",children:"Channel patterns"})," - use pattern variables in publication tags"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.a,{href:"/docs/pro/rate_limiting",children:"Operation rate limiting"})," - rate limit ephemeral publications from client"]}),"\n"]})]})}function m(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}}}]);