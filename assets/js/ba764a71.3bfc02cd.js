"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[5474],{847:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/admin_idp_auth-92fc159f4d015d269d1666453dbee5e3.png"},7810:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"pro/admin_ui","title":"Admin UI: SSO, State Snapshots, and more","description":"Admin UI of Centrifugo OSS supports only one admin user identified by the preconfigured password. For the corporate and enterprise environments Centrifugo PRO provides a way to integrate with popular User Identity Providers (IDP), such as Okta, KeyCloak, Google Workspace, Azure and others. Most of the modern providers which support OpenID connect (OIDC) protocol with Proof Key for Code Exchange","source":"@site/docs/pro/admin_ui.md","sourceDirName":"pro","slug":"/pro/admin_ui","permalink":"/docs/pro/admin_ui","draft":false,"unlisted":false,"editUrl":"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/pro/admin_ui.md","tags":[],"version":"current","frontMatter":{"id":"admin_ui","sidebar_label":"Admin UI: SSO, Snapshots","title":"Admin UI: SSO, State Snapshots, and more"},"sidebar":"Pro","previous":{"title":"Operation rate limits","permalink":"/docs/pro/rate_limiting"},"next":{"title":"Client authentication","permalink":"/docs/pro/client_authentication"}}');var o=i(74848),t=i(28453);const r={id:"admin_ui",sidebar_label:"Admin UI: SSO, Snapshots",title:"Admin UI: SSO, State Snapshots, and more"},c=void 0,a={},d=[{value:"SSO for admin UI (OIDC)",id:"sso-for-admin-ui-oidc",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Configuring server-side OIDC",id:"configuring-server-side-oidc",level:3},{value:"Channels and Connections Snapshots",id:"channels-and-connections-snapshots",level:2},{value:"Configuration",id:"configuration-1",level:3},{value:"More data in admin UI",id:"more-data-in-admin-ui",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["Admin UI of Centrifugo OSS supports only one admin user identified by the preconfigured password. For the corporate and enterprise environments Centrifugo PRO provides a way to integrate with popular User ",(0,o.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Identity_provider",children:"Identity Providers"})," (IDP), such as Okta, KeyCloak, Google Workspace, Azure and others. Most of the modern providers which support ",(0,o.jsx)(n.a,{href:"https://openid.net/specs/openid-connect-core-1_0.html",children:"OpenID connect"})," (OIDC) protocol with ",(0,o.jsx)(n.a,{href:"https://oauth.net/2/pkce/",children:"Proof Key for Code Exchange"}),"\n(PKCE) and ",(0,o.jsx)(n.a,{href:"https://openid.net/specs/openid-connect-discovery-1_0.html",children:"OpenID Connect Discovery"})," are supported. This provides a way to integrate Centrifugo PRO into your existing ",(0,o.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Single_sign-on",children:"Single Sign-On"})," (SSO) infrastructure."]}),"\n",(0,o.jsx)(n.p,{children:"Also, Centrifugo PRO extends admin UI in other ways providing more data about the system state."}),"\n",(0,o.jsx)(n.h2,{id:"sso-for-admin-ui-oidc",children:"SSO for admin UI (OIDC)"}),"\n",(0,o.jsx)(n.p,{children:"As soon as OIDC integration configured, instead of password field Centrifugo PRO admin web UI shows a button to log in using a configured Identity Provider. As soon as user successfully logs in over the IDP, user is redirected back to Centrifugo admin UI. Centrifugo checks user's access token and permissions to access admin functionality upon every request to admin resources."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:i(847).A+"",width:"1972",height:"1012"})}),"\n",(0,o.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "admin": {\n    ...\n    "oidc": {\n      "enabled": true,\n      "display_name": "Keycloak",\n      "issuer": "http://localhost:8080/realms/master",\n      "client_id": "myclient",\n      "audience": "myclient",\n      "redirect_uri": "http://localhost:8000",\n      "extra_scopes": [],\n      "access_cel": "\'centrifugo_admins\' in claims.groups"\n    }\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.enabled"})," - boolean option which enables OIDC integration. When it's on, it's only possible to log in to Centrifugo over OIDC. By default, ",(0,o.jsx)(n.code,{children:"false"}),". Enabling OIDC also enables validation of the required options below."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.display_name"})," \u2013 required string, name of IDP to be displayed on login button."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.issuer"})," - required string, the URL identifier of Identity Provider which will issue tokens. It's used for initializing OIDC provider and used as a base for the OIDC endpoint discovery."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.client_id"})," - required string, identifier for registered client in IDP for OIDC integration with Centrifugo."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.audience"})," - optional string, if not set Centrifugo expects access token audience (",(0,o.jsx)(n.code,{children:"aud"}),") to match configured ",(0,o.jsx)(n.code,{children:"client_id"})," value (as required by the OIDC spec)."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.redirect_uri"})," - required string, redirect URI to use."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.extra_scopes"})," - optional array of extra string scopes to request from IDP. Centrifugo always includes ",(0,o.jsx)(n.code,{children:"openid"})," scope as it's required by OpenID Connect protocol."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.access_cel"})," \u2013 required string, this is a CEL expression which describes rule for checking access to Centrifugo admin resources. For now we don't provide RBAC \u2013 when this expression returns true the user gets full access to Centrifugo admin resources. If false \u2013 no access at all. For more information about what is CEL check out ",(0,o.jsx)(n.a,{href:"/docs/pro/cel_expressions",children:"Channel CEL expressions"})," chapter where CEL expressions are used for channel permission checks."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Let's look closer at ",(0,o.jsx)(n.code,{children:"admin.oidc.access_cel"}),". In the example above we check this based on a user group membership:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "admin": {\n    ...\n    "oidc": {\n      ...\n      "access_cel": "\'centrifugo_admins\' in claims.groups"\n    }\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["The expression may differ depending on IDP used \u2013 you can modify it to fit your case. Inside CEL you have access token ",(0,o.jsx)(n.code,{children:"claims"})," object with all claims of access token (which is JWT), so custom logic is possible. If you want to allow all authenticated users to access Centrifugo admin resources \u2013 then you can do the following:"]}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsx)(n.p,{children:"This is usually not recommended, since every new user in your IDP will get access to Centrifugo admin UI. Deciding based on groups or some other token attribute is more secure and flexible."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "admin": {\n    ...\n    "oidc": {\n      ...\n      "access_cel": "true"\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"configuring-server-side-oidc",children:"Configuring server-side OIDC"}),"\n",(0,o.jsxs)(n.p,{children:["Starting from Centrifugo PRO v6.5.2 a server-side OIDC flow is supported. In that case token exchange happens on the backend side using ",(0,o.jsx)(n.code,{children:"client_secret"}),", and Centrifugo uses HTTP-only cookie for the established authenticated session. In case of using server-side flow using ",(0,o.jsx)(n.code,{children:"https"})," for Centrifugo admin UI is required because cookie is set with a secure flag."]}),"\n",(0,o.jsxs)(n.p,{children:["To enable server-side OIDC flow, add the ",(0,o.jsx)(n.code,{children:"client_secret"})," option to your OIDC configuration:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "admin": {\n    ...\n    "secret": "long-secret-here-at-least-32-characters",\n    "oidc": {\n      "enabled": true,\n      "display_name": "OKTA",\n      "issuer": "https://your-domain.okta.com",\n      "client_id": "myclient",\n      "client_secret": "your-client-secret-here",\n      "audience": "myclient",\n      "redirect_uri": "https://centrifugo.example.com/admin/oidc/callback",\n      "extra_scopes": ["groups"],\n      "access_cel": "\'centrifugo_admins\' in claims.groups"\n    }\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"admin.oidc.client_secret"})," - optional string, when provided enables server-side OAuth2 flow. The client secret is registered in your Identity Provider for the Centrifugo client application."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"redirect_uri"})," must point to ",(0,o.jsx)(n.code,{children:"/admin/oidc/callback"})," path of Centrifugo admin UI."]}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsxs)(n.p,{children:["When using server-side OIDC (",(0,o.jsx)(n.code,{children:"client_secret"})," is configured), you ",(0,o.jsx)(n.strong,{children:"must"})," also set ",(0,o.jsx)(n.code,{children:"admin.secret"})," with at least 32 characters. This secret is used to encrypt ID tokens stored in HTTP-only cookies, providing additional security for the authentication flow."]})}),"\n",(0,o.jsxs)(n.p,{children:["When ",(0,o.jsx)(n.code,{children:"client_secret"})," is configured:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:'User clicks "Log in" button and is redirected to the Identity Provider'}),"\n",(0,o.jsx)(n.li,{children:"After successful authentication, the IDP redirects back to Centrifugo with an authorization code"}),"\n",(0,o.jsx)(n.li,{children:"Centrifugo backend exchanges the code for tokens using the client secret (this happens server-side)"}),"\n",(0,o.jsxs)(n.li,{children:["Centrifugo validates the ID token and checks permissions using the ",(0,o.jsx)(n.code,{children:"access_cel"})," expression"]}),"\n",(0,o.jsxs)(n.li,{children:["The ID token is encrypted using ",(0,o.jsx)(n.code,{children:"admin.secret"})," and stored in a secure HTTP-only cookie"]}),"\n",(0,o.jsx)(n.li,{children:"All subsequent admin UI requests are authenticated by decrypting and validating the cookie"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["The choice between PKCE and server-side flow depends on your security requirements and infrastructure. For most cases, PKCE flow (without ",(0,o.jsx)(n.code,{children:"client_secret"}),") is sufficient and easier to set up."]}),"\n",(0,o.jsx)(n.h2,{id:"channels-and-connections-snapshots",children:"Channels and Connections Snapshots"}),"\n",(0,o.jsx)(n.p,{children:"This feature allows using admin web UI to inspect current connections and channels state. It allows to:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"See current connections and channels state in the cluster"}),"\n",(0,o.jsx)(n.li,{children:"Search connections by user ID, inspect subscribers of the channel"}),"\n",(0,o.jsx)(n.li,{children:"See connection details: transport, client info, subscribed channels, how subscription was made, connection latency (for bidirectional transports only), connection time, etc."}),"\n",(0,o.jsx)(n.li,{children:"Disconnect/Reconnect a specific connection"}),"\n",(0,o.jsxs)(n.li,{children:["Integrates with Centrifugo PRO ",(0,o.jsx)(n.a,{href:"/docs/pro/tracing",children:"Tracing"})," to trace particular channel or particular connection in real-time."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Centrifugo PRO saves snapshot metadata to PostgreSQL database. The connections and channels raw data is effectively inserted to ClickHouse from each node during collection, so there is no expensive inter-node communication. Snapshot raw data in ClickHouse expires in 14 days by default."}),"\n",(0,o.jsx)("video",{width:"100%",loop:!0,autoPlay:"autoplay",muted:!0,controls:!0,src:"/img/snapshots_demo.mp4"}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsx)(n.p,{children:"This feature is in beta state now. Use with caution in production. Snapshot collection may add memory and CPU overhead to Centrifugo nodes."})}),"\n",(0,o.jsx)(n.h3,{id:"configuration-1",children:"Configuration"}),"\n",(0,o.jsxs)(n.p,{children:["To enable Snapshots feature you need to turn on admin web UI, enable ",(0,o.jsx)(n.code,{children:"snapshots"})," inside ",(0,o.jsx)(n.code,{children:"clickhouse_analytics"})," section and also enable ",(0,o.jsx)(n.code,{children:"database"})," section with PostgreSQL."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",metastring:'title="config.json"',children:'{\n  "admin": {\n    "enabled": true,\n    "password": "secure-password-here",\n    "secret": "long-secret-here"\n  },\n  "clickhouse_analytics": {\n    "enabled": true,\n    "clickhouse_dsn": [\n      "tcp://default:default@127.0.0.1:9000",\n    ],\n    "clickhouse_database": "centrifugo",\n    "clickhouse_cluster": "centrifugo_cluster",\n    "snapshots": {\n      "enabled": true\n    }\n  },\n  "database": {\n    "enabled": true,\n    "postgresql": {\n      "dsn": "postgres://test:test@localhost:5432/test?sslmode=disable"\n    }\n  }\n}\n'})}),"\n",(0,o.jsx)(n.admonition,{type:"caution",children:(0,o.jsx)(n.p,{children:"Centrifugo PRO supports snapshot export only over ClickHouse native TCP protocol these days."})}),"\n",(0,o.jsx)(n.h2,{id:"more-data-in-admin-ui",children:"More data in admin UI"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"an ability to show: CPU and RSS memory usage of each node, updated in near real-time"}),"\n",(0,o.jsxs)(n.li,{children:["show aggregations over ",(0,o.jsx)(n.code,{children:"node.info_metrics_aggregate_interval"})," for each node:"]}),"\n",(0,o.jsx)(n.li,{children:"Distribution by client name"}),"\n",(0,o.jsx)(n.li,{children:"Client incoming frames rate"}),"\n",(0,o.jsx)(n.li,{children:"Client outgoing frames rate"}),"\n",(0,o.jsx)(n.li,{children:"Client connect rate"}),"\n",(0,o.jsx)(n.li,{children:"Client subscribe rate"}),"\n",(0,o.jsx)(n.li,{children:"Server API calls rate"}),"\n",(0,o.jsx)(n.li,{children:"Publication rate"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Here is how this looks like:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"PRO UI",src:i(81278).A+"",width:"2542",height:"1010"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>c});var s=i(96540);const o={},t=s.createContext(o);function r(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(t.Provider,{value:n},e.children)}},81278:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/pro_admin_ui_status-94bc6163ec43a17491bf3cb82f8c87a2.jpg"}}]);