<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Centrifugo v4 released – a little revolution | Centrifugo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://centrifugal.dev/blog/2022/07/19/centrifugo-v4-released"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Centrifugo v4 released – a little revolution | Centrifugo"><meta data-rh="true" name="description" content="Centrifugo v4 provides an optimized client protocol, modern WebSocket emulation, improved channel security, redesigned client SDK behavior, experimental HTTP/3 and WebTransport support."><meta data-rh="true" property="og:description" content="Centrifugo v4 provides an optimized client protocol, modern WebSocket emulation, improved channel security, redesigned client SDK behavior, experimental HTTP/3 and WebTransport support."><meta data-rh="true" property="og:image" content="https://centrifugal.dev/img/v4_thumb.jpg"><meta data-rh="true" name="twitter:image" content="https://centrifugal.dev/img/v4_thumb.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-07-19T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="centrifugo,release"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://centrifugal.dev/blog/2022/07/19/centrifugo-v4-released"><link data-rh="true" rel="alternate" href="https://centrifugal.dev/blog/2022/07/19/centrifugo-v4-released" hreflang="en"><link data-rh="true" rel="alternate" href="https://centrifugal.dev/blog/2022/07/19/centrifugo-v4-released" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EPXZ1LXJ33-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://centrifugal.dev/blog/2022/07/19/centrifugo-v4-released","mainEntityOfPage":"https://centrifugal.dev/blog/2022/07/19/centrifugo-v4-released","url":"https://centrifugal.dev/blog/2022/07/19/centrifugo-v4-released","headline":"Centrifugo v4 released – a little revolution","name":"Centrifugo v4 released – a little revolution","description":"Centrifugo v4 provides an optimized client protocol, modern WebSocket emulation, improved channel security, redesigned client SDK behavior, experimental HTTP/3 and WebTransport support.","datePublished":"2022-07-19T00:00:00.000Z","author":{"@type":"Person","name":"Centrifugal team","description":"Let the Centrifugal force be with you","image":"/img/logo_animated.svg"},"image":{"@type":"ImageObject","@id":"https://centrifugal.dev/img/v4_thumb.jpg","url":"https://centrifugal.dev/img/v4_thumb.jpg","contentUrl":"https://centrifugal.dev/img/v4_thumb.jpg","caption":"title image for the blog post: Centrifugo v4 released – a little revolution"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://centrifugal.dev/blog","name":"Centrifugal Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title=" RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title=" Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title=" JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NZRQD92LEX"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-NZRQD92LEX",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Centrifugo" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"><link rel="stylesheet" href="/assets/css/styles.356fee74.css">
<script src="/assets/js/runtime~main.2ec98a91.js" defer="defer"></script>
<script src="/assets/js/main.c2d40ce1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Centrifugo</b></a><a class="navbar__item navbar__link" href="/docs/getting-started/introduction">Getting Started</a><a class="navbar__item navbar__link" href="/docs/server/configuration">Server guide</a><a class="navbar__item navbar__link" href="/docs/transports/overview">Real-time transports / SDK</a><a class="navbar__item navbar__link" href="/docs/pro/overview">Centrifugo PRO ♻️</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a><a class="navbar__item navbar__link" href="/docs/tutorial/intro">Grand tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/centrifugal/centrifugo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/getting-started/introduction">v6</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/getting-started/introduction">v6</a></li><li><a class="dropdown__link" href="/docs/5/getting-started/introduction">v5</a></li><li><a class="dropdown__link" href="/docs/4/getting-started/introduction">v4</a></li><li><a class="dropdown__link" href="/docs/3/getting-started/introduction">v3</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="title_f1Hy">Centrifugo v4 released – a little revolution</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-07-19T00:00:00.000Z">July 19, 2022</time> · <!-- -->21 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="/img/logo_animated.svg" alt="Centrifugal team"><div class="avatar__intro"><div class="avatar__name"><span>Centrifugal team</span></div><small class="avatar__subtitle">Let the Centrifugal force be with you</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p><img decoding="async" loading="lazy" alt="Centrifuge" src="/assets/images/v4-4baf3679e084bb717a98b3264c423c3c.jpg" width="2000" height="931" class="img_ev3q"></p>
<p>Today we are excited to announce the next generation of Centrifugo – Centrifugo v4. The release takes Centrifugo to the next level in terms of client protocol performance, WebSocket fallback simplicity, SDK ecosystem and channel security model. It also comes with a couple of cutting-edge technologies to experiment with such as HTTP/3 and WebTransport.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>About Centrifugo</div><div class="admonitionContent_BuS1"><p>If you&#x27;ve never heard of Centrifugo before, it&#x27;s an open-source scalable real-time messaging server written in Go language. Centrifugo can instantly deliver messages to application online users connected over supported transports (WebSocket, HTTP-streaming, SSE/EventSource, GRPC, SockJS). Centrifugo has the concept of a channel – so it&#x27;s a user-facing PUB/SUB server.</p><p>Centrifugo is language-agnostic and can be used to build chat apps, live comments, multiplayer games, real-time data visualizations, collaborative tools, etc. in combination with any backend. It is well suited for modern architectures and allows decoupling the business logic from the real-time transport layer.</p><p>Several official client SDKs for browser and mobile development wrap the bidirectional protocol. In addition, Centrifugo supports a unidirectional approach for simple use cases with no SDK dependency.</p></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="centrifugo-v3-flashbacks">Centrifugo v3 flashbacks<a href="#centrifugo-v3-flashbacks" class="hash-link" aria-label="Direct link to Centrifugo v3 flashbacks" title="Direct link to Centrifugo v3 flashbacks">​</a></h2>
<p>Let&#x27;s start from looking back a bit. Centrifugo v3 was released last year. It had a great list of improvements – like unidirectional transports support (EventSource, HTTP-streaming and GRPC), GRPC transport for proxy, history iteration API, faster JSON protocol, super-fast but experimental Tarantool engine implementation, and others.</p>
<p>During the Centrifugo v3 lifecycle we added even more JSON protocol optimizations and introduced a granular proxy mode. Experimental Tarantool engine has also evolved a bit.</p>
<p>But Centrifugo v3 did not contain anything... let&#x27;s say <strong>revolutional</strong>. Revolutional for Centrifugo itself, community, or even the entire field of open-source real-time messaging.</p>
<p>With this release, we feel that we bring innovation to the ecosystem. Now let&#x27;s talk about it and introduce all the major things of the brand new v4 release.</p>
<video width="100%" loop="" autoplay="" muted="" src="/img/v4_logo.mp4"></video>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="unified-client-sdk-api">Unified client SDK API<a href="#unified-client-sdk-api" class="hash-link" aria-label="Direct link to Unified client SDK API" title="Direct link to Unified client SDK API">​</a></h2>
<p>The most challenging part of Centrifugo project is not a server itself. Client SDKs are the hardest part of the ecosystem. We try to time additional improvements to the SDKs with each major release of the server. But this time the SDKs are the centerpiece of the v4 release.</p>
<p>Centrifugo uses bidirectional asynchronous protocol between client and server. On top of this protocol SDK provides a request-response over an asynchronous connection, reconnection logic, subscription management and multiplexing, timeout and error handling, ping-pong, token refresh, etc. Some of these things are not that trivial to implement. And all this should be implemented in different programming languages. As you may know, we have official real-time SDKs in Javascript, Dart, Swift, Java and Go.</p>
<p>While implementing the same protocol and same functions, all SDKs behaved slightly differently. That was the result of the missing SDK specification. Without a strict SDK spec, it was hard to document things, hard to explain the exact details of the real-time SDK behavior. What we did earlier in the Centrifugo documentation – was pointing users to specific SDK Github repo to look for behaviour details.</p>
<p>The coolest thing about Centrifugo v4 is the next generation SDK API. We now have a <a href="/docs/transports/client_api">client SDK API specification</a>. It&#x27;s a source of truth for SDKs behavior which try to follow the spec closely.</p>
<p>The new SDK API is the result of several iterations and reflections on possible states, transitions, token refresh mechanism, etc. Users in our Telegram group may remember how it all started:</p>
<p><img decoding="async" loading="lazy" alt="Centrifugo scheme" src="/assets/images/states_prototype-104a12d8315c3ad7dfd6fc983979e134.jpg" width="1280" height="960" class="img_ev3q"></p>
<p>And after several iterations these prototypes turned into working mechanisms with well-defined behaviour:</p>
<p><img decoding="async" loading="lazy" alt="Centrifugo scheme" src="/assets/images/client_state-34264b7a7eee2792baa58bb5bb525d46.png" width="2352" height="1700" class="img_ev3q"></p>
<p>A few things that have been revised from the ground up:</p>
<ul>
<li>Client states, transitions, events</li>
<li>Subscription states, transitions, events</li>
<li>Connection and subscription token refresh behavior</li>
<li>Ping-pong behavior (see details below)</li>
<li>Resubscribe logic (SDKs can now resubscribe with backoff)</li>
<li>Error handling</li>
<li>Unified backoff behavior (based on <a href="https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/" target="_blank" rel="noopener noreferrer">full jitter technique</a>)</li>
</ul>
<p>We now also have a separation between temporary and non-temporary protocol errors – this allows us to handle subscription internal server errors on the SDK level, making subscriptions more resilient, with automatic resubscriptions, and to ensure individual subscription failures do not affect the entire connection.</p>
<p>The mechanics described in the client SDK API specification are now implemented in all of our official SDKs. The SDKs now support all major client protocol features that currently exist. We believe this is a big step forward for the Centrifugo ecosystem and community.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="modern-websocket-emulation-in-javascript">Modern WebSocket emulation in Javascript<a href="#modern-websocket-emulation-in-javascript" class="hash-link" aria-label="Direct link to Modern WebSocket emulation in Javascript" title="Direct link to Modern WebSocket emulation in Javascript">​</a></h2>
<p>WebSocket is supported almost everywhere these days. But there is a case that we believe is the last one preventing users to connect over WebSocket - corporate proxies. With the root certificate installed on employee computer machines, these proxies can block WebSocket traffic, even if it&#x27;s wrapped in a TLS layer. That&#x27;s really annoying, and often developers choose to not support clients connecting from such &quot;broken&quot; environments at all.</p>
<p>Prior to v4, Centrifugo users could use the SockJS polyfill library to fill this gap.</p>
<p>SockJS is great software – stable and field proven. It is still used by some huge real-time messaging players out there to polyfill the WebSocket transport.</p>
<p>But SockJS is an extra frontend dependency with a bunch of legacy transports, and <a href="https://github.com/sockjs/sockjs-client/issues/592" target="_blank" rel="noopener noreferrer">the future of it is unknown</a>.</p>
<p>SockJS comes with a notable overhead  – it&#x27;s an aditional protocol wrapper, consumes more memory per connection on a server (at least when using SockJS-Go library – the only choice for implementing SockJS server in Go language these days). When using SockJS, Centrifugo users were losing the ability to use our main pure WebSocket transport because SockJS uses its own WebSocket implementation on a server side.</p>
<p>SockJS does not support binary data transfer – only JSON format can be used with it. As you know, our main WebSocket transport works fine with binary in case of using Protobuf protocol format. So with SockJS we don&#x27;t have fallback for WebSocket with a binary data transfer.</p>
<p>And finally, if you want to use SockJS with a distributed backend, you must enable sticky session support on the load-balancer level. This way you can point requests from the client to the server to the correct server node – the one which maintains a persistent unidirectional HTTP connection.</p>
<p>We danced around the idea of replacing SockJS for a long time. But only now we are ready to provide our alternative to it – meet Centrifugo own <strong>bidirectional emulation layer</strong>. It&#x27;s based on two additional transports:</p>
<ul>
<li>HTTP-streaming (using modern browser <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream" target="_blank" rel="noopener noreferrer">ReadableStream API</a> in JavaScript, supports both binary Protobuf and JSON transfer)</li>
<li>Eventsource (Server-Sent Events, SSE) – while a bit older choice and works with JSON only EventSource transport is loved by many developers and can provide fallback in slightly older browsers which don&#x27;t have ReadableStream, so we implemented bidirectional emulation with it too.</li>
</ul>
<p>So when the fallback is used, you always have a real-time, persistent connection in server -&gt; to -&gt; client direction. Requests in client -&gt; to -&gt; server direction are regular HTTP – similar to how SockJS works. But our bidirectional emulation layer does not require sticky sessions – Centrifugo can proxy client-to-server requests to the correct node in the cluster. <strong>Having sticky sessions is an optimization</strong> for Centrifugo bidirectional emulation layer, <strong>not a requirement</strong>. We believe that this is a game changer for our users – no need to bother about proper load balancing, especially since in most cases 95% or even more users will be able to connect using the WebSocket transport.</p>
<p>Here is a simplified diagram of how it works:</p>
<p><img decoding="async" loading="lazy" alt="Scheme" src="/assets/images/emulation_scheme-7488282ce671166bd0ca4369bb8af842.png" width="2713" height="1474" class="img_ev3q"></p>
<p>The bidirectional emulation layer is only supported by the Javascript SDK (<code>centrifuge-js</code>) – as we think fallbacks mostly make sense for browsers. If we find use cases where other SDKs can benefit from HTTP based transport – we can expand on them later.</p>
<p>Let&#x27;s look at example of using this feature from the Javascript side. To use fallbacks, all you need to do is to set up a list of desired transports with endpoints:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> transports </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">transport</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;websocket&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">endpoint</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;wss://your_centrifugo.com/connection/websocket&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">transport</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http_stream&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">endpoint</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;https://your_centrifugo.com/connection/http_stream&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">transport</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;sse&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">endpoint</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;https://your_centrifugo.com/connection/sse&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> centrifuge </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Centrifuge</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">transports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">centrifuge</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>We are using explicit transport endpoints in the above example due to the fact that transport endpoints can be configured separately in Centrifugo – there is no single entry point for all transports. Like the one in Socket.IO or SockJS when developer can only point client to the base address. In Centrifugo case, we are requesting an explicit transport/endpoint configuration from the SDK user.</p></div></div>
<p>By the way, a few advantages of HTTP-based transport over WebSocket:</p>
<ul>
<li>Sessions can be automatically multiplexed within a single connection by the browser when the server is running over HTTP/2, while with WebSocket browsers open a separate connection in each browser tab</li>
<li>Better compression support (may be enabled on load balancer level)</li>
<li>WebSocket requires special configuration in some load balancers to get started (ex. Nginx)</li>
</ul>
<p>SockJS is still supported by Centrifugo and <code>centrifuge-js</code>, but it&#x27;s now DEPRECATED.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="no-layering-in-client-protocol">No layering in client protocol<a href="#no-layering-in-client-protocol" class="hash-link" aria-label="Direct link to No layering in client protocol" title="Direct link to No layering in client protocol">​</a></h2>
<p>Not only the API of client SDK has changed, but also the format of Centrifugo protocol messages. New format is more human-readable (in JSON case, of course), has a more compact ping message size (more on that below).</p>
<p>The client protocol is now one-shot encode/decode compatible. Previously, Centrifugo protocol had a layered structure and we had to encode some messages before appending them to the top-level message. Or decode two or three times to unwrap the message envelope. To achieve good performance when encoding and decoding client protocol messages, Centrifugo had to use various optimization techniques – like buffer memory pools, byte slice memory pools.</p>
<p>By restructuring the message format, we were able to avoid layering, which allowed us to slightly increase the performance of encoding/decoding without additional optimization tricks.</p>
<p><img decoding="async" loading="lazy" alt="Scheme" src="/assets/images/avoid_protocol_nesting-fb312e08bc008cbd7d4318c9c8357b44.png" width="4796" height="833" class="img_ev3q"></p>
<p>We also simplified the <a href="/docs/transports/client_protocol">client protocol</a> documentation overview a bit.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="redesigned-ping-pong">Redesigned PING-PONG<a href="#redesigned-ping-pong" class="hash-link" aria-label="Direct link to Redesigned PING-PONG" title="Direct link to Redesigned PING-PONG">​</a></h2>
<p>In many cases in practice (when dealing with persistent connections like WebSocket), pings and pongs are the most dominant types of messages passed between client and server. Your application may have many concurrent connections, but only a few of them receive the useful payload. But at the same time, we still need to send pings and respond with pongs. Thus, optimizing the ping-pong process can significantly reduce server resource usage.</p>
<p>One optimization comes from the revised PING-PONG behaviour. Previous versions of Centrifugo and SDKs sent ping/pong in both &quot;client-&gt;to-&gt;server&quot; and &quot;server-&gt;to-&gt;client&quot; directions (for WebSocket transport). This allowed finding non-active connections on both client and server sides.</p>
<p>In Centrifugo v4 we only send pings from a server to a client and expect pong from a client. On the client-side, we have a timer which fires if there hasn&#x27;t been a ping from the server within the configured time, so we still have a way to detect closed connections.</p>
<p>Sending pings only in one direction results in 2 times less ping-pong messages - and this should be really noticable for Centrifugo installations with thousands of concurrent connections. In our experiments with 10k connections, server CPU usage was reduced by 30% compared to Centrifugo v3.</p>
<p><img decoding="async" loading="lazy" alt="Scheme" src="/assets/images/ping_pong_v3_v4-b6f5699b9dc3e68059833185661a1f1f.png" width="2767" height="1445" class="img_ev3q"></p>
<p>Pings and pongs are application-level messages. Ping is just an empty asynchronous reply – for example in JSON case it&#x27;s a 2-byte message: <code>{}</code>. Pong is an empty command – also, <code>{}</code> in JSON case. Having application-level pings from the server also allows unifying the PING format for all unidirectional transports.</p>
<p>Another improvement is that Centrifugo now randomizes the time it sends first ping to the client (but no longer than the configured ping interval). This allows to spread ping-pongs in time, providing a smoother CPU profile, especially after a massive reconnect scenario.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="secure-by-default-channel-namespaces">Secure by default channel namespaces<a href="#secure-by-default-channel-namespaces" class="hash-link" aria-label="Direct link to Secure by default channel namespaces" title="Direct link to Secure by default channel namespaces">​</a></h2>
<p>Data security and privacy are more important than ever in today&#x27;s world. And as Centrifugo becomes more popular and widely used, the need to be <code>secure by default</code> only increases.</p>
<p>Previously, by default, clients could subcribe to all channels in a namespace (except private channels, which are now revised – see details below). It was possible to use <code>&quot;protected&quot;: true</code> option to make namespace protected, but we are not sure if everyone did that. This is extra configuration and additional knowledge on how Centrifugo works.</p>
<p>Also, a common confusion we ran into: if server-side subscriptions were dictated by a connection JWT, many users would expect client-side subscriptions to those channels to not work. But without the <code>protected</code> option enabled, this was not the case.</p>
<p>In Centrifugo v4, by default, it is not possible to subscribe to a channel in a namespace. The namespace must be configured to allow subscriptions from clients, or token authorization must be used. There are a bunch of new namespace options to tune the namespace behavior. Also the ability to provide a regular expression for channels in the namespace.</p>
<p>The new permission-related channel option names better reflect the purpose of the option. For example, compare <code>&quot;publish&quot;: true</code> and <code>&quot;allow_publish_for_client&quot;: true</code>. The second one is more readable and provides a better understanding of the effect once turned on.</p>
<p>Centrifugo is now more strict when checking channel name. Only ASCII symbols allowed – it was already mentioned in docs before, but wasn&#x27;t actually enforced. Now we are fixing this.</p>
<p>We understand that these changes will make running Centrifugo more of a challenge, especially when all you want is a public access to all the channels without worrying too much about permissions. It&#x27;s still possible to achieve, but now the intent must be expicitly expressed in the config.</p>
<p>Check out the updated documentation about <a href="/docs/server/channels">channels and namespaces</a>. Our v4 migration guide contains an <strong>automatic converter</strong> for channel namespace options.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="private-channel-concept-revised">Private channel concept revised<a href="#private-channel-concept-revised" class="hash-link" aria-label="Direct link to Private channel concept revised" title="Direct link to Private channel concept revised">​</a></h2>
<p>A private channel is a special channel starting with <code>$</code> that could not be subscribed to without a subscription JWT. Prior to v4, having a known prefix allowed us to distinguish between public channels and private channels. But since namespaces are now non-public by default, this distinction is not really important.</p>
<p>This means 2 things:</p>
<ul>
<li>it&#x27;s now possible to subscribe to any channel by having a valid subscription JWT (not just those that start with <code>$</code>)</li>
<li>channels beginning with <code>$</code> can only be subscribed with a subscription JWT, even if they belong to a namespace where subscriptions allowed for all clients. This is for security compatibility between v3 and v4.</li>
</ul>
<p>Another notable change in a subscription JWT – <code>client</code> claim is now DEPRECATED. There is no need to put it in the subscription token anymore. Centrifugo supports it only for backwards compatibility, but it will be completely removed in the future releases.</p>
<p>The reason we&#x27;re removing <code>client</code> claim is actually interesting. Due to the fact that <code>client</code> claim was a required part of the subscription JWT applications could run into a situation where during the <a href="/blog/2020/11/12/scaling-websocket#massive-reconnect">massive reconnect scenario</a> (say, million connections reconnect) many requests for new subscription tokens can be generated because the subscription token must contain the client ID generated by Centrifugo for the new connection. That could make it unusually hard for the application backend to handle the load. With a connection JWT we had no such problem – as connections could simply reuse the previous token to reconnect to Centrifugo.</p>
<p>Now the subscription token behaves just like the connection token, so we get a scalable solution for token-based subscriptions as well.</p>
<p>What&#x27;s more, this change paved the way for another big improvement...</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="optimistic-subscriptions">Optimistic subscriptions<a href="#optimistic-subscriptions" class="hash-link" aria-label="Direct link to Optimistic subscriptions" title="Direct link to Optimistic subscriptions">​</a></h2>
<p>The improvement we just mentioned is called optimistic subscriptions. If any of you are familiar with the <a href="https://en.wikipedia.org/wiki/QUIC" target="_blank" rel="noopener noreferrer">QUIC</a> protocol, then optimistic subscriptions are somewhat similar to the 0-RTT feature in QUIC. The idea is simple – we can include subscription commands to the first frame sent to the server.</p>
<p>Previously, we sent subscriptions only after receiving a successful Connect Reply to a Connect Command from a server. But with the new changes in token behaviour, it seems so logical to put subscribe commands within the initial connect frame. Especially since Centrifugo protocol always supported batching of commands. Even token-based subscriptions can now be included into the initial frame during reconnect process, since the previous token can be reused now.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/optimistic_subs-8a424a694e135797511598c93f3fb23b.png" width="3498" height="1143" class="img_ev3q"></p>
<p>The benefit is awesome – in most scenarios, we save one RTT of latency when connecting to Centrifugo and subscribing to channels (which is actually the most common way to use Centrifugo). While not visible on localhost, this is pretty important in real-life. And this is less syscalls for the server after all, resulting in less CPU usage.</p>
<p>Optimistic subscriptions are also great for bidirectional emulation with HTTP, as they avoid the long path of proxying a request to the correct Centrifugo node when connecting.</p>
<p>Optimistic subscriptions are now only part of <code>centrifuge-js</code>. At some point, we plan to roll out this important optimization to all other client SDKs.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="channel-capabilities">Channel capabilities<a href="#channel-capabilities" class="hash-link" aria-label="Direct link to Channel capabilities" title="Direct link to Channel capabilities">​</a></h2>
<p>The channel capabilities feature is introduced as part of <a href="/docs/pro/overview">Centrifugo PRO</a>. Initially, we aimed to make it a part of the OSS version. But the lack of feedback on this feature made us nervous it&#x27;s really needed. So adding it to PRO, where we still have room to evaluate the idea, seemed like the safer decision at the moment.</p>
<p>Centrifugo allows configuring channel permissions on a per-namespace level. When creating a new real-time feature, it is recommended to create a new namespace for it and configure permissions. But to achieve a better channel permission control within a namespace the Channel capabilities can be used now.</p>
<p>The channel capability feature provides a possibility to set capabilities on an individual connection basis, or an individual channel subscription basis.</p>
<p>For example, in a connection JWT developers can set sth like:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;caps&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;channels&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;news&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;user_42&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;allow&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sub&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And this tells Centrifugo that the connection is able to subscribe on channels <code>news</code> or <code>user_42</code> using client-side subscriptionsat any time while the connection is active. Centrifugo also supports wildcard and regex channel matches.</p>
<p>Subscription JWT can provide capabilities for the channel too, so permissions may be controlled on an individual subscription basis, ex. the ability to publish and call history API may be expressed with <code>allow</code> claim in subscription JWT:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;allow&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;pub&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;hst&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Read more about this mechanism in <a href="/docs/pro/capabilities">Channel capabilities</a> chapter.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="better-connections-api">Better connections API<a href="#better-connections-api" class="hash-link" aria-label="Direct link to Better connections API" title="Direct link to Better connections API">​</a></h2>
<p>Another addition to Centrifugo PRO is the improved <a href="/docs/pro/connections">connection API</a>. Previously, we could only return all connections from a specific user.</p>
<p>The API now supports filtering all connections: by user ID, by subscribed channel, by additional meta information attached to the connection.</p>
<p>The filtering works by user ID or with a help of <a href="https://opensource.google/projects/cel" target="_blank" rel="noopener noreferrer">CEL expressions</a> (Common Expression Language). CEL expressions provide a developer-friendly, fast and secure (as they are not Turing-complete) way to evaluate some conditions. They are used in some Google services (ex. Firebase), in Envoy RBAC configuration, etc. If you&#x27;ve never seen it before – take a look, cool project. We are also evaluating how to use CEL expressions for a dynamic and efficient channel permission checks, but that&#x27;s an early story.</p>
<p>The <code>connections</code> API call result contains more useful information: a list of client&#x27;s active channels, information about the tokens used to connect and subscribe, meta information attached to the connection.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="javascript-client-moved-to-typescript">Javascript client moved to TypeScript<a href="#javascript-client-moved-to-typescript" class="hash-link" aria-label="Direct link to Javascript client moved to TypeScript" title="Direct link to Javascript client moved to TypeScript">​</a></h2>
<p>It&#x27;s no secret that <code>centrifuge-js</code> is the most popular SDK in the Centrifugo ecosystem. We put additional love to it – and <code>centrifuge-js</code> is now fully written in Typescript ❤️</p>
<p>This was a long awaited improvement, and it finally happened! The entire public API is strictly typed. The cool thing is that even <code>EventEmitter</code> events and event handlers are the subject to type checks - this should drastically simplify and speedup development and also help to reduce error possibility.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="experimenting-with-http3">Experimenting with HTTP/3<a href="#experimenting-with-http3" class="hash-link" aria-label="Direct link to Experimenting with HTTP/3" title="Direct link to Experimenting with HTTP/3">​</a></h2>
<p>Centrifugo v4 has an <strong>experimental</strong> <a href="https://en.wikipedia.org/wiki/HTTP/3" target="_blank" rel="noopener noreferrer">HTTP/3</a> support. Once TLS is enabled and <code>&quot;http3&quot;: true</code> option is set all the endpoints on an external port will be served by a HTTP/3 server based on <a href="https://github.com/lucas-clemente/quic-go" target="_blank" rel="noopener noreferrer">lucas-clemente/quic-go</a> implementation.</p>
<p>It&#x27;s worth noting that WebSocket will still use HTTP/1.1 for its Upgrade request (there is an interesting IETF draft BTW about <a href="https://www.ietf.org/archive/id/draft-ietf-httpbis-h3-websockets-02.html" target="_blank" rel="noopener noreferrer">Bootstrapping WebSockets with HTTP/3</a>). But HTTP-streaming and EventSource should work just fine with HTTP/3.</p>
<p>HTTP/3 does not currently work with our ACME autocert TLS - i.e. you need to explicitly provide paths to cert and key files <a href="/docs/server/tls#using-crt-and-key-files">as described here</a>.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="experimenting-with-webtransport">Experimenting with WebTransport<a href="#experimenting-with-webtransport" class="hash-link" aria-label="Direct link to Experimenting with WebTransport" title="Direct link to Experimenting with WebTransport">​</a></h2>
<p>Having HTTP/3 on board allowed us to make one more thing. Some of you may remember the post <a href="/blog/2020/10/16/experimenting-with-quic-transport">Experimenting with QUIC and WebTransport</a> published in our blog before. We danced around the idea to add <a href="https://web.dev/webtransport/" target="_blank" rel="noopener noreferrer">WebTransport</a> to Centrifugo since then. <a href="https://datatracker.ietf.org/doc/draft-ietf-webtrans-http3/" target="_blank" rel="noopener noreferrer">WebTransport IETF specification</a> is still a draft, it changed a lot since our first blog post about it. But WebTransport object is already part of Chrome (since v97) and things seem to be very close to the release.</p>
<p>So we added experimental WebTransport support to Centrifugo v4. This is made possible with the help of the <a href="https://github.com/marten-seemann/webtransport-go" target="_blank" rel="noopener noreferrer">marten-seemann/webtransport-go</a> library.</p>
<p>To use WebTransport you need to run HTTP/3 experimental server and enable WebTransport endpoint with <code>&quot;webtransport&quot;: true</code> option in the configuration. Then you can connect to that endpoint using <code>centrifuge-js</code>. For example, let&#x27;s enable WebTransport and use WebSocket as a fallback option:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> transports </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">transport</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;webtransport&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">endpoint</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;https://your_centrifugo.com/connection/webtransport&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">transport</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;websocket&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token literal-property property">endpoint</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;wss://your_centrifugo.com/connection/websocket&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> centrifuge </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Centrifuge</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">transports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">centrifuge</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">connect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note, that we are using secure schemes here – <code>https://</code> and <code>wss://</code>. While in WebSocket case you could opt for non-TLS communication, in HTTP/3 and specifically WebTransport non-TLS communication is simply not supported by the specification.</p>
<p>In Centrifugo case, we utilize the bidirectional reliable stream of WebTransport to pass our protocol between client and server. Both JSON and Protobuf communication formats are supported. There are some issues with the proper passing of the disconnect advice in some cases, otherwise it&#x27;s fully functional.</p>
<p>Obviously, due to the limited WebTransport support in browsers at the moment, possible breaking changes in the WebTransport specification we can not recommended it for production usage for now. At some point in the future, it may become a reasonable alternative to WebSocket, now we are more confident that Centrifugo will be able to provide a proper support of it.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="migration-guide">Migration guide<a href="#migration-guide" class="hash-link" aria-label="Direct link to Migration guide" title="Direct link to Migration guide">​</a></h2>
<p>The <a href="/docs/getting-started/migration_v4">migration guide</a> contains steps to upgrade your Centrifugo from version 3 to version 4. While there are many changes in the v4 release, it should be possible to migrate to Centrifugo v4 without changing the code on the client side at all. And then, after updating the server, gradually update the client-side to the latest version of the stack.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p><img decoding="async" loading="lazy" src="/assets/images/bg_cat-4454fbaae0446c3b1964e06821dd378b.jpg" width="2000" height="1068" class="img_ev3q"></p>
<p>To sum it up, here are some benefits of Centrifugo v4:</p>
<ul>
<li>unified experience thoughout application frontend environments</li>
<li>an optimized protocol which is generally faster, more compact and human-readable in JSON case, provides more resilient behavior for subscriptions</li>
<li>revised channel namespace security model, more granular permission control</li>
<li>more efficient and flexible use of subscription tokens</li>
<li>better initial latency – thanks to optimistic subscriptions and the ability to pre-create subscription tokens (as the <code>client</code> claim not needed anymore)</li>
<li>the ability to use more efficient WebSocket bidirectional emulation in the browser without having to worry about sticky sessions, unless you want to optimize the real-time infrastructure</li>
</ul>
<p>That&#x27;s it. We now begin the era of v4 and it is going to be awesome, no doubt.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="join-community">Join community<a href="#join-community" class="hash-link" aria-label="Direct link to Join community" title="Direct link to Join community">​</a></h2>
<p>The release contains many changes that strongly affect developing with Centrifugo. And of course you may have some questions or issues regarding new or changed concepts. Join our communities in Telegram (the most active) and Discord:</p>
<p><a href="https://t.me/joinchat/ABFVWBE0AhkyyhREoaboXQ" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://img.shields.io/badge/Telegram-Group-orange?style=flat&amp;logo=telegram" alt="Join the chat at https://t.me/joinchat/ABFVWBE0AhkyyhREoaboXQ" class="img_ev3q"></a>  <a href="https://discord.gg/tYgADKx" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" src="https://img.shields.io/discord/719186998686122046?style=flat&amp;label=Discord&amp;logo=discord" alt="Join the chat at https://discord.gg/tYgADKx" class="img_ev3q"></a></p>
<p>Enjoy Centrifugo v4, and let the Centrifugal force be with you.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="special-thanks">Special thanks<a href="#special-thanks" class="hash-link" aria-label="Direct link to Special thanks" title="Direct link to Special thanks">​</a></h2>
<p>The refactoring of client SDKs and introducing unified behavior based on the common spec was the hardest part of Centrifugo v4 release. Many thanks to <a href="https://github.com/puzrin" target="_blank" rel="noopener noreferrer">Vitaly Puzrin</a> (who is the author of several popular open-source libraries such as <a href="https://github.com/markdown-it/markdown-it" target="_blank" rel="noopener noreferrer">markdown-it</a>, <a href="https://github.com/fontello/fontello" target="_blank" rel="noopener noreferrer">fontello</a>, and others). We had a series of super productive sessions with him on client SDK API design. Some great ideas emerged from these sessions and the result seems like a huge step forward for Centrifugal projects.</p>
<p>Also, thanks to <a href="https://github.com/silischev" target="_blank" rel="noopener noreferrer">Anton Silischev</a> who helped a lot with WebTransport prototypes earlier this year, so we could quickly adopt WebTransport for v4.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>As some of you know, Centrifugo server is built on top of the <a href="https://github.com/centrifugal/centrifuge" target="_blank" rel="noopener noreferrer">Centrifuge</a> library for Go. Most of the optimizations and improvements described here are now also part of Centrifuge library.</p><p>With its new unified SDK behavior and bidirectional emulation layer, it seems a solid alternative to Socket.IO in the Go language ecosystem.</p><p>In some cases, Centrifuge library can be a more flexible solution than Centrifugo, since Centrifugo (as a standalone server) dictates some mechanics and rules that must be followed. In the case of Centrifugo, the business logic must live on the application backend side, with Centrifuge library it can be kept closer to the real-time transport layer.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Attributions</div><div class="admonitionContent_BuS1"><p>This post used images from freepik.com: <a href="https://www.freepik.com/free-vector/abstract-background-consisting-colorful-arcs-illustration_14803794.htm#&amp;position=5&amp;from_view=author" target="_blank" rel="noopener noreferrer">background</a> by <a href="https://www.freepik.com/author/liuzishan" target="_blank" rel="noopener noreferrer">liuzishan</a>. Also <a href="https://www.freepik.com/free-vector/abstract-black-circles-layers-dark-background-paper-cut_17303270.htm" target="_blank" rel="noopener noreferrer">image</a> by <a href="https://www.freepik.com/author/kenshinstock" target="_blank" rel="noopener noreferrer">kenshinstock</a>.</p></div></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/centrifugo">centrifugo</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/release">release</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/centrifugal/centrifugal.dev/edit/main/blog/2022-07-19-centrifugo-v4-released.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2022/07/29/101-way-to-subscribe"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">101 ways to subscribe user on a personal channel in Centrifugo</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2021/12/14/laravel-multi-room-chat-tutorial"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Building a multi-room chat application with Laravel and Centrifugo</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#centrifugo-v3-flashbacks" class="table-of-contents__link toc-highlight">Centrifugo v3 flashbacks</a></li><li><a href="#unified-client-sdk-api" class="table-of-contents__link toc-highlight">Unified client SDK API</a></li><li><a href="#modern-websocket-emulation-in-javascript" class="table-of-contents__link toc-highlight">Modern WebSocket emulation in Javascript</a></li><li><a href="#no-layering-in-client-protocol" class="table-of-contents__link toc-highlight">No layering in client protocol</a></li><li><a href="#redesigned-ping-pong" class="table-of-contents__link toc-highlight">Redesigned PING-PONG</a></li><li><a href="#secure-by-default-channel-namespaces" class="table-of-contents__link toc-highlight">Secure by default channel namespaces</a></li><li><a href="#private-channel-concept-revised" class="table-of-contents__link toc-highlight">Private channel concept revised</a></li><li><a href="#optimistic-subscriptions" class="table-of-contents__link toc-highlight">Optimistic subscriptions</a></li><li><a href="#channel-capabilities" class="table-of-contents__link toc-highlight">Channel capabilities</a></li><li><a href="#better-connections-api" class="table-of-contents__link toc-highlight">Better connections API</a></li><li><a href="#javascript-client-moved-to-typescript" class="table-of-contents__link toc-highlight">Javascript client moved to TypeScript</a></li><li><a href="#experimenting-with-http3" class="table-of-contents__link toc-highlight">Experimenting with HTTP/3</a></li><li><a href="#experimenting-with-webtransport" class="table-of-contents__link toc-highlight">Experimenting with WebTransport</a></li><li><a href="#migration-guide" class="table-of-contents__link toc-highlight">Migration guide</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li><li><a href="#join-community" class="table-of-contents__link toc-highlight">Join community</a></li><li><a href="#special-thanks" class="table-of-contents__link toc-highlight">Special thanks</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contact us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hello@centrifugal.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Send e-mail</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/joinchat/U57MI8Lam9mhpuhd" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/tYgADKx" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/centrifugalabs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/attributions">Attributions</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Centrifugal Labs LTD</div></div></div></footer></div>
</body>
</html>