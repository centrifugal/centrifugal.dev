<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Performance optimizations of WebSocket compression in Go application | Centrifugo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://centrifugal.dev/blog/2024/08/19/optimizing-websocket-compression"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Performance optimizations of WebSocket compression in Go application | Centrifugo"><meta data-rh="true" name="description" content="In this post, we explore how WebSocket compression can optimize bandwidth costs. We also discuss strategies to minimize the CPU and memory overhead associated with the enabled WebSocket compression from the Go ecosystem perspective."><meta data-rh="true" property="og:description" content="In this post, we explore how WebSocket compression can optimize bandwidth costs. We also discuss strategies to minimize the CPU and memory overhead associated with the enabled WebSocket compression from the Go ecosystem perspective."><meta data-rh="true" property="og:image" content="https://centrifugal.dev/img/ws_compression_cover.jpg"><meta data-rh="true" name="twitter:image" content="https://centrifugal.dev/img/ws_compression_cover.jpg"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-08-19T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="centrifugo,centrifuge,websocket,compression,performance"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://centrifugal.dev/blog/2024/08/19/optimizing-websocket-compression"><link data-rh="true" rel="alternate" href="https://centrifugal.dev/blog/2024/08/19/optimizing-websocket-compression" hreflang="en"><link data-rh="true" rel="alternate" href="https://centrifugal.dev/blog/2024/08/19/optimizing-websocket-compression" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EPXZ1LXJ33-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://centrifugal.dev/blog/2024/08/19/optimizing-websocket-compression","mainEntityOfPage":"https://centrifugal.dev/blog/2024/08/19/optimizing-websocket-compression","url":"https://centrifugal.dev/blog/2024/08/19/optimizing-websocket-compression","headline":"Performance optimizations of WebSocket compression in Go application","name":"Performance optimizations of WebSocket compression in Go application","description":"In this post, we explore how WebSocket compression can optimize bandwidth costs. We also discuss strategies to minimize the CPU and memory overhead associated with the enabled WebSocket compression from the Go ecosystem perspective.","datePublished":"2024-08-19T00:00:00.000Z","author":{"@type":"Person","name":"Alexander Emelin","description":"Founder of Centrifugal Labs","image":"/img/alexander_emelin.jpeg"},"image":{"@type":"ImageObject","@id":"https://centrifugal.dev/img/ws_compression_cover.jpg","url":"https://centrifugal.dev/img/ws_compression_cover.jpg","contentUrl":"https://centrifugal.dev/img/ws_compression_cover.jpg","caption":"title image for the blog post: Performance optimizations of WebSocket compression in Go application"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://centrifugal.dev/blog","name":"Centrifugal Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title=" RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title=" Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title=" JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NZRQD92LEX"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-NZRQD92LEX",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Centrifugo" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"><link rel="stylesheet" href="/assets/css/styles.a1af446f.css">
<script src="/assets/js/runtime~main.216cb218.js" defer="defer"></script>
<script src="/assets/js/main.dd41ea7a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Centrifugo</b></a><a class="navbar__item navbar__link" href="/docs/getting-started/introduction">Getting Started</a><a class="navbar__item navbar__link" href="/docs/tutorial/intro">Grand tutorial</a><a class="navbar__item navbar__link" href="/docs/server/configuration">Server guide</a><a class="navbar__item navbar__link" href="/docs/transports/overview">Real-time transports / SDK</a><a class="navbar__item navbar__link" href="/docs/pro/overview">Centrifugo PRO ♻️</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/centrifugal/centrifugo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/getting-started/introduction">v5</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/getting-started/introduction">v5</a></li><li><a class="dropdown__link" href="/docs/4/getting-started/introduction">v4</a></li><li><a class="dropdown__link" href="/docs/3/getting-started/introduction">v3</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1"><article><header><h1 class="title_f1Hy">Performance optimizations of WebSocket compression in Go application</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-08-19T00:00:00.000Z">August 19, 2024</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="/img/alexander_emelin.jpeg" alt="Alexander Emelin"><div class="avatar__intro"><div class="avatar__name"><span>Alexander Emelin</span></div><small class="avatar__subtitle">Founder of Centrifugal Labs</small></div></div></div></div></header><div id="__blog-post-container" class="markdown"><img src="/img/ws_compression_cover.jpg">
<p>In a recent blog post, we <a href="https://centrifugal.dev/blog/2024/05/30/real-time-data-compression-experiments" target="_blank" rel="noopener noreferrer">talked about the Delta Compression</a> feature of the Centrifuge/Centrifugo stack. We continue the topic of real-time data compression here, and in this post, we will show the optimizations for WebSocket compression made recently in collaboration with one of our Centrifugo PRO customers.</p>
<p>The optimizations described here allowed our customer to reduce the transmit bandwidth used for real-time communication by 3x by enabling WebSocket compression, while keeping server CPU and memory utilization at comparable levels. This eventually resulted in notable savings of up to $12,000 per month on their bandwidth bill.</p>
<p>The optimization is now part of our open-source <a href="https://github.com/centrifugal/centrifuge" target="_blank" rel="noopener noreferrer">centrifugal/centrifuge</a> library for the Go language and <a href="https://centrifugal.dev/docs/pro/overview" target="_blank" rel="noopener noreferrer">Centrifugo PRO</a> offering. However, the concepts described here can be applied not only to other Go projects but also beyond the Go ecosystem.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Thanks</div><div class="admonitionContent_BuS1"><p>Huge kudos to the Skin.Club engineering team (and Sergey in particular) for bringing us the case, evaluating the changes, providing graphs from production, and reviewing this post.</p></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="enabling-websocket-compression">Enabling WebSocket compression<a href="#enabling-websocket-compression" class="hash-link" aria-label="Direct link to Enabling WebSocket compression" title="Direct link to Enabling WebSocket compression">​</a></h2>
<p>WebSocket compression allows reducing the size of messages exchanged between a client and server over a WebSocket connection. Nowadays, it&#x27;s achieved using the <code>permessage-deflate</code> algorithm (see <a href="https://datatracker.ietf.org/doc/html/rfc7692" target="_blank" rel="noopener noreferrer">RFC 7692</a>), which compresses the data before transmission. By reducing the data size, WebSocket compression helps optimize bandwidth usage and may actually lower latency due to the reduced data size over the wire.</p>
<p><a href="https://github.com/centrifugal/centrifuge" target="_blank" rel="noopener noreferrer">Centrifuge library</a> (the core of Centrifugo server) uses <a href="https://github.com/gorilla/websocket" target="_blank" rel="noopener noreferrer">Gorilla WebSocket</a> library for its WebSocket transport implementation (actually, we have our own fork with minor modifications, but the core is the same). Gorilla WebSocket supports WebSocket compression by using a Go standard&#x27;s library <a href="https://pkg.go.dev/compress/flate" target="_blank" rel="noopener noreferrer">compress/flate</a> package. Enabling compression on server side can be done by setting an <code>EnableCompression</code> option of the <a href="https://pkg.go.dev/github.com/gorilla/websocket#Upgrader" target="_blank" rel="noopener noreferrer">websocket.Upgrader</a>:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> upgrader </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> websocket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Upgrader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    EnableCompression</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then it&#x27;s possible to control whether or not to use compression for a message by using <code>EnableWriteCompression</code> method before you are writing data to the specific connection:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">EnableWriteCompression</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Write data.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When paying for bandwidth, minimizing its usage can result in substantial cost savings, even if it leads to higher CPU and memory consumption on the server side. This is why our customer chose to enable WebSocket compression to evaluate its impact on their metrics:</p>
<img src="/img/ws_compression_enabling.jpg">
<p>Sorry for the image quality; at that point, we did not know that the case would eventually lead to a blog post. However, what is important to emphasize from these graphs is that when WebSocket compression was enabled:</p>
<ul>
<li>The graphs show a significant reduction in transmit bandwidth on nodes, from 7.5 to 2.5 MiB/s at peak times (or in sum across all nodes from 45 to 15 MiB/s).</li>
<li>We observe a notable (approximately 2x) increase in CPU usage.</li>
<li>We see how memory usage was affected in a bad way – instead of being super-stable we now observe sporadic spikes, up to 2.5x larger values.</li>
</ul>
<p>Despite the negative change of CPU and memory utilization, migrating to WebSocket compression was still economically beneficial for our customer. As mentioned earlier, this step alone allowed the company to save up to $12,000 per month on bandwidth costs, while the additional resource usage costs were comparably much lower.</p>
<p>Fortunately, at Centrifugal Labs, we had <a href="https://github.com/gorilla/websocket/issues/203" target="_blank" rel="noopener noreferrer">prior experience</a> with WebSocket compression performance overhead. This allowed us to suggest some optimizations to mitigate the resource usage degradation. To understand these optimizations, we first need to explore how WebSocket compression works under the hood.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="permessage-deflate-in-gorillawebsocket">Permessage-deflate in gorilla/websocket<a href="#permessage-deflate-in-gorillawebsocket" class="hash-link" aria-label="Direct link to Permessage-deflate in gorilla/websocket" title="Direct link to Permessage-deflate in gorilla/websocket">​</a></h2>
<p>In Go, when you need to compress the WebSocket frame your starting point is <a href="https://pkg.go.dev/compress/flate" target="_blank" rel="noopener noreferrer">compress/flate</a> package from Go standard library. That&#x27;s what Gorilla WebSocket uses to implement <code>permessage-deflate</code> compression. You can find the implementation in <a href="https://github.com/gorilla/websocket/blob/3810b2346f49a47aa0b99c23a7aa619d5f5dcf80/compression.go" target="_blank" rel="noopener noreferrer">compression.go</a> file.</p>
<p>When compressing frames the user may choose one of the <a href="https://pkg.go.dev/compress/flate#pkg-constants" target="_blank" rel="noopener noreferrer">predefined levels of compression</a> - from 1 (BestSpeed) to 9 (BestCompression).</p>
<p>One of the important compression implementation details is that Gorilla WebSocket uses <code>sync.Pool</code> for <code>flate.Writer</code> (separate pool for each level of compression) and <code>flate.Reader</code> types:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    flateWriterPools </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">maxCompressionLevel </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> minCompressionLevel </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">sync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Pool</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    flateReaderPool  </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> sync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">New</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">interface</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> flate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">NewReader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Having a pool for these objects allows Gorilla WebSocket to reuse existing readers/writers and generally avoid additional allocations. The benefit of having a pool for <code>flate.Writer</code> is enormous, especially when considering how large this type is:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;unsafe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;compress/flate&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> w flate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Writer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">println</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">unsafe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Sizeof</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Output: 656640</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So it&#x27;s around 650 KB on its own! For <code>flate.Reader</code> it&#x27;s not that critical as it&#x27;s only 16B overhead. Having pools makes a lot of sense and helps Gorilla WebSocket to perform well when compressing data.</p>
<p>Thus when you call <a href="https://pkg.go.dev/github.com/gorilla/websocket#Conn.WriteMessage" target="_blank" rel="noopener noreferrer">Conn.WriteMessage</a> or use <a href="https://pkg.go.dev/github.com/gorilla/websocket#Conn.NextWriter" target="_blank" rel="noopener noreferrer">Conn.NextWriter</a> API for connections with compression negotiated under the hood Gorilla Websocket library acquires <code>flate.Writer</code> from the proper pool for the time of write operation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>No context takeover</div><div class="admonitionContent_BuS1"><p>Gorilla WebSocket implements <code>permessage-deflate</code> <a href="https://datatracker.ietf.org/doc/html/rfc7692#section-7.1.1.1" target="_blank" rel="noopener noreferrer">without context takeover</a> only. Implementing a context takeover would mean attaching a <code>flate.Writer</code> to each connection – which is very memory inefficient as we can see. Though it can be still a viable money-effective bandwidth optimization for WebSocket – especially if the app does not have a lot of concurrent connections.</p></div></div>
<p>But below we will describe a scenario in which having just a <code>sync.Pool</code> is not enough to avoid extra allocations.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="preparedmessage-type">PreparedMessage type<a href="#preparedmessage-type" class="hash-link" aria-label="Direct link to PreparedMessage type" title="Direct link to PreparedMessage type">​</a></h2>
<p>Let’s delve into the specifics of Centrifuge/Centrifugo. Both the Centrifuge library and the Centrifugo server implement the PUB/SUB pattern for real-time messaging. Clients can establish a WebSocket connection and subscribe to multiple channels, all multiplexed over a single connection. A single channel can have many online subscribers — often thousands. Our APIs enable publishing a message to a channel, ensuring it is delivered to all online subscribers of that channel. Here’s a simple illustration of the PUB/SUB pattern:</p>
<p><img decoding="async" loading="lazy" alt="pub_sub" src="/assets/images/pub_sub-5477abf6fb38219fc0848d9c9c3dc2b1.png" width="2924" height="1231" class="img_ev3q"></p>
<p>When you publish a message to a channel, our WebSocket server puts the message into each subscribed client&#x27;s individual queue. Client queues are processed concurrently in separate goroutines, and messages are eventually sent to the client over the transport implementation. WebSocket is the most frequently used transport implementation in our case.</p>
<p>With WebSocket compression enabled, broadcasts to a channel with many online subscribers result in many compression operations that compress the same message concurrently. This, in turn, results in a load on <code>sync.Pool</code>, which grows significantly at the point of such a broadcast. Given the size of each <code>flate.Writer</code> object, this is exactly what causes the temporary memory spikes we observed on the graphs above. More allocations also mean more CPU utilization.</p>
<p>In your app, you may observe something like this in the heap profile:</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/ws_compression_profile-bf2e06a8ae8136796695c14f133d8e8f.jpg" width="2186" height="1252" class="img_ev3q"></p>
<p>That&#x27;s why, at some point in the past, Gary Burd (author of Gorilla WebSocket) <a href="https://github.com/gorilla/websocket/pull/211" target="_blank" rel="noopener noreferrer">added</a> a <a href="https://pkg.go.dev/github.com/gorilla/websocket#PreparedMessage" target="_blank" rel="noopener noreferrer">PreparedMessage</a> type. This is a helper type that allows caching the constructed WebSocket frame depending on various negotiated connection options (compression used or not, compression level).</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockTitle_Ktv7">How PreparedMessage is defined</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// PreparedMessage caches on the wire representations of a message payload.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Use PreparedMessage to efficiently send a message payload to multiple</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// connections. PreparedMessage is especially useful when compression is used</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// because the CPU and memory expensive compression operation can be executed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// once for a given set of compression options.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> PreparedMessage </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    messageType </span><span class="token builtin" style="color:rgb(130, 170, 255)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    data        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token builtin" style="color:rgb(130, 170, 255)">byte</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    mu          sync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Mutex</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    frames      </span><span class="token keyword" style="font-style:italic">map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">prepareKey</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">preparedFrame</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// prepareKey defines a unique set of options to cache prepared frames in PreparedMessage.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> prepareKey </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    isServer         </span><span class="token builtin" style="color:rgb(130, 170, 255)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    compress         </span><span class="token builtin" style="color:rgb(130, 170, 255)">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    compressionLevel </span><span class="token builtin" style="color:rgb(130, 170, 255)">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// preparedFrame contains data in wire representation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> preparedFrame </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    once sync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Once</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    data </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token builtin" style="color:rgb(130, 170, 255)">byte</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then there is a method <a href="https://pkg.go.dev/github.com/gorilla/websocket#Conn.WritePreparedMessage" target="_blank" rel="noopener noreferrer">func (*Conn) WritePreparedMessage</a>, which should be used to write data to all connections interested in a message — the proper WebSocket frame will be created once and then automatically re-used. By the way, this is an example of the <a href="https://github.com/gorilla/websocket/blob/ce903f6d1d961af3a8602f2842c8b1c3fca58c4d/prepared.go#L72" target="_blank" rel="noopener noreferrer">elegant use</a> of <code>sync.Once</code>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockTitle_Ktv7">Using PreparedMessage</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">preparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">_</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> websocket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">NewPreparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">websocket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">TextMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token boolean" style="color:rgb(255, 88, 116)">_</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">WritePreparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">preparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This means that if we broadcast the same prepared message to many connections, we remove the excessive load on <code>sync.Pool</code>, just taking a one <code>flate.Writer</code> from the pool instead of many. This way, we avoid large memory spikes due to big size of <code>flate.Writer</code> objects and <code>sync.Pool</code> growth.</p>
<p>For broadcasts, <code>PreparedMessage</code> approach significantly reduces CPU usage by minimizing the need to construct and compress WebSocket frames, especially as the number of concurrent subscribers increases. Additionally, it reduces the allocation of large <code>flate.Writer</code> objects, further optimizing CPU utilization.</p>
<p>Gorilla WebSocket contains <a href="https://github.com/gorilla/websocket/blob/3810b2346f49a47aa0b99c23a7aa619d5f5dcf80/conn_broadcast_test.go" target="_blank" rel="noopener noreferrer">benchmarks</a> which compare message broadcast to many connections with enabled compression without and with <code>PreparedMessage</code> usage. Let&#x27;s run them:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">❯ </span><span class="token keyword" style="font-style:italic">go</span><span class="token plain"> test </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">run xxx </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">bench BenchmarkBroadcast </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain">benchmem</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Compression_100_conn</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">             </span><span class="token number" style="color:rgb(247, 140, 108)">198619</span><span class="token plain"> ns</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	   </span><span class="token number" style="color:rgb(247, 140, 108)">14113</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	    </span><span class="token number" style="color:rgb(247, 140, 108)">301</span><span class="token plain"> allocs</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CompressionPrepared_100_conn</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">      </span><span class="token number" style="color:rgb(247, 140, 108)">42643</span><span class="token plain"> ns</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	   </span><span class="token number" style="color:rgb(247, 140, 108)">12320</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	     </span><span class="token number" style="color:rgb(247, 140, 108)">19</span><span class="token plain"> allocs</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Compression_1000_conn</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">           </span><span class="token number" style="color:rgb(247, 140, 108)">1797432</span><span class="token plain"> ns</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	  </span><span class="token number" style="color:rgb(247, 140, 108)">123864</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	   </span><span class="token number" style="color:rgb(247, 140, 108)">3001</span><span class="token plain"> allocs</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CompressionPrepared_1000_conn</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">    </span><span class="token number" style="color:rgb(247, 140, 108)">649506</span><span class="token plain"> ns</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	   </span><span class="token number" style="color:rgb(247, 140, 108)">11421</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	     </span><span class="token number" style="color:rgb(247, 140, 108)">19</span><span class="token plain"> allocs</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Compression_10000_conn</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">         </span><span class="token number" style="color:rgb(247, 140, 108)">16506132</span><span class="token plain"> ns</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	 </span><span class="token number" style="color:rgb(247, 140, 108)">1040709</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	  </span><span class="token number" style="color:rgb(247, 140, 108)">30007</span><span class="token plain"> allocs</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CompressionPrepared_10000_conn</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">7702265</span><span class="token plain"> ns</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	   </span><span class="token number" style="color:rgb(247, 140, 108)">11631</span><span class="token plain"> B</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op	     </span><span class="token number" style="color:rgb(247, 140, 108)">21</span><span class="token plain"> allocs</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain">op</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Benchmarks demonstrate that <code>PreparedMessage</code> significantly reduces memory allocations during broadcasts, with the impact becoming more significant as the number of connections increases.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="preparedmessage-cache">PreparedMessage cache<a href="#preparedmessage-cache" class="hash-link" aria-label="Direct link to PreparedMessage cache" title="Direct link to PreparedMessage cache">​</a></h2>
<p>For Centrifuge/Centrifugo though, we couldn&#x27;t directly use <code>PreparedMessage</code> in the part of the code responsible for preparing messages for channel broadcasts. This is because doing so would introduce a dependency on a WebSocket-specific type in a layer of code that should remain agnostic to the underlying real-time transport.</p>
<p>To avoid this, we chose not to rely on the <code>PreparedMessage</code> type in the broadcasting preparation layer. Instead, we implemented a cache of <code>PreparedMessage</code> types within the WebSocket transport implementation layer.</p>
<p>We use the data to be sent to the WebSocket connection as a cache key, and the <code>PreparedMessage</code> object as a value. The WebSocket transport implementation checks the cache before constructing <code>PreparedMessage</code> and has a high chance of finding it. The TTL (time-to-live) of each cache entry can be kept very short (something like 1 second should be sufficient). The size of the cache should be comparable to the total size of all different messages being broadcasted concurrently. For most WebSocket applications, a cache size of several megabytes should be more than enough.</p>
<p>We used <a href="https://github.com/maypok86/otter" target="_blank" rel="noopener noreferrer">maypok86/otter</a> cache for our implementation, but there are a lot of other options in Go ecosystem.</p>
<p>Here is how we initialize the cache:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">otter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">MustBuilder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">websocket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">PreparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">CompressionPreparedMessageCacheSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">Cost</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">key </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> value </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">websocket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">PreparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">uint32</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">uint32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">len</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">WithTTL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">Build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And use it at the point where we want to write data to the WebSocket connection on a transport layer:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> usePreparedMessage </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    key </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> convert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">BytesToString</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    preparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> ok </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">preparedCache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> err </span><span class="token builtin" style="color:rgb(130, 170, 255)">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        preparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> websocket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">NewPreparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">messageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">preparedCache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> preparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    err </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">WritePreparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">preparedMessage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You may wonder why the cache at this level can make a difference compared to simply using <code>conn.WriteMessage</code>. At first glance, the probability of finding a <code>PreparedMessage</code> in the cache during a concurrent broadcast seems similar to getting a <code>flate.Writer</code> from the <code>sync.Pool</code> for reuse. However, that&#x27;s not entirely true, because the <code>WriteMessage</code> method of Gorilla WebSocket acquires a <code>flate.Writer</code> for the duration of the write operation, which involves a syscall and generally takes much more time than our cache operations. Additionally, two subsequent writes that reuse the <code>flate.Writer</code> will construct the frame from scratch, whereas a cached <code>PreparedMessage</code> allows us to avoid this.</p>
<p>It&#x27;s important to note that the fact we use a cache is actually a Centrifuge-specific detail to avoid dependency on a type from the WebSocket library in places where we don&#x27;t want to be tied to specific transport implementations. In your WebSocket app that uses Gorilla WebSocket, you can likely create a <code>PreparedMessage</code> directly and use it when iterating over connections to which you need to broadcast the message. This approach might even lead to more predictable behavior than what we have in the Centrifuge case with a cache. While the cache approach is somewhat probabilistic, the probability is high, and as we&#x27;ll see below, it works well.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mentioning-klauspostcompress">Mentioning klauspost/compress<a href="#mentioning-klauspostcompress" class="hash-link" aria-label="Direct link to Mentioning klauspost/compress" title="Direct link to Mentioning klauspost/compress">​</a></h2>
<p>Since we are discussing compression optimizations in the Go ecosystem, it would be wrong not to mention the <a href="https://github.com/klauspost/compress" target="_blank" rel="noopener noreferrer">klauspost/compress</a> library created by Klaus Post. The library is backwards compatible with standard Go packages but provides faster implementations of compression algorithms. Additionally, it offers capabilities beyond those of the standard library.</p>
<p>Specifically, it provides <a href="https://github.com/klauspost/compress?tab=readme-ov-file#stateless-compression" target="_blank" rel="noopener noreferrer">Stateless Compression</a>, which theoretically could help with the use case we described here.</p>
<p>However, in our initial evaluations of <a href="https://github.com/klauspost/compress" target="_blank" rel="noopener noreferrer">klauspost/compress</a> (switching to its <code>flate</code> implementation and also trying the Stateless Compression feature), we did not observe notable improvements in our specific set of benchmarks (and actually observed regressions in some cases). So, for now, we are sticking with the standard Go library. Nevertheless, it&#x27;s still a promising direction for research, and we may re-evaluate our findings in the future. Since we use our own fork of Gorilla WebSocket, we can easily switch to <a href="https://github.com/klauspost/compress" target="_blank" rel="noopener noreferrer">klauspost/compress</a> if we prove the benefit.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="results">Results<a href="#results" class="hash-link" aria-label="Direct link to Results" title="Direct link to Results">​</a></h2>
<p>Alright, it&#x27;s time to see how enabling <code>PreparedMessage</code> cache helped the customer with a resource usage.</p>
<p>First, let&#x27;s look at CPU after enabling the cache in production:</p>
<img src="/img/ws_compression_results_cpu.png">
<p>We see that the average CPU utilization is significantly reduced at peak times, closer to values before enabling the WebSocket compression.</p>
<p>Second, let&#x27;s look at memory usage:</p>
<img src="/img/ws_compression_results_mem.png">
<p>As we can see on the graph – the pattern smoothed a lot making the usage on each Centrifugo node much more stable. It&#x27;s still not the same as it was with compression disabled, we can see minor spikes – but the positive effect of <code>PreparedMessage</code> cache is clear.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Enabling WebSocket compression helped our customer significantly reduce monthly costs, and with PreparedMessage cache optimization, we were able to keep resource usage at a comparable level. So, it was mostly a no-brainer improvement.</p>
<p>If you are a Go developer, our open-source <a href="https://github.com/centrifugal/centrifuge" target="_blank" rel="noopener noreferrer">centrifugal/centrifuge</a> library for Go supports WebSocket compression and contains the cache described here — so if you build your app on top of Centrifuge, you just need to enable a couple of options to benefit from it:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">websocketConfig </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> centrifuge</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">WebsocketConfig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Compression</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CompressionPreparedMessageCacheSize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1048576</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// 1 MB. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we talk about Go, the technique with prepared message is also applicable to other WebSocket libraries, not just Gorilla WebSocket. For example, with <a href="https://github.com/gobwas/ws" target="_blank" rel="noopener noreferrer">gobwas/ws</a>, it seems possible to construct a prepared compressed WebSocket frame, though it involves slightly more work than with Gorilla WebSocket, which provides a handy <code>PreparedMessage</code> type for this and abstracts the complexity of frame building (based on the set of connection-negotiated options).</p>
<p>That&#x27;s it for today. In some cases, when working with WebSocket broadcasts, the bandwidth may be reduced even more — check out our post about <a href="https://centrifugal.dev/blog/2024/05/30/real-time-data-compression-experiments" target="_blank" rel="noopener noreferrer">Delta Compression</a>.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/centrifugo">centrifugo</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/centrifuge">centrifuge</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/websocket">websocket</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/compression">compression</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/performance">performance</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/centrifugal/centrifugal.dev/edit/main/blog/2024-08-19-optimizing-websocket-compression.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2024/06/03/real-time-document-state-sync"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Proper real-time document state synchronization within Centrifugal ecosystem</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#enabling-websocket-compression" class="table-of-contents__link toc-highlight">Enabling WebSocket compression</a></li><li><a href="#permessage-deflate-in-gorillawebsocket" class="table-of-contents__link toc-highlight">Permessage-deflate in gorilla/websocket</a></li><li><a href="#preparedmessage-type" class="table-of-contents__link toc-highlight">PreparedMessage type</a></li><li><a href="#preparedmessage-cache" class="table-of-contents__link toc-highlight">PreparedMessage cache</a></li><li><a href="#mentioning-klauspostcompress" class="table-of-contents__link toc-highlight">Mentioning klauspost/compress</a></li><li><a href="#results" class="table-of-contents__link toc-highlight">Results</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contact us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hello@centrifugal.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Send e-mail</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/joinchat/U57MI8Lam9mhpuhd" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/tYgADKx" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/centrifugalabs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/attributions">Attributions</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Centrifugal Labs LTD</div></div></div></footer></div>
</body>
</html>