<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-4 docs-doc-page docs-doc-id-server/infra_tuning" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Infrastructure tuning | Centrifugo</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://centrifugal.dev/img/centrifugo_soc.png"><meta data-rh="true" name="twitter:image" content="https://centrifugal.dev/img/centrifugo_soc.png"><meta data-rh="true" property="og:url" content="https://centrifugal.dev/docs/4/server/infra_tuning"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="4"><meta data-rh="true" name="docusaurus_tag" content="docs-default-4"><meta data-rh="true" name="docsearch:version" content="4"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-4"><meta data-rh="true" property="og:title" content="Infrastructure tuning | Centrifugo"><meta data-rh="true" name="description" content="As Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it."><meta data-rh="true" property="og:description" content="As Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://centrifugal.dev/docs/4/server/infra_tuning"><link data-rh="true" rel="alternate" href="https://centrifugal.dev/docs/4/server/infra_tuning" hreflang="en"><link data-rh="true" rel="alternate" href="https://centrifugal.dev/docs/4/server/infra_tuning" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://EPXZ1LXJ33-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title=" RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title=" Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title=" JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NZRQD92LEX"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-NZRQD92LEX",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Centrifugo" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"><link rel="stylesheet" href="/assets/css/styles.7be125cd.css">
<script src="/assets/js/runtime~main.50406303.js" defer="defer"></script>
<script src="/assets/js/main.51f9d053.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Centrifugo</b></a><a class="navbar__item navbar__link" href="/docs/4/getting-started/introduction">Getting Started</a><a class="navbar__item navbar__link" href="/docs/tutorial/intro">Grand tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/4/server/configuration">Server guide</a><a class="navbar__item navbar__link" href="/docs/4/transports/overview">Real-time transports / SDK</a><a class="navbar__item navbar__link" href="/docs/4/faq">FAQ</a><a class="navbar__item navbar__link" href="/docs/4/pro/overview">Centrifugo PRO</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/centrifugal/centrifugo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/4/getting-started/introduction">v4</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/server/infra_tuning">v5</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/4/server/infra_tuning">v4</a></li><li><a class="dropdown__link" href="/docs/3/server/infra_tuning">v3</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b>Centrifugo</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/configuration">Configure Centrifugo</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/server_api">Server API walkthrough</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/authentication">Client JWT authentication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/channels">Channels and namespaces</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/channel_permissions">Channel permission model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/channel_token_auth">Channel JWT authorization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/server_subs">Server-side subscriptions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/engines">Engines and scalability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/proxy">Proxy events to the backend</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/history_and_recovery">History and recovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/presence">Online presence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/admin_web">Admin web UI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/monitoring">Metrics monitoring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/4/server/infra_tuning">Infrastructure tuning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/load_balancing">Load balancing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/tls">Configure TLS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/codes">Error and disconnect codes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/4/server/console_commands">Helper CLI commands</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Centrifugo<!-- --> <b>v4</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/server/infra_tuning">latest version</a></b> (<!-- -->v5<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Infrastructure tuning</h1></header><p>As Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="open-files-limit">Open files limit<a href="#open-files-limit" class="hash-link" aria-label="Direct link to Open files limit" title="Direct link to Open files limit">​</a></h3>
<p>You should increase a max number of open files Centrifugo process can open if you want to handle more connections.</p>
<p>To get the current open files limit run:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ulimit -n</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On Linux you can check limits for a running process using:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cat /proc/&lt;PID&gt;/limits</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The open file limit shows approximately how many clients your server can handle. Each connection consumes one file descriptor. On most operating systems this limit is 128-256 by default.</p>
<p>See <a href="https://docs.riak.com/riak/kv/2.2.3/using/performance/open-files-limit.1.html" target="_blank" rel="noopener noreferrer">this document</a> to get more info on how to increase this number.</p>
<p>If you install Centrifugo using RPM from repo then it automatically sets max open files limit to 65536.</p>
<p>You may also need to increase max open files for Nginx (or any other proxy before Centrifugo).</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ephemeral-port-exhaustion">Ephemeral port exhaustion<a href="#ephemeral-port-exhaustion" class="hash-link" aria-label="Direct link to Ephemeral port exhaustion" title="Direct link to Ephemeral port exhaustion">​</a></h3>
<p>Ephemeral ports exhaustion problem can happen between your load balancer and Centrifugo server. If your clients connect directly to Centrifugo without any load balancer or reverse proxy software between then you are most likely won&#x27;t have this problem. But load balancing is a very common thing.</p>
<p>The problem arises due to the fact that each TCP connection uniquely identified in the OS by the 4-part-tuple:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">source ip | source port | destination ip | destination port</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On load balancer/server boundary you are limited in 65536 possible variants by default. Actually due to some OS limits not all 65536 ports are available for usage (usually about 15k ports available by default).</p>
<p>In order to eliminate a problem you can:</p>
<ul>
<li>Increase the ephemeral port range by tuning <code>ip_local_port_range</code> option</li>
<li>Deploy more Centrifugo server instances to load balance across</li>
<li>Deploy more load balancer instances</li>
<li>Use virtual network interfaces</li>
</ul>
<p>See <a href="https://making.pusher.com/ephemeral-port-exhaustion-and-how-to-avoid-it/" target="_blank" rel="noopener noreferrer">a post in Pusher blog</a> about this problem and more detailed solution steps.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sockets-in-time_wait-state">Sockets in TIME_WAIT state<a href="#sockets-in-time_wait-state" class="hash-link" aria-label="Direct link to Sockets in TIME_WAIT state" title="Direct link to Sockets in TIME_WAIT state">​</a></h3>
<p>On load balancer/server boundary one more problem can arise: sockets in TIME_WAIT state.</p>
<p>Under load when lots of connections and disconnections happen socket descriptors can stay in TIME_WAIT state. Those descriptors can not be reused for a while. So you can get various
errors when using Centrifugo. For example something like <code>(99: Cannot assign requested address) while connecting to upstream</code> in Nginx error log and 502 on client side.</p>
<p>Look how many socket descriptors in TIME_WAIT state.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">netstat -an |grep TIME_WAIT | grep &lt;CENTRIFUGO_PID&gt; | wc -l</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nice article about TIME_WAIT sockets: <a href="http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html" target="_blank" rel="noopener noreferrer">http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html</a></p>
<p>The advices here are similar to ephemeral port exhaustion problem:</p>
<ul>
<li>Increase the ephemeral port range by tuning <code>ip_local_port_range</code> option</li>
<li>Deploy more Centrifugo server instances to load balance across</li>
<li>Deploy more load balancer instances</li>
<li>Use virtual network interfaces</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="proxy-max-connections">Proxy max connections<a href="#proxy-max-connections" class="hash-link" aria-label="Direct link to Proxy max connections" title="Direct link to Proxy max connections">​</a></h3>
<p>Proxies like Nginx and Envoy have default limits on maximum number of connections which can be established.</p>
<p>Make sure you have a reasonable limit for max number of incoming and outgoing connections in your proxy configuration.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="conntrack-table">Conntrack table<a href="#conntrack-table" class="hash-link" aria-label="Direct link to Conntrack table" title="Direct link to Conntrack table">​</a></h3>
<p>More rare (since default limit is usually sufficient) your possible number of connections can be limited by conntrack table. Netfilter framework which is part of iptables keeps information about all connections and has limited size for this information. See how to see its limits and instructions to increase <a href="https://morganwu277.github.io/2018/05/26/Solve-production-issue-of-nf-conntrack-table-full-dropping-packet/" target="_blank" rel="noopener noreferrer">in this article</a>.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="additional-server-protection">Additional server protection<a href="#additional-server-protection" class="hash-link" aria-label="Direct link to Additional server protection" title="Direct link to Additional server protection">​</a></h3>
<p>You should also consider adding additional protection to your Centrifugo endpoints. Centrifugo itself provides several options (described in <a href="/docs/4/server/configuration">configuration</a> section) regarding server protection from the malicious behavior. Though an additional layer of DDOS protection on network or infrastructure level is highly recommended. For example, you may want to limit the number of connections coming from particular IP address.</p>
<p>Here we list some possible ways you can use to protect your Centrifugo installation:</p>
<ul>
<li>Adding Nginx <a href="https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone" target="_blank" rel="noopener noreferrer">limit_conn_zone</a> configuration</li>
<li>Using <a href="https://www.haproxy.com/blog/introduction-to-haproxy-stick-tables/" target="_blank" rel="noopener noreferrer">stick tables</a> of Haproxy</li>
<li>Configuring <a href="https://developers.cloudflare.com/waf/rate-limiting-rules/" target="_blank" rel="noopener noreferrer">rate limiting rules</a> with Cloudflare</li>
</ul>
<p>The list is not exhaustive of course.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/centrifugal/centrifugal.dev/edit/main/versioned_docs/version-4/server/infra_tuning.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/4/server/monitoring"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Metrics monitoring</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/4/server/load_balancing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Load balancing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#open-files-limit" class="table-of-contents__link toc-highlight">Open files limit</a></li><li><a href="#ephemeral-port-exhaustion" class="table-of-contents__link toc-highlight">Ephemeral port exhaustion</a></li><li><a href="#sockets-in-time_wait-state" class="table-of-contents__link toc-highlight">Sockets in TIME_WAIT state</a></li><li><a href="#proxy-max-connections" class="table-of-contents__link toc-highlight">Proxy max connections</a></li><li><a href="#conntrack-table" class="table-of-contents__link toc-highlight">Conntrack table</a></li><li><a href="#additional-server-protection" class="table-of-contents__link toc-highlight">Additional server protection</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contact us</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hello@centrifugal.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Send e-mail</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://t.me/joinchat/U57MI8Lam9mhpuhd" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/tYgADKx" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/centrifugal_dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/attributions">Attributions</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Centrifugal Labs LTD</div></div></div></footer></div>
</body>
</html>